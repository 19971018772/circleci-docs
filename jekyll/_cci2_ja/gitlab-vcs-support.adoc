---

version:
- クラウド
---
= GitLab サポートプレビューに関するドキュメント
:page-layout: classic-docs
:page-liquid:
:page-description: GitHub と CircleCI の連携方法について説明します。
:icons: font
:toc: macro

:toc-title:

== 概要

[IMPORTANT]
====
GitLab バージョン管理システム (VSC) サポート (プレビュー) にようこそ。

弊社では、このサポートの改善を継続的に繰り返し行なっています。 パフォーマンスの問題やエラーが発生したり、予期せぬ変更が加えられる可能性があるのでご注意ください。

**現時点では、CircleCI での本番環境の重要な作業に GitLab VCS サポートを使用することはお勧めしません。**

シームレスで安定したエクスペリエンスの提供に向け、皆様にプレビュープロセスにご参加いただき、ご協力いたければ幸いです。

https://ideas.circleci.com/gitlab-vcs-experience-feedback[フィードバックを送信する]
====

このドキュメントでは、GitLab プロジェクトを CircleCI と連携する方法を説明します。 CI/CD パイプラインを管理するための新しいコンセプトや方法も紹介します。 また、既知の問題や今後のリリース予定もお知らせします。

== 手順 1: 登録

GitLab サポート (プレビュー) は、新規および既存の CircleCI ユーザーにご利用いただけます。 新規および既存ユーザー用の下記の 2 つの手順説明をお読みください。

=== 新規 CircleCI ユーザー用: CircleCI アカウントを作成し、最初の組織を作成します。  

. **メールで登録** オプションを選択し、https://circleci.com/signup/[CircleCI に登録します] (パスワードも作成します)。 
. メールアドレスとパスワードを設定したら、GitLab、GitHub、または Bitbucket への接続オプション画面が表示されます。 GitLab との **接続** をクリックします。 
+
NOTE: GitLab への接続オプションが表示されない場合は、こちらの https://circleci.com/gitlab-vcs-support/[登録フォーム] にご記入ください。
+
NOTE: 新規アカウントと GitHub アカウントまたは Bitbucket アカウントとの接続を選択すると、アカウントはご使用の VCS のアカウント名に基づいてマージされます。
. 次のページに、"Welcome to the GitLab VCS Support Preview" というメッセージが表示されます。 新しい組織を作成するよう求められます。 組織名を入力して、**Create Organization** をクリックします。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-create-org.png[Create new organization]

新しい組織を作成したら、 Web アプリのダッシュボードが表示されます。 下記の <<#step-two-create-a-new-project,手順 2>> に記載されている手順に従い、新しいプロジェクトを作成します。

=== 既存の CircleCI ユーザー用: 新しい組織を作成します。

. https://app.circleci.com/[CircleCI Web アプリ] にログインします。
. 組織名をクリックし、画面左上で組織切り替えメニューを開きます。 **Create New Organization** を選択します。
. 次のページに、"Welcome to the GitLab VCS Support Preview" というメッセージが表示されます。 新しい組織の一意の名前を入力します。
+
NOTE: Welcome メッセージが表示されない場合、こちらの https://circleci.com/gitlab-vcs-support/[登録フォーム] にご記入ください。
. **Create Organization** をクリックします。

この新しい組織により、組織内のユーザーと GitLab プロジェクトを管理できます。 この組織は、まず <<plan-free#,**Free プラン**>> に置かれます。 後で他のプランにアップグレードできます。 この料金プランは、以前アカウントで設定した GitHub または Bitbucket 組織とは無関係です。

新しい組織を作成したら、 組織のダッシュボードが表示されます。 下記の <<#step-two-create-a-new-project,手順 2>> に記載されている手順に従って新しい GitLab プロジェクトを設定します。

NOTE: 既存の CircleCI ユーザーは、メールアドレスとパスワードで登録することもできます。 新しいメール/パスワードのアカウントを使用して、既にお持ちの VCS (GitHub または Bitbucket) アカウントに接続する場合は、アカウントはご使用の VCS のアカウント名に基づいてマージされます。

== 手順 2: 新しいプロジェクトの作成

. CircleCI Web アプリで、**Projects** に行き、 **Create Project** ボタンをクリックします。
. プロジェクト名を入力します。
. **Code Source** 下に、**OAuth** 経由、または **アクセストークン** を使って GitLab に接続するオプションがあります。 
+
IMPORTANT: 設定するレポジトリへの API アクセスと書き込みアクセス許可が必要です。 GitLab では、これは「保守担当者」以上の役割です。 アクセストークンを使用する場合、`api` スコープと `write_permissions` スコープを選択する必要があります。
+
**OAuth 経由で GitLab に接続する** には、**Connect** ボタンをクリックします。 ブラウザーのウィンドウが開き、GitLab のサインインページに移動します。 GitLab で認証されたら、CircleCI の Create New Project ウィンドウにリダイレクトされます。
+
緑色のチェックマークと "CircleCI will listen to your code source for changes." が表示されたら GitLab への接続は成功です。 GitLab リポジトリのドロップダウンリストも表示されます。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-connect-oauth.png[Successful GitLab connection via OAuth]
+
**アクセストークンを使って接続するには:** フィールドにアクセストークンを入力し、**Connect** ボタンをクリックします。 パーソナルアクセストークンまたはプロジェクトアクセストークンを使用できます。 プロジェクトアクセストークンは、特定の GitLab サブスクリプションやライセンス階層でのみ使用できます。 詳細については、GitLab のttps://docs.gitlab.com/ee/user/profile/personal_access_tokens.html[Personal Access Tokens] と https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html[Project Access Tokens] を参照してください。
+
"Access token successful" というメッセージが表示されたら GitLab への接続は成功です。 GitLab リポジトリのドロップダウンリストも表示されます。 セットアップできるリポジトリは、ご使用のパーソナル/プロジェクトアクセストークンに関連づけられてるものによって異なります。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-connect-token.png[Successful GitLab connection using access token]
. 設定するリポジトリを選択し、**Create Project** をクリックします。

裏では、CircleCI が GitLab リポジトリ内に Webhook を登録しています。 これは、プロジェクトの作成に成功すると、リポジトリの Settings > Webhooks に移動し、確認することができます。

== 手順 3: CircleCI でプロジェクトパイプラインをトリガーする

現時点では、新しい GitLab プロジェクトを設定しても、パイプラインは自動的にトリガーされません。 現時点では、またCircleCI 設定ファイルを CircleCI Web アプリ内で追加または編集することもできません。

. まだお済みでない方は、GitLab リポジトリの一番上で `.circleci` ディレクトリを作成し、そのディレクトリに `config.yml` ファイルを追加します。
+
NOTE: CircleCI を初めて利用される方は、<hello-world#echo-hello-world-on-linux#,Hello World>サンプルを使って始めることも、<<sample-config#,サンプル設定>> をご覧いただくことも可能です。 <<configuration-reference#,CircleCI の設定>> では、`.circleci/config.yml` で使われているキーをすべて参照することができます。
. GitLab リポジトリに変更をプッシュします。 CircleCI Web アプリでプロジェクトのパイプラインが実行されているはずです。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-successful-pipeline.png[Successful pipeline run]

== プロジェクト設定

GitHub プロジェクトや Bitbucket プロジェクトとは異なり、GitLab サポート (プレビュー) では、一つの VCS に固有ではない「スタンドアロン」プロジェクトというコンセプトが導入されています。

プロジェクトには 1 つまたは複数の **設定ファイル** を含めることができます。設定ファイルは、リポジトリ内の '.circleci/config.yml' ファイルを含む (ただしこれらに限定されない) パイプラインの定義です。

プロジェクトには 1 つまたは複数の **トリガー** を含めることができます。トリガーは、VCS を含む (ただしこれに限定されない) 変更のソースからのイベントです。
 トリガーにより、パイプラインの開始に使う設定ファイルが決まります。

下記の設定は、プロジェクト内で **Project Settings**  ボタンをクリックすると表示されます。 この時点では、設定ファイルもトリガーも GitLab に限定されています。 プロジェクトで有効化できるその他の設定については、<<settings#,設定>>　のドキュメントを参照してください。

=== アクティブな開発におけるプロジェクト設定

[CAUTION]
====
下記は、迅速な開発についてのセクションであり、現在のエクスペリエンスには必要な機能が反映されていません。 この時点では、手動による **設定ファイル** と **トリガー** の設定はお勧めしていません。 このドキュメントで先述した <<#step-two-create-a-new-project,新しいプロジェクトのオンボード手順>> に従ってください。 

The following sections on configuration and triggers are included so you can see what is being worked on and what functionality you can expect in the future.
====

==== 設定ファイル

プロジェクトに設定ソースを追加します。 GitLab を接続する上記の手順に従った場合、GitLab の設定ソースが自動的に追加されています。 設定ソースを定義すると、その設定ファイルを参照するトリガーをセットアップすることができます。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-project-settings-configuration.png[Configuration setup page]

==== トリガー

どの設定ソースがパイプラインを開始するかを指定するトリガーを追加します。 GitLab を接続する上記の手順に従った場合、GitLab で設定ソースとして設定されたトリガーが自動的に追加されています。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-project-settings-triggers.png[Trigger setup page]

トリガーとトリガールールにより、CircleCI が変更のソース (この場合はGitLab) からのイベントをどのように処理するかが決まります。

トリガーが作成されると、CircleCI は GitLab に Webhook を登録します。 GitLab からのプッシュイベントは CircleCI に送信されます。 CircleCI はその後、イベントデーターを使って、パイプラインを実行すべきか_どうか_ を決定し、実行する場合、_どの_  パイプラインを実行すべきかを決定します。

設定ソースに加えて、各トリガーには Webhook の URL や、このシナリオでは、CircleCI が作成した GitLab トークンも含まれます。 GitLab レポジトリからプッシュイベントを受信するには、GitLab 内でWebhook URLと GitLab トークンを使用して、Webhook をセキュアに登録します。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-project-settings-edit-trigger.png[Trigger details]

NOTE: GitLab  (プレビュー) では、以下のプロジェクト設定の機能の違いにも注意してください。

=== **高度な設定**

- 冗長ワークフローの自動キャンセルを選択できます。 Refer to the <<skip-build#auto-cancelling,Auto cancelling section>> of the Skip or cancel jobs and workflows document for more details.
- You can enable dynamic configuration using setup workflows in CircleCI. To learn about dynamic configuration, read the <<dynamic-config#,Dynamic Configuration>> guide.
- At this time, the **Free and Open Source** setting is not currently supported, but there are plans to make this available in the future.

=== **SSH Keys**

When creating a project, an SSH key is created which is used to checkout code from your repo. Each configuration you create generates a new SSH key to access the code in the repo associated with that configuration. At this time, only **Additional SSH Keys** are applicable to GitLab projects. For more information on SSH keys, please visit the <<add-ssh-key#,Adding an SSH Key to CircleCI>> document.

== Organization settings

The GitLab preview also introduces the concept of "standalone" organizations, which are not tied to a VCS.

A standalone organization allows for managing users and projects independent of the VCS. Organizations as well as users are considered CircleCI organizations and users, with their own roles and permissions that do not rely on those defined in a VCS.

To manage settings on the organization level, click the **Organization Settings** button within the CircleCI web app. More general information on organization settings in CircleCI can be found in the <<settings#,Settings>> document.

=== チーム

Add or remove users, and manage user roles for the organization as well as user invites.

NOTE: You must have at least one org administrator. If you try to remove the last org administrator, you will get an error.

==== Inviting your first team members

Upon creating a new organization, you also have the option to invite team members from the dashboard. Alternatively, you may invite team members from the **People** section within **Organization Settings**.

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-org-settings-people.png[People section under Organization Settings]

. Click the **Invite** button.
. Enter the email address of the user you wish to invite, and select the appropriate role. You may enter multiple addresses at once, if you wish to assign these users the same role.
+
Organization administrator as well as organization contributor roles are currently available. Project-specific roles will be coming soon. For more information on roles and permissions, refer to the <<#about-roles-and-permissions,next section>>.
. An invited user will receive an email notification (sent from `noreply@circleci.com`), containing a link to accept the invite.
+
If they do not currently have a CircleCI account, they will need to sign up. If they already have a CircleCI account, they are added to the organization, and if they are logged in, they will see the organization as an option in the organization switcher in the top left corner of the web app.

==== About roles and permissions

User access and roles within CircleCI are independent of roles within GitLab. Each user can have one organization role: either an _admin_ or _contributor_.

Contributors cannot edit organization settings such as contexts or plans, nor can they invite users. Org contributors can, however, view contexts, and create and view projects Administrators are able to invite users and update role settings.

* Org Administrator: For those managing CircleCI as a whole—managing users, managing plans, updating billing information, and managing contexts.
* Org Contributor: For users that might create and administer multiple projects within CircleCI, but are not required to manage organization settings.
* Org Viewer (coming soon): For users such as those in support roles that do not contribute code but need to see reports, know the status of projects, or validate plan usage.
* Project Administrator (coming soon): For ensuring teams only have access to individual projects and not all projects across the organization. Project administrators, typically the team manager or lead, will have access to project settings.
* Project Contributor (coming soon): For individual team members who are not required to manage project settings.
* Project Viewer (coming soon): For users that might need to know the status of an individual project, but are not committing changes.

== Coming soon

NOTE: The following sections are features of CircleCI which are not currently fully supported in the GitLab support preview. These features are in active development for use with GitLab and will be added in the future.

=== セルフホストランナー

Self-hosted runners are currently being tested in GitLab preview at this time, and support is expected soon. If you would like more information about using self-hosted runners, visit the <<runner-overview#,Runner Overview>> page.

=== Restricted access to contexts

Restricted access to contexts is not supported in the GitLab preview at this time. This means that any user within the organization can create triggers, and any users that can trigger pipelines from the source can use those contexts. In a future update, it will be possible to limit access to contexts by project and/or branch, giving your organization greater control and ensuring individual users only have access to the contexts they require.

If you would like more information about using contexts within CircleCI, visit the <<contexts#,Using Contexts>> page.

=== Project settings for triggers and configurations

Users will be able to independently manage their triggers and configuration. This includes the ability to allow a trigger from one repository to kick off a pipeline defined by a configuration existing in another repository.

Users will be able to set up a project manually through a project’s trigger and configuration settings. At this time, all users must use the new project creation process described in the beginning of this guide to successfully setup a GitLab project.

=== Trigger rules

Trigger rules give you the ability to determine when an event should or should not trigger a pipeline build. This will allow you to run a pipeline only on merge requests or other attributes of the event from the VCS.

=== Project roles and view-only roles

Organizations can limit user access to a project or projects, and not require an organization-level role. This gives greater control over which users have access to projects across the organization, and limits access to organization settings or creating new projects.

=== Account integrations

There is currently no method to manage GitLab integrations in this area. We are working on including GitLab in the options listed.

== 既知の問題

NOTE: The following sections are features of CircleCI which are known issues in the GitLab support preview. These features are in active development for use with GitLab and will be fixed in the future.

=== SSH rerun is not working

Support for SSH rerun is currently not available. This will be resolved in a future release.

=== Additional SSH keys only

Deploy Key and User Key are not being used at this time. All SSH keys generated for a project will be stored under **Additional SSH Keys**.

=== Project configurations not applicable

The current project configuration options under **Project Settings** do not yet have full functionality. At this time, CircleCI does look for a `.circleci/config.yml` in the root of the repo. In a coming update, configuration sources will be managed independently of triggers.

For now, use the **Create Project** button from the **Projects** tab in the web app, as described earlier in this guide, to set up your projects.

=== User account integrations do not include GitLab

The **User Settings > Account Integrations** page does not currently include GitLab as a choice.

At this time, GitLab integration should only be configured through new project creation. Project settings for creating triggers and configuration will be added soon.

=== Advanced options in project settings

- **Auto-cancel redundant workflows** is not currently supported.
- The **Free and Open Source** setting is not currently supported.
- Project settings for building forked pull requests are not available.

=== Stop building option in project settings

**Stop Building** does not work. The recommendation is to delete your webhooks in your GitLab repo if you no longer want a CircleCI pipeline to run.

=== Plans and usage

- Plans pages display the organization UUID and not the name.
- Usage pages do not include the GitLab project name under **Projects**.
- Only users that created a project in CircleCI and triggered a build are counted as active users.