---

version:
- クラウド
---
= GitLab サポートプレビューに関するドキュメント
:page-layout: classic-docs
:page-liquid:
:page-description: GitHub と CircleCI の連携方法について説明します。
:icons: font
:toc: macro

:toc-title:

== 概要

[IMPORTANT]
====
GitLab バージョン管理システム (VSC) サポート (プレビュー) にようこそ。

弊社では、このサポートの改善を継続的に繰り返し行なっています。 パフォーマンスの問題やエラーが発生したり、予期せぬ変更が加えられる可能性があるのでご注意ください。

**現時点では、CircleCI での本番環境の重要な作業に GitLab VCS サポートを使用することはお勧めしません。**

シームレスで安定したエクスペリエンスの提供に向け、皆様にプレビュープロセスにご参加いただき、ご協力いたければ幸いです。

https://ideas.circleci.com/gitlab-vcs-experience-feedback[フィードバックを送信する]
====

このドキュメントでは、GitLab プロジェクトを CircleCI と連携する方法を説明します。 CI/CD パイプラインを管理するための新しいコンセプトや方法も紹介します。 また、既知の問題や今後のリリース予定もお知らせします。

== 手順 1: 登録

GitLab サポート (プレビュー) は、新規および既存の CircleCI ユーザーにご利用いただけます。 新規および既存ユーザー用の下記の 2 つの手順説明をお読みください。

=== 新規 CircleCI ユーザー用: CircleCI アカウントを作成し、最初の組織を作成します。  

. **メールで登録** オプションを選択し、https://circleci.com/signup/[CircleCI に登録します] (パスワードも作成します)。 
. メールアドレスとパスワードを設定したら、GitLab、GitHub、または Bitbucket への接続オプション画面が表示されます。 GitLab との **接続** をクリックします。 
+
NOTE: GitLab への接続オプションが表示されない場合は、こちらの https://circleci.com/gitlab-vcs-support/[登録フォーム] にご記入ください。
+
NOTE: 新規アカウントと GitHub アカウントまたは Bitbucket アカウントとの接続を選択すると、アカウントはご使用の VCS のアカウント名に基づいてマージされます。
. 次のページに、"Welcome to the GitLab VCS Support Preview" というメッセージが表示されます。 新しい組織を作成するよう求められます。 組織名を入力して、**Create Organization** をクリックします。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-create-org.png[Create new organization]

新しい組織を作成したら、 Web アプリのダッシュボードが表示されます。 下記の <<#step-two-create-a-new-project,手順 2>> に記載されている手順に従い、新しいプロジェクトを作成します。

=== 既存の CircleCI ユーザー用: 新しい組織を作成します。

. https://app.circleci.com/[CircleCI Web アプリ] にログインします。
. 組織名をクリックし、画面左上で組織切り替えメニューを開きます。 **Create New Organization** を選択します。
. 次のページに、"Welcome to the GitLab VCS Support Preview" というメッセージが表示されます。 新しい組織の一意の名前を入力します。
+
NOTE: Welcome メッセージが表示されない場合、こちらの https://circleci.com/gitlab-vcs-support/[登録フォーム] にご記入ください。
. **Create Organization** をクリックします。

この新しい組織により、組織内のユーザーと GitLab プロジェクトを管理できます。 この組織は、まず <<plan-free#,**Free プラン**>> に置かれます。 後で他のプランにアップグレードできます。 この料金プランは、以前アカウントで設定した GitHub または Bitbucket 組織とは無関係です。

新しい組織を作成したら、 組織のダッシュボードが表示されます。 下記の <<#step-two-create-a-new-project,手順 2>> に記載されている手順に従って新しい GitLab プロジェクトを設定します。

NOTE: 既存の CircleCI ユーザーは、メールアドレスとパスワードで登録することもできます。 新しいメール/パスワードのアカウントを使用して、既にお持ちの VCS (GitHub または Bitbucket) アカウントに接続する場合は、アカウントはご使用の VCS のアカウント名に基づいてマージされます。

== 手順 2: 新しいプロジェクトの作成

. CircleCI Web アプリで、**Projects** に行き、 **Create Project** ボタンをクリックします。
. プロジェクト名を入力します。
. **Code Source** 下に、**OAuth** 経由、または **アクセストークン** を使って GitLab に接続するオプションがあります。 
+
IMPORTANT: 設定するレポジトリへの API アクセスと書き込みアクセス許可が必要です。 GitLab では、これは「保守担当者」以上の役割です。 アクセストークンを使用する場合、`api` スコープと `write_permissions` スコープを選択する必要があります。
+
**OAuth 経由で GitLab に接続する** には、**Connect** ボタンをクリックします。 ブラウザーのウィンドウが開き、GitLab のサインインページに移動します。 GitLab で認証されたら、CircleCI の Create New Project ウィンドウにリダイレクトされます。
+
緑色のチェックマークと "CircleCI will listen to your code source for changes." が表示されたら GitLab への接続は成功です。 GitLab リポジトリのドロップダウンリストも表示されます。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-connect-oauth.png[Successful GitLab connection via OAuth]
+
**アクセストークンを使って接続するには:** フィールドにアクセストークンを入力し、**Connect** ボタンをクリックします。 パーソナルアクセストークンまたはプロジェクトアクセストークンを使用できます。 プロジェクトアクセストークンは、特定の GitLab サブスクリプションやライセンス階層でのみ使用できます。 詳細については、GitLab のttps://docs.gitlab.com/ee/user/profile/personal_access_tokens.html[Personal Access Tokens] と https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html[Project Access Tokens] を参照してください。
+
"Access token successful" というメッセージが表示されたら GitLab への接続は成功です。 GitLab リポジトリのドロップダウンリストも表示されます。 セットアップできるリポジトリは、ご使用のパーソナル/プロジェクトアクセストークンに関連づけられてるものによって異なります。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-connect-token.png[Successful GitLab connection using access token]
. 設定するリポジトリを選択し、**Create Project** をクリックします。

裏では、CircleCI が GitLab リポジトリ内に Webhook を登録しています。 これは、プロジェクトの作成に成功すると、リポジトリの Settings > Webhooks に移動し、確認することができます。

== 手順 3: CircleCI でプロジェクトパイプラインをトリガーする

現時点では、新しい GitLab プロジェクトを設定しても、パイプラインは自動的にトリガーされません。 現時点では、またCircleCI 設定ファイルを CircleCI Web アプリ内で追加または編集することもできません。

. まだお済みでない方は、GitLab リポジトリの一番上で `.circleci` ディレクトリを作成し、そのディレクトリに `config.yml` ファイルを追加します。
+
NOTE: CircleCI を初めて利用される方は、<hello-world#echo-hello-world-on-linux#,Hello World>サンプルを使って始めることも、<<sample-config#,サンプル設定>> をご覧いただくことも可能です。 <<configuration-reference#,CircleCI の設定>> では、`.circleci/config.yml` で使われているキーをすべて参照することができます。
. GitLab リポジトリに変更をプッシュします。 CircleCI Web アプリでプロジェクトのパイプラインが実行されているはずです。
+
image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-successful-pipeline.png[Successful pipeline run]

== プロジェクト設定

GitHub プロジェクトや Bitbucket プロジェクトとは異なり、GitLab サポート (プレビュー) では、一つの VCS に固有ではない「スタンドアロン」プロジェクトというコンセプトが導入されています。

プロジェクトには 1 つまたは複数の **設定ファイル** を含めることができます。設定ファイルは、リポジトリ内の '.circleci/config.yml' ファイルを含む (ただしこれらに限定されない) パイプラインの定義です。

プロジェクトには 1 つまたは複数の **トリガー** を含めることができます。トリガーは、VCS を含む (ただしこれに限定されない) 変更のソースからのイベントです。
 トリガーにより、パイプラインの開始に使う設定ファイルが決まります。

下記の設定は、プロジェクト内で **Project Settings**  ボタンをクリックすると表示されます。 この時点では、設定ファイルもトリガーも GitLab に限定されています。 プロジェクトで有効化できるその他の設定については、<<settings#,設定>>　のドキュメントを参照してください。

=== アクティブな開発におけるプロジェクト設定

[CAUTION]
====
下記は、迅速な開発についてのセクションであり、現在のエクスペリエンスには必要な機能が反映されていません。 この時点では、手動による **設定ファイル** と **トリガー** の設定はお勧めしていません。 このドキュメントで先述した <<#step-two-create-a-new-project,新しいプロジェクトのオンボード手順>> に従ってください。 

下記の設定ファイルとトリガーに関するセクションでは、現在の作業内容と今後どのような機能が期待できるかをご確認いただけます。
====

==== 設定ファイル

プロジェクトに設定ソースを追加します。 GitLab を接続する上記の手順に従った場合、GitLab の設定ソースが自動的に追加されています。 設定ソースを定義すると、その設定ファイルを参照するトリガーをセットアップすることができます。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-project-settings-configuration.png[Configuration setup page]

==== トリガー

どの設定ソースがパイプラインを開始するかを指定するトリガーを追加します。 GitLab を接続する上記の手順に従った場合、GitLab で設定ソースとして設定されたトリガーが自動的に追加されています。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-project-settings-triggers.png[Trigger setup page]

トリガーとトリガールールにより、CircleCI が変更のソース (この場合はGitLab) からのイベントをどのように処理するかが決まります。

トリガーが作成されると、CircleCI は GitLab に Webhook を登録します。 GitLab からのプッシュイベントは CircleCI に送信されます。 CircleCI はその後、イベントデーターを使って、パイプラインを実行すべきか_どうか_ を決定し、実行する場合、_どの_  パイプラインを実行すべきかを決定します。

設定ソースに加えて、各トリガーには Webhook の URL や、このシナリオでは、CircleCI が作成した GitLab トークンも含まれます。 GitLab レポジトリからプッシュイベントを受信するには、GitLab 内でWebhook URLと GitLab トークンを使用して、Webhook をセキュアに登録します。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-project-settings-edit-trigger.png[Trigger details]

NOTE: GitLab  (プレビュー) では、以下のプロジェクト設定の機能の違いにも注意してください。

=== **高度な設定**

- 冗長ワークフローの自動キャンセルを選択できます。 詳細については、ジョブやワークフローのスキップやキャンセルに関するドキュメントの <<skip-build#auto-cancelling,自動キャンセルのセクション>>  を参照してください。
- CircleCI でセットアップ ワークフローを使って、ダイナミックコンフィグを有効化できます。 ダイナミックコンフィグに関する詳細は、<<dynamic-config#,ダイナミックコンフィグ>> ガイドをお読みください。
- 現時点では、**無料のオープンソース** 設定はサポートされていませんが、今後この機能を利用できるようにする予定があります。

=== **SSH キー**

プロジェクトを作成する場合、 SSH キーが作成され、リポジトリからコードをチェックアウトするために使用されます。 作成した各設定ファイルごとに、その設定ファイルに関連づけられたリポジトリのコードにアクセスするために新しい SSH キーが生成されます。 今回、GitLab プロジェクトには **追加 SSH キー** のみが適用されます。 SSH キーに関する詳細は、<<add-ssh-key#,CircleCI への SSH キーの追加>> をご覧ください。

== 組織設定

GitLab  (プレビュー) には、特定の VCS に関連づけられない「スタンドアロン」組織のコンセプトも導入されています。

スタンドアロン組織は、VCS に関係なくユーザーやプロジェクトを管理することができます。 組織やユーザーは、CircleCI の組織やユーザーとみなされ、VCS で定義づけられたロールや権限に依存せず、独自のロールや権限を持ちます。

組織レベルで設定を管理するには、CircleCI Web アプリの **Organization Settings** ボタンをクリックします。 CircleCI の組織設定に関する一般的な情報は、<<settings#,設定>> ドキュメントを参照してください。

=== チーム

ユーザーを追加または削除し、組織のユーザーロールやユーザーの招待を管理します。

NOTE: 少なくとも１名の組織管理者が必要です。 最後の組織管理者を削除しようとすると、エラーになります。

==== 最初のチームメンバーを招待する

新しい組織を作成したら、オプションでダッシュボードからチームメンバーを招待することもできます。 代わりに、 **Organization Settings** の **People** のセクションからチームメンバーを招待することもできます。

image::{{site.baseurl}}/assets/img/docs/gl-preview/gitlab-preview-org-settings-people.png[People section under Organization Settings]

. **Invite** ボタンをクリックします。
. 招待したいユーザーのメールアドレスを入力し、適切なロールを選択します。 複数のユーザーに同じロールをアサインする場合は、複数のアドレスを同時に入力できます。
+
現在、組織管理者ロールと組織のコントリビューターロールがあります。 プロジェクト固有のロールは間もなく追加されます。 ロールや権限の詳細については、<<#about-roles-and-permissions,次のセクション>> を参照してください。
. 招待されたユーザーは、招待を受けるためのリンクが含まれたメール通知 (`noreply@circleci.com` から送信) を受け取ります。
+
そのユーザーが CircleCI アカウントを持っていない場合は、登録する必要があります。 既に CircleCI アカウントをお持ちのユーザーは、組織に追加されます。ユーザーがログインすると、Web アプリの左上にある組織切替メニューにその組織がオプションとして表示されます。

==== ロールと権限について

CircleCI 内でのユーザーのアクセス権とロールは、GitLab 内のロールとは無関係です。 各ユーザーごとに 1 つの組織ロール (管理者またはコントリビューターのいずれか) を持つことができます。

コントリビューターは、コンテキストやプランなどの組織設定を編集することも他のユーザーを招待することもできません。 しかし、コンテキストの閲覧、プロジェクトの作成や閲覧が可能です。管理者は、ユーザーの招待やロール設定のアップデートが可能です。

* 組織管理者: CircleCI を全体として管理します。ユーザーやプランを管理し、請求情報の更新やコンテキストを管理するユーザーが対象です。
* 組織コントリビューター: CircleCI 内で複数のプロジェクトの作成や管理を行いますが、組織設定の管理は求められないユーザーが対象です。
* 組織ビューアー (近日追加予定): コードは提供せず、レポートの表示、プロジェクトのステータスの把握、プランの使用状況の確認が必要なサポートロールのユーザーが対象です。
* プロジェクト管理者 (近日追加予定): チームが組織全体のすべてのプロジェクトにではなく、個々のプロジェクトにのみアクセスできるようにします。 プロジェクト管理者、通常はチーム管理者、またはチームリーダーはプロジェクト設定へのアクセス権があります。
* プロジェクトコントリビューター (近日追加予定): プロジェクト設定が求められない個々のチームメンバーが対象です。
* プロジェクトビューアー (近日追加予定): 各プロジェクトのステータスを知る必要がありますが、変更をコミットしないユーザーです。

== 近日公開予定

NOTE: 下記のセクションでは、GitLab サポート(プレビュー) では現在はまだフルサポートされていない CircleCI の機能を紹介します。 これらの機能は、GitLab で使用できるよう現在積極的に開発が進められており、今後公開される予定です。

=== セルフホストランナー

現在セルフホストランナーは、GitLab (プレビュー) でテストを行なっており、まもなくサポートされる予定です。 セルフホストランナーの使用に関する詳細は、<<runner-overview#,ランナーの概要>> を参照してください。

=== コンテキストへのアクセス制限

現時点では、コンテキストへのアクセス制限は GitLab (プレビュー) ではサポートされていません。 つまり、組織内のユーザーは誰でもトリガーを作成することができ、パイプラインをソースからトリガーできるユーザーは誰でもコンテキストを使用できるということです。 今後の更新で、プロジェクトやブランチごとにコンテキストへのアクセスを制限できるようになる予定です。それにより、組織が制御できる幅が広がり、各ユーザーが必要なコンテキストにのみアクセスできるようにすることが可能になります。

CircleCI でのコンテキストの使用に関する詳細は、<<contexts#,コンテキストの使用>> を参照してください。

=== トリガーと設定ファイルのプロジェクト設定

ユーザーはトリガーと設定ファイルを個別に管理できるようになります。 これには、あるリポジトリからのトリガーを可能にし、他のリポジトリにある設定ファイルで定義されたパイプラインを実行する機能も含まれます。

ユーザーはプロジェクトのトリガーと設定ファイルの設定により手動でプロプロジェクトを設定できるようになります。 現時点では、どのユーザーも　GItLab プロジェクトを正常にセットアップするための本ガイドの冒頭で記載した新規プロジェクトの作成プロセスを用いる必要があります。

=== トリガールール

トリガールールを使用すると、イベントがパイプラインのビルドをトリガーするタイミングを決定できます。 これにより、VCS からのマージリクエストまたはイベントの他の属性に対してのみパイプラインを実行できます。

=== プロジェクトロールと閲覧のみのロール

組織はユーザーのアクセス権を一つまたは複数のプロジェクトに制限し、組織レベルのロールを要求しないように設定できます。 これにより、組織全体のプロジェクトへのアクセス権を持つユーザーをより細かく制御し、組織設定へのアクセスや新規プロジェクトの作成を制限することができます。

=== アカウントの連携

現在 この分野で GitLab の連携を管理する方法はありません。 CircleCI では、リストされているオプションに GitLab を含める作業に取り組んでいます。

== 既知の問題

NOTE: 下記のセクションでは、GitLab サポート(プレビュー) で既知の問題となっている CircleCI の機能を紹介します。 これらの機能は、GitLab で使用できるよう現在積極的に開発が進められており、今後修正される予定です。

=== SSH の再実行ができない

SSH の再実行は現在サポートされていません。 これは、今後のリリースで解決される予定です。

=== 追加 SSH キーのみ

デプロイキーとユーザーキーは現時点では使用されていません。 一つのプロジェクト用に作成された SSH キーはすべて、**Additional SSH Keys** 下に保存されます。

=== プロジェクト設定が適用されない

**Project Settings** 下のプロジェクト設定ファイルの現在のオプションは、まだ完全に機能していません。 現時点では、CircleCI はリポジトリのルートで `.circleci/config.yml` を探します。 今後の更新では、設定ソースはトリガーとは別に管理されるようになります。

現時点では、本ガイドで先述したように Web アプリの **Projects** タブから **Create Project** ボタンを使ってプロジェクトを設定してください。

=== ユーザーアカウントの連携に GitLab が含まれない

現在 **User Settings > Account Integrations** のページには、GitLab が選択肢として含まれていません。

現時点では、GitLab の連携は新規プロジェクトの作成時のみ設定します。 トリガーと設定ファイルの作成用のプロジェクト設定が近日追加される予定です。

=== プロジェクト設定における高度なオプション

- **冗長ワークフローの自動キャンセル** は、現在サポートされていません。
- The **Free and Open Source** setting is not currently supported.
- Project settings for building forked pull requests are not available.

=== Stop building option in project settings

**Stop Building** does not work. The recommendation is to delete your webhooks in your GitLab repo if you no longer want a CircleCI pipeline to run.

=== Plans and usage

- Plans pages display the organization UUID and not the name.
- Usage pages do not include the GitLab project name under **Projects**.
- Only users that created a project in CircleCI and triggered a build are counted as active users.