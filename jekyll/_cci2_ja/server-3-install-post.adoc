---

version:
- Server v3.x
- サーバー管理者
---
= CircleCI Server v3.x インストール ステップ 4

:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

// This doc uses ifdef and ifndef directives to display or hide content specific to Google Cloud Storage (env-gcp) and AWS (env-aws). Currently, this affects only the generated PDFs. To ensure compatability with the Jekyll version, the directives test for logical opposites. For example, if the attribute is NOT env-aws, display this content. For more information, see https://docs.asciidoctor.org/asciidoc/latest/directives/ifdef-ifndef/.

CircleCI Server v3.x のポストインストールステップを開始する前に、xref:server-3-install-prerequisites.adoc[ステップ 1 - 前提条件]、 xref:server-3-install.adoc[ステップ 2 - コアサービスのインストール]、 xref:server-3-install-build-services.adoc[ステップ 3 - ビルドサービスのインストール]が実行済みであることを確認してください。

.インストール 手順（フローチャートのステップ 4）
image::server-install-flow-chart-phase4.png[Flow chart showing the installation flow for server 3.x with phase 4 highlighted]

NOTE: 以下のセクションでは、`< >` の中に表示される認証情報の項目にご自身の情報を入力してください。


toc::[]

== ステップ 4: ポストインストール

=== バックアップとリストアの設定

CircleCI Server のバックアップは、 https://kots.io/[KOTS] を介して作成できます。
バックアップ サポートを有効にするには、クラスタに https://velero.io/[Velero] をインストールして設定する必要があります。 Veleo はインストールの前提条件のセクションで必要なソフトウェアのリストに載っているので、既にインストールされているかもしれません。

// Don't include this section in the GCP PDF:

ifndef::env-gcp[]
=== AWS での CircleCI Server 3.x のバックアップ

これらの手順は、 https://github.com/vmware-tanzu/velero-plugin-for-aws#setup[こちら] の Velero ドキュメントを元にしています。

==== 手順 1 - AWS S3 バケットの作成

[source,bash]
----
BUCKET=<YOUR_BUCKET>
REGION=<YOUR_REGION>
aws s3api create-bucket \
    --bucket $BUCKET \
    --region $REGION \
    --create-bucket-configuration LocationConstraint=$REGION
----

NOTE: `us-east-1`  では、https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateBucket.html#API_CreateBucket_RequestBody[LocationConstraint] がサポートされていません。 `us-east-1` リージョンを使用している場合、バケットの設定は省略してください。

==== 手順 2 - Velero の権限の設定

* IAM ユーザーを作成します。

[source,bash]
----
aws iam create-user --user-name velero
----

* 必要な権限を付与するポリシーをユーザー `velero` にアタッチします。

[source,bash]
----
cat > velero-policy.json <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeVolumes",
                "ec2:DescribeSnapshots",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:CreateSnapshot",
                "ec2:DeleteSnapshot"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:PutObject",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts"
            ],
            "Resource": [
                "arn:aws:s3:::${BUCKET}/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::${BUCKET}"
            ]
        }
    ]
}
EOF
----

[source,bash]
----
aws iam put-user-policy \
  --user-name velero \
  --policy-name velero \
  --policy-document file://velero-policy.json
----

* ユーザー `velero` 用のアクセス キーを作成します。

[source,bash]
----
aws iam create-access-key --user-name velero
----

このコマンドの結果は以下のようになります。

[source,bash]
----
{
  "AccessKey": {
        "UserName": "velero",
        "Status": "Active",
        "CreateDate": "2017-07-31T22:24:41.576Z",
        "SecretAccessKey": <AWS_SECRET_ACCESS_KEY>,
        "AccessKeyId": <AWS_ACCESS_KEY_ID>
  }
}
----

* 以下の内容を記載した、Velero 固有の認証情報ファイルをローカルディレクトリに作成します (例:  `./credentials-velero`)。

[source,bash]
----
[default]
aws_access_key_id=<AWS_ACCESS_KEY_ID>
aws_secret_access_key=<AWS_SECRET_ACCESS_KEY>
----

ここで、`AWS_ACCESS_KEY_ID` プレースホルダーと `AWS_SECRET_ACCESS_KEY` プレースホルダーには、前の手順の `create-access-key` リクエストで返された値を指定します。

==== 手順 3 - Velero のインストールと起動

* Run the following `velero` `install` command. This will create a namespace called `velero` and install all the necessary resources to run Velero.
Make sure that you pass the correct file name containing the AWS credentials that you have created in <<Step 2 - Setup permissions for Velero, Step 2>>.

NOTE: KOTS backups require https://restic.net/[restic] to operate. When installing Velero, ensure that you have the `--use-restic` flag set, as shown below:

[source, bash]
----
velero install \
    --provider aws \
    --plugins velero/velero-plugin-for-aws:v1.2.0 \
    --bucket $BUCKET \
    --backup-location-config region=$REGION \
    --snapshot-location-config region=$REGION \
    --secret-file ./credentials-velero \
    --use-restic \
    --wait
----

* Once Velero is installed on your cluster, check the new `velero` namespace. 以下のように、Velero デプロイと restic デーモンセットがあれば成功です。

[source,bash]
----
$ kubectl get pods --namespace velero
NAME                      READY   STATUS    RESTARTS   AGE
restic-5vlww              1/1     Running   0          2m
restic-94ptv              1/1     Running   0          2m
restic-ch6m9              1/1     Running   0          2m
restic-mknws              1/1     Running   0          2m
velero-68788b675c-dm2s7   1/1     Running   0          2m
----

restic はデーモンセットなので、Kubernetes クラスタ内のノード 1 つにつき 1 つの Pod が存在します。

// Stop hiding from GCP PDF:
endif::[]

// Don't include this section in the AWS PDF:

ifndef::env-aws[]
=== Server 3.x backups on GCP

The following steps are specific for Google Cloud Platform and it is assumed you have met the <<prerequisites, prerequisites>>.

These instructions were sourced from the documentation for the Velero GCP plugin https://github.com/vmware-tanzu/velero-plugin-for-gcp#setup[here].

==== Step 1 - Create a GCP bucket
To reduce the risk of typos, we will set some of the parameters as shell variables. すべての手順を 1 つのセッションで完了できず、再開する場合は、必要に応じて変数を再設定するようにしてください。 たとえば、以下の手順では、バケット名に対応する変数を定義しています。 Replace
the `<YOUR_BUCKET>` placeholder with the name of the bucket you want to create for your backups.

[source,bash]
----
BUCKET=<YOUR_BUCKET>

gsutil mb gs://$BUCKET/
----

==== Step 2 - Setup permissions for Velero

CircleCI Server を GKE クラスタ内で実行している場合、RBAC オブジェクトを作成する必要があるため、使用する IAM ユーザーをクラスタの管理者に設定してください。 More information can be found in the https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#iam-rolebinding-bootstrap[GKE documentation].

. 最初に、プロジェクト ID に対応するシェル変数を設定します。 To do so, first make sure that your `gcloud` CLI points to the correct project by looking at the current configuration:
+
[source,bash]
----
gcloud config list
----
. プロジェクトが適切に参照されていれば、以下のように変数を設定します。
+
[source,bash]
----
PROJECT_ID=$(gcloud config get-value project)
----
. 以下のコマンドを実行して、サービス アカウントを作成します。
+
[source,bash]
----
gcloud iam service-accounts create velero \
    --display-name "Velero service account"
----
+
NOTE: If you run several clusters with Velero, you might want to consider using a more specific name for the Service Account besides `velero`, as suggested above.
. 以下のコマンドを実行して、サービス アカウントが正常に作成されたことを確認します。
+
[source,bash]
----
gcloud iam service-accounts list
----
. 次に、サービス アカウントの電子メール アドレスを変数に格納します。
+
[source,bash]
----
SERVICE_ACCOUNT_EMAIL=$(gcloud iam service-accounts list \
  --filter="displayName:Velero service account" \
  --format 'value(email)')
----
+
サービス アカウントに付けた表示名に合わせて、必要に応じてコマンドを変更してください。
. 必要な権限をサービス アカウントに付与します。
+
[source,bash]
----
ROLE_PERMISSIONS=(
    compute.disks.get
    compute.disks.create
    compute.disks.createSnapshot
    compute.snapshots.get
    compute.snapshots.create
    compute.snapshots.useReadOnly
    compute.snapshots.delete
    compute.zones.get
)

gcloud iam roles create velero.server \
    --project $PROJECT_ID \
    --title "Velero Server" \
    --permissions "$(IFS=","; echo "${ROLE_PERMISSIONS[*]}")"

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member serviceAccount:$SERVICE_ACCOUNT_EMAIL \
    --role projects/$PROJECT_ID/roles/velero.server

gsutil iam ch serviceAccount:$SERVICE_ACCOUNT_EMAIL:objectAdmin gs://${BUCKET}
----

次に、Velero でこのサービス アカウントを使用できるようにする必要があります。

[discrete]
===== オプション 1: JSON キー ファイル

サービス アカウントとしてアクションを実行できるように Velero を認証するには、JSON 認証情報ファイルを Velero に渡します。 それにはまず、以下のコマンドを実行してキーを作成します。

[source,bash]
----
gcloud iam service-accounts keys create credentials-velero \
    --iam-account $SERVICE_ACCOUNT_EMAIL
----

After running this command, you should have a file named `credentials-velero` in your local working directory.

[discrete]
===== オプション 2: Workload Identity

If you are already using https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity[Workload Identities] in your cluster, you can bind
the GCP Service Account you just created to Velero's Kubernetes service account. In this case, the GCP Service Account will need the
`iam.serviceAccounts.signBlob` role in addition to the permissions already specified above.

NOTE: 静的 JSON 認証情報から Workload Identity に切り替える場合は、GCP および CircleCI KOTS 管理者コンソールからキーを削除する必要があります。

==== Step 3 - Install and start Velero

* Run one of the following `velero` `install` commands, depending on how you authorized the service account. This will create a namespace called `velero` and install all the necessary resources to run Velero.

NOTE: KOTS backups require https://restic.net/[restic] to operate. When installing Velero, ensure that you have the `--use-restic` flag set.

[discrete]
===== JSON キー ファイルを使用する場合

[source, bash]
----
velero install \
    --provider gcp \
    --plugins velero/velero-plugin-for-gcp:v1.2.0 \
    --bucket $BUCKET \
    --secret-file ./credentials-velero \
    --use-restic \
    --wait
----

[discrete]
===== Workload Identity を使用する場合

[source,bash]
----
velero install \
    --provider gcp \
    --plugins velero/velero-plugin-for-gcp:v1.2.0 \
    --bucket $BUCKET \
    --no-secret \
    --sa-annotations iam.gke.io/gcp-service-account=$SERVICE_ACCOUNT_EMAIL \
    --backup-location-config serviceAccount=$SERVICE_ACCOUNT_EMAIL \
    --use-restic \
    --wait
----

For more options on customizing your installation, refer to the https://github.com/vmware-tanzu/velero-plugin-for-gcp#install-and-start-velero[Velero documentation].

* Once Velero is installed on your cluster, check the new `velero` namespace. 以下のように、Velero デプロイと restic デーモンセットがあれば成功です。

[source,bash]
----
$ kubectl get pods --namespace velero
NAME                      READY   STATUS    RESTARTS   AGE
restic-5vlww              1/1     Running   0          2m
restic-94ptv              1/1     Running   0          2m
restic-ch6m9              1/1     Running   0          2m
restic-mknws              1/1     Running   0          2m
velero-68788b675c-dm2s7   1/1     Running   0          2m
----

restic はデーモンセットなので、Kubernetes クラスタ内のノード 1 つにつき 1 つの Pod が存在します。
endif::[]

////

* S3-COMPATIBLE SETUP *

////

=== S3 互換ストレージでの CircleCI Server 3.x のバックアップ

The following steps will assume you're using S3 compatible object storage, but not necessarily AWS S3, for your backups.
It is also assumed you have met the <<s3-compatible-storage-prerequisites, prerequisites>>.

These instructions were sourced from the Velero documentation https://velero.io/docs/v1.6/contributions/minio/[here].

==== Step 1 - Configure `mc` client

To start, configure https://docs.min.io/minio/baremetal/reference/minio-mc.html[`mc`] to connect to your storage
provider:

[source,bash]
----
# Alias can be any name as long as you use the same value in subsequent commands
export ALIAS=my-provider
mc alias set $ALIAS <YOUR_MINIO_ENDPOINT> <YOUR_MINIO_ACCESS_KEY_ID> <YOUR_MINIO_SECRET_ACCESS_KEY>
----

You can verify your client is correctly configured by running `mc ls my-provider` and you should see the buckets in your provider enumerated in the output.

==== 手順 2 - バケットの作成

バックアップ用のバケットを作成します。 Velero では、他のコンテンツが含まれた既存のバケットを使用できないので、新しいバケットを使用する必要があります。

[source, bash]
----
mc mb ${ALIAS}/<YOUR_BUCKET>
----

==== 手順 3 - ユーザーとポリシーの作成

次に、Velero がバケットにアクセスするためのユーザーとポリシーを作成します。

NOTE: In the following snippet `<YOUR_MINIO_ACCESS_KEY_ID>` and `<YOUR_MINIO_SECRET_ACCESS_KEY>` refer to the credentials used by Velero to access MinIO.

[source, bash]
----
# Create user
mc admin user add $ALIAS <YOUR_MINIO_ACCESS_KEY_ID> <YOUR_MINIO_SECRET_ACCESS_KEY>

# Create policy
cat > velero-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:*"
      ],
      "Resource": [
        "arn:aws:s3:::<YOUR_BUCKET>",
        "arn:aws:s3:::<YOUR_BUCKET>/*"
      ]
    }
  ]
}
EOF

mc admin policy add $ALIAS velero-policy velero-policy.json

# Bind user to policy
mc admin policy set $ALIAS velero-policy user=<YOUR_VELERO_ACCESS_KEY_ID>
----

Finally, we add our new user's credentials to a file (`./credentials-velero` in
this example) with the following contents:

[source,toml]
----
[default]
aws_access_key_id=<YOUR_VELERO_ACCESS_KEY_ID>
aws_secret_access_key=<YOUR_VELERO_SECRET_ACCESS_KEY>
----

==== 手順 4 - Velero のインストールと起動

Run the following `velero install` command. This will create a namespace called `velero` and install all the necessary resources to run Velero.

NOTE: KOTS backups require https://restic.net/[restic] to operate. When installing Velero, ensure that you have the `--use-restic` flag set, as shown below:

[source, bash]
----
velero install --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.2.0 \
  --bucket <YOUR_BUCKET> \
  --secret-file ./credentials-velero \
  --use-volume-snapshots=false \
  --use-restic \
  --backup-location-config region=minio,s3ForcePathStyle="true",s3Url=<YOUR_ENDPOINT> \
  --wait
----

Once Velero is installed on your cluster, check the new `velero` namespace. 以下のように、Velero デプロイと restic デーモンセットがあれば成功です。

[source,bash]
----
$ kubectl get pods --namespace velero
NAME                      READY   STATUS    RESTARTS   AGE
restic-5vlww              1/1     Running   0          2m
restic-94ptv              1/1     Running   0          2m
restic-ch6m9              1/1     Running   0          2m
restic-mknws              1/1     Running   0          2m
velero-68788b675c-dm2s7   1/1     Running   0          2m
----

restic はデーモンセットなので、Kubernetes クラスタ内のノード 1 つにつき 1 つの Pod が存在します。

=== バックアップの作成

クラスタへの Velero のインストールが完了すると、管理コンソールのナビゲーション バーに [Snapshots (スナップショット)] オプションが表示されるようになります。

image::kots-admin-navbar-snapshot-option.png[Kots Navbar]

このオプションが表示されれば、バックアップの作成を始める準備は完了です。 If you do not see this option, please refer to the
https://circleci.com/docs/2.0/server-3-operator-backup-and-restore/#troubleshooting-backups-and-restoration[troubleshooting] section.

==== オプション 1 - KOTS CLI を使用したバックアップ作成

バックアップを作成するには、以下のコマンドを実行します。

[source,bash]
----
kubectl kots backup --namespace <your namespace>
----

==== オプション 2 - KOTS 管理者コンソールを使用したバックアップ作成

Select *Snapshots* from the navbar. The default selection should be *Full Snapshots*, which is recommended.

image::kots-admin-full-snapshot.png[Kots Navbar]

Click the *Start a snapshot* button.

image::kots-admin-create-backup.png[Kots Create Snapshot]

=== Orbs

CircleCI Server システムには、固有のローカル Orb レジストリが含まれています。
このレジストリは、CircleCI Server からのみアクセスできます。 設定ファイルで参照している Orb はすべて、この CircleCI Server Orb レジストリに含まれる Orb を参照します。 All orbs referenced in project configs reference the orbs in the _server_ orb registry. Orb のメンテナンスはご自身で行う必要があります。 それには以下が含まれます。

* パブリック レジストリからの Orb のコピー
* 以前コピーした Orb の更新
* Registering your company's private orbs, if you have any

For more information, and steps to complete these tasks see the https://circleci.com/docs/2.0/server-3-operator-orbs/[Orbs on Server guide].

=== [Email Notifications (メール通知)]

ビルドの通知はメールで送信されます。 ここではメールによるビルド通知設定方法の詳細について説明します。

KOTS の管理コンソールにアクセスします。 名前空間を変更して下記を実行し、KOTS 管理者コンソールを表示します。

[source,shell]
----
kubectl kots admin-console -n <YOUR_CIRCLECI_NAMESPACE>
----

Locate the *Email Notifications* section in *Settings* and fill in the following details to configure email notifications for your installation.

* *Email Submission server hostname (required)* - Host name of the submission server (e.g., for Sendgrid use smtp.sendgrid.net).
* *Username (required)* - Username to authenticate to submission server. 一般的には、ユーザーのメール アドレスと同一になります。
* *Password (required)* - Password to authenticate to submission server.
* *Port (optional)* - Port of the submission server. 通常は 25 か 587 です。 メール送信にはポート 465 もよく使われますが、このポートは StartTLS ではなく暗黙的 TLS に使用することがほとんどです。 CircleCI Server では、送信の暗号化には StartTLS のみをサポートしています。
+
NOTE: ポート 25 のアウトバウンド接続は、ほとんどのクラウド プロバイダーでブロックされます。 このポートを選択すると、通知の送信に失敗する可能性があります。
Enable StartTLS を有効にすると、メール送信が暗号化されます。
* *Email from address (required)* - The _from_ address for the email.

NOTE: デフォルトでは StartTLS がメールの暗号化に使用されますが、これを無効にするのは、他にトラフィックの機密性を保証できる場合のみにしてください。

Click the *Save config* button to update your installation and redeploy server.

ifndef::pdf[]
## What to read next

* https://circleci.com/docs/2.0/server-3-install-hardening-your-cluster[Hardening Your Cluster]
* https://circleci.com/docs/2.0/server-3-install-migration[Server 3.x Migration]
endif::[]