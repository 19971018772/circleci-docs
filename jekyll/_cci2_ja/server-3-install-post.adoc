---

version:
- Server v3.x
- サーバー管理者
---
= CircleCI Server v3.x インストール ステップ 4

:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

// This doc uses ifdef and ifndef directives to display or hide content specific to Google Cloud Storage (env-gcp) and AWS (env-aws). Currently, this affects only the generated PDFs. To ensure compatability with the Jekyll version, the directives test for logical opposites. For example, if the attribute is NOT env-aws, display this content. For more information, see https://docs.asciidoctor.org/asciidoc/latest/directives/ifdef-ifndef/.

CircleCI Server v3.x のポストインストールステップを開始する前に、xref:server-3-install-prerequisites.adoc[ステップ 1 - 前提条件]、 xref:server-3-install.adoc[ステップ 2 - コアサービスのインストール]、 xref:server-3-install-build-services.adoc[ステップ 3 - ビルドサービスのインストール]が実行済みであることを確認してください。

.インストール 手順（フローチャートのステップ 4）
image::server-install-flow-chart-phase4.png[Flow chart showing the installation flow for server 3.x with phase 4 highlighted]

NOTE: 以下のセクションでは、`< >` の中に表示される認証情報の項目にご自身の情報を入力してください。


toc::[]

== ステップ 4: ポストインストール

=== バックアップとリストアの設定

CircleCI Server のバックアップは、 https://kots.io/[KOTS] を介して作成できます。
バックアップ サポートを有効にするには、クラスタに https://velero.io/[Velero] をインストールして設定する必要があります。 Veleo はインストールの前提条件のセクションで必要なソフトウェアのリストに載っているので、既にインストールされているかもしれません。

// Don't include this section in the GCP PDF:

ifndef::env-gcp[]
=== AWS での CircleCI Server 3.x のバックアップ

これらの手順は、 https://github.com/vmware-tanzu/velero-plugin-for-aws#setup[こちら] の Velero ドキュメントを元にしています。

==== 手順 1 - AWS S3 バケットの作成

[source,bash]
----
BUCKET=<YOUR_BUCKET>
REGION=<YOUR_REGION>
aws s3api create-bucket \
    --bucket $BUCKET \
    --region $REGION \
    --create-bucket-configuration LocationConstraint=$REGION
----

NOTE: `us-east-1`  では、https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateBucket.html#API_CreateBucket_RequestBody[LocationConstraint] がサポートされていません。 `us-east-1` リージョンを使用している場合、バケットの設定は省略してください。

==== 手順 2 - Velero の権限の設定

* IAM ユーザーを作成します。

[source,bash]
----
aws iam create-user --user-name velero
----

* 必要な権限を付与するポリシーをユーザー `velero` にアタッチします。

[source,bash]
----
cat > velero-policy.json <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeVolumes",
                "ec2:DescribeSnapshots",
                "ec2:CreateTags",
                "ec2:CreateVolume",
                "ec2:CreateSnapshot",
                "ec2:DeleteSnapshot"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:PutObject",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts"
            ],
            "Resource": [
                "arn:aws:s3:::${BUCKET}/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::${BUCKET}"
            ]
        }
    ]
}
EOF
----

[source,bash]
----
aws iam put-user-policy \
  --user-name velero \
  --policy-name velero \
  --policy-document file://velero-policy.json
----

* ユーザー `velero` 用のアクセス キーを作成します。

[source,bash]
----
aws iam create-access-key --user-name velero
----

このコマンドの結果は以下のようになります。

[source,bash]
----
{
  "AccessKey": {
        "UserName": "velero",
        "Status": "Active",
        "CreateDate": "2017-07-31T22:24:41.576Z",
        "SecretAccessKey": <AWS_SECRET_ACCESS_KEY>,
        "AccessKeyId": <AWS_ACCESS_KEY_ID>
  }
}
----

* Create a Velero-specific credentials file (for example: `./credentials-velero`) in your local directory, with the following contents:

[source,bash]
----
[default]
aws_access_key_id=<AWS_ACCESS_KEY_ID>
aws_secret_access_key=<AWS_SECRET_ACCESS_KEY>
----

ここで、`AWS_ACCESS_KEY_ID` プレースホルダーと `AWS_SECRET_ACCESS_KEY` プレースホルダーには、前の手順の `create-access-key` リクエストで返された値を指定します。

==== 手順 3 - Velero のインストールと起動

* 以下の `velero` `install` コマンドを実行します。 This creates a namespace called `velero` and installs all the necessary resources to run Velero.
Make sure that you pass the correct file name containing the AWS credentials that you created in <<Step 2 - Setup permissions for Velero, Step 2>>.

NOTE: KOTS のバックアップには、 https://restic.net/[restic] が必要です。
 Velero のインストール時に、以下に示すように  `--use-restic` フラグを設定してください。

[source, bash]
----
velero install \
    --provider aws \
    --plugins velero/velero-plugin-for-aws:v1.2.0 \
    --bucket $BUCKET \
    --backup-location-config region=$REGION \
    --snapshot-location-config region=$REGION \
    --secret-file ./credentials-velero \
    --use-restic \
    --wait
----

* Velero がクラスタにインストールされたら、新しい `velero`  名前空間を確認します。 以下のように、Velero デプロイと restic デーモンセットがあれば成功です。

[source,bash]
----
$ kubectl get pods --namespace velero
NAME                      READY   STATUS    RESTARTS   AGE
restic-5vlww              1/1     Running   0          2m
restic-94ptv              1/1     Running   0          2m
restic-ch6m9              1/1     Running   0          2m
restic-mknws              1/1     Running   0          2m
velero-68788b675c-dm2s7   1/1     Running   0          2m
----

restic はデーモンセットなので、Kubernetes クラスタ内のノード 1 つにつき 1 つの Pod が存在します。

// Stop hiding from GCP PDF:
endif::[]

// Don't include this section in the AWS PDF:

ifndef::env-aws[]
=== GCP での CircleCI Server 3.x のバックアップ

以下の手順は、Google Cloud Platform を対象としており、<<前提条件>>を満たしていることを前提としています。

これらの手順は、 https://github.com/vmware-tanzu/velero-plugin-for-gcp#setup[こちら]の Velero GCP プラグインのドキュメントを元にしています。

==== Step 1 - Create a GCP bucket
To reduce the risk of typos, you can set some of the parameters as shell variables. すべての手順を 1 つのセッション内で完了できず再開する場合は、必要に応じて変数を再設定するようにしてください。 In the step below, for example, you can define a variable for your bucket name. Replace the `<YOUR_BUCKET>` placeholder with the name of the bucket you want to create for your backups.

[source,bash]
----
BUCKET=<YOUR_BUCKET>
----

==== 手順 2 - Velero の権限の設定

If your server installation runs within a GKE cluster, ensure that your current IAM user is a cluster admin for this cluster, as RBAC objects need to be created. 詳細については、 https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#iam-rolebinding-bootstrap[GKE のドキュメント]を参照してください。

. First, you will set a shell variable for your project ID. To do so, make sure that your `gcloud` CLI points to the correct project by looking at the current configuration:
+
[source,bash]
----
gcloud config list
----
. プロジェクトが適切に参照されていれば、以下のように変数を設定します。
+
[source,bash]
----
PROJECT_ID=$(gcloud config get-value project)
----
. 以下のコマンドを実行して、サービス アカウントを作成します。
+
[source,bash]
----
gcloud iam service-accounts create velero \
    --display-name "Velero service account"
----
+
NOTE: If you run several clusters with Velero, consider using a more specific name for the Service Account besides `velero`, as suggested above.
. 以下のコマンドを実行して、サービス アカウントが正常に作成されたことを確認します。
+
[source,bash]
----
gcloud iam service-accounts list
----
. 次に、サービス アカウントの電子メール アドレスを変数に格納します。
+
[source,bash]
----
SERVICE_ACCOUNT_EMAIL=$(gcloud iam service-accounts list \
  --filter="displayName:Velero service account" \
  --format 'value(email)')
----
+
サービス アカウントに付けた表示名に合わせて、必要に応じてコマンドを変更してください。
. 必要な権限をサービス アカウントに付与します。
+
[source,bash]
----
ROLE_PERMISSIONS=(
    compute.disks.get
    compute.disks.create
    compute.disks.createSnapshot
    compute.snapshots.get
    compute.snapshots.create
    compute.snapshots.useReadOnly
    compute.snapshots.delete
    compute.zones.get
)

gcloud iam roles create velero.server \
    --project $PROJECT_ID \
    --title "Velero Server" \
    --permissions "$(IFS=","; echo "${ROLE_PERMISSIONS[*]}")"

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member serviceAccount:$SERVICE_ACCOUNT_EMAIL \
    --role projects/$PROJECT_ID/roles/velero.server

gsutil iam ch serviceAccount:$SERVICE_ACCOUNT_EMAIL:objectAdmin gs://${BUCKET}
----

次に、Velero でこのサービス アカウントを使用できるようにする必要があります。

[discrete]
===== オプション 1: JSON キー ファイル

サービス アカウントとしてアクションを実行できるように Velero を認証するには、JSON 認証情報ファイルを Velero に渡します。 To do this, you first need to create a key:

[source,bash]
----
gcloud iam service-accounts keys create credentials-velero \
    --iam-account $SERVICE_ACCOUNT_EMAIL
----

After running this command, you should see a file named `credentials-velero` in your local working directory.

[discrete]
===== オプション 2: Workload Identity

If you are already using https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity[Workload Identities] in your cluster, you can bind the GCP Service Account you just created to Velero's Kubernetes service account. In this case, the GCP Service Account needs the
`iam.serviceAccounts.signBlob` role in addition to the permissions already specified above.

NOTE: 静的 JSON 認証情報から Workload Identity に切り替える場合は、GCP および CircleCI KOTS 管理者コンソールからキーを削除する必要があります。

==== 手順 3 - Velero のインストールと起動

* サービスアカウントの認証方法に応じて、以下の `velero` `install` コマンドのいずれかを実行します。 This creates a namespace called `velero` and installs all the necessary resources to run Velero.

NOTE: KOTS のバックアップには、 https://restic.net/[restic] が必要です。
 Velero のインストール時に、`--use-restic` フラグを設定してください。

[discrete]
===== JSON キー ファイルを使用する場合

[source, bash]
----
velero install \
    --provider gcp \
    --plugins velero/velero-plugin-for-gcp:v1.2.0 \
    --bucket $BUCKET \
    --secret-file ./credentials-velero \
    --use-restic \
    --wait
----

[discrete]
===== Workload Identity を使用する場合

[source,bash]
----
velero install \
    --provider gcp \
    --plugins velero/velero-plugin-for-gcp:v1.2.0 \
    --bucket $BUCKET \
    --no-secret \
    --sa-annotations iam.gke.io/gcp-service-account=$SERVICE_ACCOUNT_EMAIL \
    --backup-location-config serviceAccount=$SERVICE_ACCOUNT_EMAIL \
    --use-restic \
    --wait
----

システムをカスタマイズする他のオプションについては、 https://github.com/vmware-tanzu/velero-plugin-for-gcp#install-and-start-velero[Velero のドキュメント]を参照してください。

* Velero がクラスタにインストールされたら、新しい `velero`  名前空間を確認します。 以下のように、Velero デプロイと restic デーモンセットがあれば成功です。

[source,bash]
----
$ kubectl get pods --namespace velero
NAME                      READY   STATUS    RESTARTS   AGE
restic-5vlww              1/1     Running   0          2m
restic-94ptv              1/1     Running   0          2m
restic-ch6m9              1/1     Running   0          2m
restic-mknws              1/1     Running   0          2m
velero-68788b675c-dm2s7   1/1     Running   0          2m
----

restic はデーモンセットなので、Kubernetes クラスタ内のノード 1 つにつき 1 つの Pod が存在します。
endif::[]

////

* S3-COMPATIBLE SETUP *

////

=== S3 互換ストレージでの CircleCI Server 3.x のバックアップ

The following steps assume you are using S3-compatible object storage, but not necessarily AWS S3, for your backups.
また、<<前提条件>>を満たしていることも前提としています。

これらの手順は、 https://velero.io/docs/v1.6/contributions/minio[こちら] の Velero ドキュメントを元にしています。

==== 手順 1 - `mc` クライアントの設定

To start, configure https://docs.min.io/minio/baremetal/reference/minio-mc.html[`mc`] to connect to your storage provider:

[source,bash]
----
# エイリアスは任意の名前でかまいませんが、以降のコマンドでも同じ値を使用してください。
export ALIAS=my-provider
mc alias set $ALIAS <YOUR_MINIO_ENDPOINT> <YOUR_MINIO_ACCESS_KEY_ID> <YOUR_MINIO_SECRET_ACCESS_KEY>
----

クライアントが適切に設定されたかどうかは、`mc ls my-provider` を実行して確認できます。

==== 手順 2 - バケットの作成

バックアップ用のバケットを作成します。 Velero では、他のコンテンツが含まれた既存のバケットを使用できないので、新しいバケットを使用する必要があります。

[source, bash]
----
mc mb ${ALIAS}/<YOUR_BUCKET>
----

==== 手順 3 - ユーザーとポリシーの作成

次に、Velero がバケットにアクセスするためのユーザーとポリシーを作成します。

NOTE: 次のスニペットに含まれる `<YOUR_MINIO_ACCESS_KEY_ID>` と `<YOUR_MINIO_SECRET_ACCESS_KEY>` には、Velero が MinIO にアクセスするために使用する認証情報を指定します。

[source, bash]
----
# Create user
mc admin user add $ALIAS <YOUR_MINIO_ACCESS_KEY_ID> <YOUR_MINIO_SECRET_ACCESS_KEY>

# Create policy
cat > velero-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:*"
      ],
      "Resource": [
        "arn:aws:s3:::<YOUR_BUCKET>",
        "arn:aws:s3:::<YOUR_BUCKET>/*"
      ]
    }
  ]
}
EOF

mc admin policy add $ALIAS velero-policy velero-policy.json

# Bind user to policy
mc admin policy set $ALIAS velero-policy user=<YOUR_VELERO_ACCESS_KEY_ID>
----

Finally, you add your new user's credentials to a file (`./credentials-velero` in
this example) with the following contents:

[source,toml]
----
[default]
aws_access_key_id=<YOUR_VELERO_ACCESS_KEY_ID>
aws_secret_access_key=<YOUR_VELERO_SECRET_ACCESS_KEY>
----

==== 手順 4 - Velero のインストールと起動

以下の `velero` `install`  コマンドを実行します。 This creates a namespace called `velero` and installs all the necessary resources to run Velero.

NOTE: KOTS のバックアップには、 https://restic.net/[restic] が必要です。
 Velero のインストール時に、以下に示すように  `--use-restic` フラグを設定してください。

[source, bash]
----
velero install --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.2.0 \
  --bucket <YOUR_BUCKET> \
  --secret-file ./credentials-velero \
  --use-volume-snapshots=false \
  --use-restic \
  --backup-location-config region=minio,s3ForcePathStyle="true",s3Url=<YOUR_ENDPOINT> \
  --wait
----

Velero がクラスタにインストールされたら、新しい `velero`  名前空間を確認します。 以下のように、Velero デプロイと restic デーモンセットがあれば成功です。

[source,bash]
----
$ kubectl get pods --namespace velero
NAME                      READY   STATUS    RESTARTS   AGE
restic-5vlww              1/1     Running   0          2m
restic-94ptv              1/1     Running   0          2m
restic-ch6m9              1/1     Running   0          2m
restic-mknws              1/1     Running   0          2m
velero-68788b675c-dm2s7   1/1     Running   0          2m
----

restic はデーモンセットなので、Kubernetes クラスタ内のノード 1 つにつき 1 つの Pod が存在します。

=== バックアップの作成

クラスタへの Velero のインストールが完了すると、管理コンソールのナビゲーション バーに [Snapshots (スナップショット)] オプションが表示されるようになります。

image::kots-admin-navbar-snapshot-option.png[Kots Navbar]

このオプションが表示されれば、バックアップの作成を始める準備は完了です。 このオプションが表示されない場合は、 https://circleci.com/docs/2.0/server-3-operator-backup-and-restore/#troubleshooting-backups-and-restoration[トラブルシューティング] を参照してください。

==== Option 1 - Create a backup with KOTS CLI

To create the backup, run the following command:

[source,bash]
----
kubectl kots backup --namespace <your namespace>
----

==== オプション 2 - KOTS 管理者コンソールを使用したバックアップ作成

ナビゲーションバーの *Snapshots* を選択します。 デフォルトでは *Full Snapshots* が選択されています。 これが推奨オプションです。

image::kots-admin-full-snapshot.png[Kots Navbar]

*Start a snapshot* ボタンをクリックします。

image::kots-admin-create-backup.png[Kots Create Snapshot]

=== Orb

CircleCI Server システムには、固有のローカル Orb レジストリが含まれています。
このレジストリは、CircleCI Server からのみアクセスできます。 設定ファイルで参照している Orb はすべて、この CircleCI Server Orb レジストリに含まれる Orb を参照します。 プロジェクト設定ファイルで参照された Orb はすべて、 _server_ orb レジストリに含まれる Orb を参照します。 Orb のメンテナンスはご自身で行う必要があります。 それには以下が含まれます。

* パブリック レジストリからの Orb のコピー.
* Updating orbs that may have been copied previously.
* Registering your company's private orbs, if you have any.

For more information and steps to complete these tasks, see the https://circleci.com/docs/2.0/server-3-operator-orbs/[Orbs on Server guide].

=== メール通知

ビルドの通知はメールで送信されます。 ここではメールによるビルド通知設定方法の詳細について説明します。

KOTS の管理コンソールにアクセスします。 名前空間を変更して下記を実行し、KOTS 管理者コンソールを表示します。

[source,shell]
----
kubectl kots admin-console -n <YOUR_CIRCLECI_NAMESPACE>
----

*Settings* の *Email Notifications* セクションに行き、下記の詳細を入力してインストール環境のメール通知を設定します。

Locate the *Email Notifications* section in *Settings* and fill in the following details to configure email notifications for your installation:

* *Email Submission server hostname (required)* - Host name of the submission server (for example, for Sendgrid use smtp.sendgrid.net).
* *Username (ユーザー名)](必須)*: 送信サーバーの認証に使用するユーザー名を指定します。 This is commonly the same as the user’s email address.
* *Password (パスワード)](必須)* : 送信サーバーの認証に使用するパスワードを指定します。
* *[Port (ポート)](オプション)*: 送信サーバーのポートを指定します。 通常は 25 か 587 です。 メール送信にはポート 465 もよく使われますが、このポートは StartTLS ではなく暗黙的 TLS に使用することがほとんどです。 CircleCI Server では、送信の暗号化には StartTLS のみをサポートしています。
+
NOTE: ポート 25 のアウトバウンド接続は、ほとんどのクラウド プロバイダーでブロックされます。 Should you select this port, be aware that your notifications may fail to send.
* *Enable StartTLS* - Enabling this will encrypt mail submission.
+
NOTE: デフォルトでは StartTLS がメールの暗号化に使用されますが、これを無効にするのは、他にトラフィックの機密性を保証できる場合のみにしてください。
* *Email from address (メールの送信元アドレス)] (必須)*: メールの送信元アドレスを指定します。

*[Save config (構成の保存)]* ボタンをクリックし、CircleCI Server を更新して再デプロイします。

ifndef::pdf[]
## 次に読む

* https://circleci.com/docs/2.0/server-3-install-hardening-your-cluster[クラスタのハードニング]
* https://circleci.com/docs/2.0/server-3-install-migration[Server 3.x への移行]
endif::[]