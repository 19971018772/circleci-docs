---

version:
- Server v3.x
- サーバー管理者
---
= CircleCI Server v3.x インストール ステップ 2

:page-layout: classic-docs
:page-liquid:
:page-description: Find the steps and prerequisites for the server v3.x installation.
:icons: font
:toc: macro
:toc-title:

// This doc uses ifdef and ifndef directives to display or hide content specific to Google Cloud Storage (env-gcp) and AWS (env-aws). Currently, this affects only the generated PDFs. To ensure compatability with the Jekyll version, the directives test for logical opposites. For example, if the attribute is NOT env-aws, display this content. For more information, see https://docs.asciidoctor.org/asciidoc/latest/directives/ifdef-ifndef/.

Before you begin with the CircleCI server v3.x core services installation phase, ensure all xref:server-3-install-prerequisites.adoc[prerequisites] are met.

.インストール手順のフローチャート ステップ 2）
image::server-install-flow-chart-phase2.png[Flow chart showing the installation flow for server 3.x with phase 2 highlighted]

NOTE: In the following sections replace any items or credentials displayed between `< >` with your details.

toc::[]

== ステップ 2: コアサービスのインストール

CircleCI server v3.x uses https://kots.io[KOTS] from https://www.replicated.com/[Replicated] for installation management and distribution.

. 次のコマンドを実行して最小バージョン {kotsversion} の KOTS を実行していることを確認してください。
+
kubectl kots version
+
NOTE: KOTS コマンドは管理者コンソールへのトンネルを開きます。 WSL2 をインストールした Windows 上でコマンドを実行する場合、ホストマシンのポートを利用できません。 この問題を解決するには、いったん WSL を無効化してから有効化してください。 For more information, please see
https://github.com/microsoft/WSL/issues/4199.
. From the terminal, run (if you are installing behind a proxy see https://circleci.com/docs/2.0/server-3-install/#installing-behind-an-http-proxy[Installing behind HTTP Proxy]):
+
kubectl kots install circleci-server
+
すると、以下を入力するよう求められます。
* デプロイ先の名前空間
* KOTS 管理者コンソールのパスワード
. When complete, you should be provided with a URL to access the KOTS admin console, usually `\http://localhost:8800`.

TIP: If you need to get back to the KOTS admin console at a later date, run: `kubectl kots admin-console -n <YOUR_CIRCLECI_NAMESPACE>`

TIP: Once you have created your namespace, we recommend setting your `kubectl` context too with the following command: `kubectl config set-context --current --namespace <namespace>`

=== HTTP プロキシ経由でのインストール (オプション)

If you wish to install CircleCI server behind a proxy, use the following command structure should be used for step 2 above (for more information see the KOTS docs https://kots.io/kotsadm/installing/online-install/#proxies[here]):

kubectl kots install circleci-server --http-proxy <YOUR_HTTP_PROXY_URI> --https-proxy <https-proxy> --no-proxy <YOUR_NO_PROXY_LIST>


The load balancer endpoints must be added to the no-proxy list for the following services: `output processor` and `vm-service`. これは、非プロキシリストがアプリケーションとビルドエージェントの間で共有されているためです。 アプリケーションとビルドエージェントは同じファイアウォール内にあると想定されているため、両者の間にプロキシを介在させることはできません。

For further information see the https://circleci.com//docs/2.0/server-3-operator-proxy/index.html[Configuring a Proxy] guide.

=== フロントエンドの設定

フロントエンドの設定により、 CircleCI システムの Web アプリケーション固有の側面が制御されます。

.フロントエンドの設定
image::server-3-frontend-settings.png[Screenshot showing frontend settings]

以下のフィールドに入力します。

* *CircleCI Domain Name (required)* - Enter the domain name you specified when creating your Frontend TLS key and certificate.
* *Frontend Replicas* - Used to increase the amount of traffic that can be handled by the frontend.
* *Frontend TLS Private Key (required)* - You created this during your prerequisite steps. この値は以下のコマンドで取得できます。
+
cat /etc/letsencrypt/live/<CIRCLECI_SERVER_DOMAIN>/privkey.pem
* *Frontend TLS Certificate (required)* - You created this during your prerequisite steps. この値は以下のコマンドで取得できます。
+
cat /etc/letsencrypt/live/<CIRCLECI_SERVER_DOMAIN>/fullchain.pem


****
For the **Frontend TLS private key and certificate** you have 4 options:

* プライベートキーと証明書を指定します。
* Check the box that allows https://letsencrypt.org/[Let's Encrypt] to automatically request and manage certificates for you.
* Check the box that allows https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html[AWS Certificate Manager (ACM)] to automatically request and manage certificates for you. ACM の使用に関する詳細は、[CircleCI Server v3.x オペレーターの証明書]ガイドを参照してください。
* この時点で TLS ターミナルを無効にすることも可能ですが、HTTPS 経由でアクセスできる必要があります。

**Using ACM TLS Certificates**

If you would like to use https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html[AWS Certificate Manager (ACM)] to manage your TLS certificates, follow the https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html[ACM documentation] for instructions on how to generate ACM certificates.

証明書を作成したら、フロントエンドセクションの KOTS コンソールで ACM を有効にしてください。 ACM のボックスにチェックを入れて、ACM ARN (Amazon Resource Name) を入力します。

[WARNING]
====
CircleCI Server をデプロイ済みの場合は、ACM の有効化はフロントエンドサービスに破壊的な変更を加えます。 ACM 証明書の使用を許可するようサービスを再生成し、関連するロードバランサーも再生成する必要があります。
CircleCI Server を再デプロイした場合、DNS レコードを再ルーティングする必要があります。
====
****

* *Private Load Balancer (optional)* - Load balancer does not generate external IP addresses.
+
NOTE: If you are selecting the option to use private load balancers, the Let's Encrypt option will no longer work and become unavailable.

=== 暗号化

暗号化キーとアーティファクト署名キーは、前提条件のステップで作成しました。 そのキーをここで入力します。

.暗号化の設定
image::server-3-encryption-settings.png[Screenshot showing encryption settings]

以下の項目を入力してください。

* *アーティファクト署名キー (必須)*
* *暗号化署名キー (必須)*

=== GitHub

前提条件のステップで作成した Github OAuth アプリケーションのデータを使って、 以下の作業を行ってください。

.Github の設定
image::server-3-github-settings.png[Screenshot showing GitHub settings]

* *GitHub Type (required)* -
Select Cloud or Enterprise (on premises).
* *OAuth Client ID (required)* -
The OAuth Client ID provided by GitHub.
* *OAuth Client Secret (required)* -
The OAuth Client Secret provided by GitHub.
* *Github Enterprise Fingerprint* -
Required when using a proxy. Include the output of `ssh-keyscan github.example.com` in the text field.

=== オブジェクトストレージ

前提条件のステップで作成したオブジェクトストレージ バケットとキーを使って、 プラットフォームに応じて以下の設定を完了してください。

.オブジェクトストレージの設定
image::server-3-object-storage.png[Screenshot showing object storage settings]

// Don't include this section in the GCP PDF.

ifndef::env-gcp[]
==== S3 compatible

* *Storage Bucket Name (required)* -
The bucket used for server.
* *AWS S3 Region (optional)* -
AWS region of bucket if your provider is AWS. このオプションを設定すると、[S3 Endpoint (S3 エンドポイント)] は無視されます。
* *S3 Endpoint (optional)* -
API endpoint of S3 storage provider. プロバイダーが AWS ではない場合は必須です。 このオプションを設定すると、AWS S3 リージョンは無視されます。
* *Storage Object Expiry (required)* -
Number of days to retain your test results and artifacts. 有効期限を無効にしてオブジェクトを無期限に保持するには、0 に設定します。

===== Authentication
One of the following is required. IAM キーを選択し、以下を指定します。

* *Access Key ID (required)* -
Access Key ID for S3 bucket access.
* *Secret Key (required)* -
Secret Key for S3 bucket access.

または、IAM ロールを選択し、以下を指定します。

* *Role ARN* -
https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html[Role ARN for Service Accounts] (Amazon Resource Name) for S3 bucket access.

// Stop hiding from GCP PDF:
endif::[]

// Don't include this section in the AWS PDF:

ifndef::env-aws[]
==== Google Cloud Storage
You should have created your Google Cloud Storage bucket and service account during the prerequisite steps.

* *Storage Bucket Name (required)* -
The bucket used for server.
* *Storage Object Expiry (required)* -
Number of days to retain your test results and artifacts. 有効期限を無効にしてオブジェクトを無期限に保持するには、0 に設定します。

===== Authentication

* 以下のいづれかを選択します。
** *Service Account JSON (required)* - A JSON format key of the Service Account to use for bucket access.
** *Service Account Email (required)* - Service Account Email id if using Google Workload Identity.
endif::[]

// Stop hiding from AWS PDF

****
Skip over the next few sections - **Output Processor**, **Nomad** and **VM Service**. これらについては次のステップで設定します。
****

=== Postgres、MongoDB、Vault の設定

You can skip these sections unless you plan on using an existing Postgres, MongoDB or Vault instance, in which case, see the https://circleci.com/docs/2.0/server-3-operator-externalizing-services/[Externalizing Services doc]. CirecleCI Server v3.x では、デフォルトで CircleCI 名前空間内に独自の Postgres、MongoDB、および Vault インスタンスを作成します。 CircleCI 名前空間内のインスタンスは、CircleCI のバックアップおよび復元プロセスに含まれます。 

=== 保存とデプロイ

上記項目の設定が完了したら、いよいよデプロイです。 デプロイすると、コアサービスがインストールされ、Kong ロードバランサー用のIP アドレスが提供されます。 この IP アドレスは、DNS レコードを設定し、インストールの第一ステップを完了するための重要なアドレスです。

NOTE: From server v3.3.0, we have replaced https://github.com/traefik/traefik-helm-chart[Traefik] with https://github.com/Kong/charts[Kong] as our reverse proxy. しかし、アップグレードの際の中断を最小限に留めるために、Kong が使用するサービス名への変更はしておりません。 Although you will see a service named `circleci-server-traefik`, this service is actually for Kong.

=== DNS エントリーの作成

Create a DNS entry for your Kong load balancer, for example, `circleci.your.domain.com` and `app.circleci.your.domain.com`. この DNS エントリは、前提条件のステップで TLS 証明書とGitHub OAuth アプリケーションを作成する際に使用した DNS 名と一致している必要があります。 すべてのトラフィックは、この DNS レコードを介してルーティングされます。

Kong  ロードバランサーの IP アドレス、または AWS を使用している場合は DNS 名が必要になります。 以下のコマンドで情報を入手します。

[source, shell]
----
kubectl get service circleci-server-traefik --namespace=<YOUR_CIRCLECI_NAMESPACE>

----

新しい DNS レコードを追加する方法について詳しくは、以下のドキュメントを参照してください。

* link:https://cloud.google.com/dns/docs/records#adding_a_record[Managing Records] (GCP)
* link:https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resource-record-sets-creating.html[Creating records by using the Amazon Route 53 Console] (AWS)

NOTE: The Kong load balancer has a healthcheck that serves a JSON payload at https://loadbalancer-address/status

=== バリデーション

これで、CircleCI Server に移動し、アプリケーションに正常にログインできるはずです。

次は、サービスのビルドに移ります。 すべてのサービスが立ち上がるまで時間がかかることがあります。 You can periodically check by running the following command (you are looking for the “frontend” pod to show a status of _running_ and **ready** should show 1/1):

----
kubectl get pods -n <YOUR_CIRCLECI_NAMESPACE>
----

ifndef::pdf[]
## 次に読む

* https://circleci.com/docs/2.0/server-3-install-build-services/[Server 3.x Phase 3: Execution Environment Installation]
endif::[]