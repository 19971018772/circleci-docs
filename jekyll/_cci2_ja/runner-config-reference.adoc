---
version:
- Cloud
- Server v4.x
- Server v3.x
---
= Machine runner configuration reference
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

toc::[]

[#self-hosted-runner-configuration-reference]
== Machine runner configuration reference

A YAML file is used to configure the machine runner, how it communicates with CircleCI's servers, and how it will launch the task-agent.

設定ファイルの形式は次のとおりです。下記で説明する各種パラメーターを使用します。

```yaml
api:
  auth_token: AUTH_TOKEN
runner:
  name: RUNNER_NAME
```

NOTE: Machine runner can also be configured via environment variables. 環境変数が設定されている場合、YAMLファイルよりも優先されます。

[#api-auth-token]
=== api.auth_token
`$LAUNCH_AGENT_API_AUTH_TOKEN`

This is a token used to identify the machine runner to CircleCI and can be generated by the xref:local-cli.adoc[CircleCI CLI]. 既存のトークンは複数のインストール環境で共用できますが、このトークンでは特定の `resource_class` しか指定できません。

[#api-url]
=== api.url
`$LAUNCH_AGENT_API_URL`

セルフホストランナーが CircleCI との通信に使用する完全認証された URL です。 この変数は、3.2 以降のバージョンのサーバーがインストールされたセルフホストランナーのみ要求されます。

例

```yaml
api:
  url: https://circleci.example.com
```

[#runner-name]
=== runner.name
`$LAUNCH_AGENT_RUNNER_NAME`

`RUNNER_NAME` is a unique name assigned to this particular machine runner. CircleCI recommends using the hostname of the machine so that it can be used to identify the agent when viewing statuses and job results in the UI on the CircleCI web app.

[#logging-file]
=== logging.file
`$LAUNCH_AGENT_LOGGING_FILE`

This controls the file where the machine runner launch-agent and task-agent logs will go. See xref:runner-concepts.adoc#task-agent[CircleCI concepts] for more information on launch-agents and task-agents.

例

```yaml
logging:
  file: /Library/Logs/com.circleci.runner.log
```

[#runner-command-prefix]
=== runner.command_prefix
`$LAUNCH_AGENT_RUNNER_COMMAND_PREFIX`

This prefix takes a YAML list of arguments that wraps and runs the task-agent.

たとえば、`sudo`により権限が上がります。


```yaml
runner:
  command_prefix: ["sudo", "-niHu", "USERNAME", "--"]
```

このプレフィックスは、カスタムスクリプトの場合もあります。 The arguments passed to the script will launch the task-agent.

カスタムスクリプトは以下の点に注意して下さい。

1. Take great care to ensure the task-agent (that is, the arguments passed to it) runs
2. Forward the exit code from task-agent as its own exit code

`/var/opt/circleci/wrapper.sh` として保存されるスクリプト例:

```bash
#!/bin/bash

task_agent_cmd=${@:1}
echo "About to run CircleCI task agent: ${task_agent_cmd}"
$task_agent_cmd
exit=$?
echo "CircleCI task agent finished."
exit $exit
```

上記の例の設定ファイルスニペット

```yaml
runner:
  command_prefix: ["/var/opt/circleci/wrapper.sh"]
```

[#runner-working-directory]
=== runner.working_directory
`$LAUNCH_AGENT_RUNNER_WORK_DIR`

このディレクトリは、完全修飾パスを使用し、各ジョブで使用されるデフォルトの作業ディレクトリを制御できます。 If the directory already exists, the task-agent will need permissions to write to the directory. If the directory does not exist, then the task-agent will need permissions to create the directory. 1 つのマシーンに複数のローンチエージェントをインストールする場合、各ローンチエージェントごとに一意の作業ディレクトリが必要です。

NOTE: これらのディレクトリは自動的に削除されません。ディレクトリのクリーンアップの設定については `cleanup_working_directory` を参照してください。

例

```yaml
runner:
  working_directory: /var/opt/circleci/workdir
```

[#runner-cleanup-working-directory]
=== runner.cleanup_working_directory

CircleCI では、分かりやすいディレクトリを使用することを推奨していますが、パスに `%s` を指定することも可能です。 この値は各ジョブでは別の値に置き換えられます。 これは環境変数 `$CIRCLE_WORKING_DIRECTORY` の下で、ジョブの実行時にのみ分かる置き換えです。 

例

```yaml
runner:
  working_directory: /var/opt/circleci/%s
```

`$LAUNCH_AGENT_RUNNER_CLEANUP_WORK_DIR`

このフラグを設定すると、各ジョブの完了後に作業ディレクトリを削除するかどうかを指定できます。

値の例:

* `true`
* `false`

NOTE: デフォルト値は `false` です。

例

```yaml
runner:
  cleanup_working_directory: true
```

[#runner-mode]
=== runner.mode
`$LAUNCH_AGENT_RUNNER_MODE`

このパラメータにより、ジョブが完了した時点でセルフホストランナーインスタンスを終了させるか (`single-task`)、利用可能な新しいジョブを継続的にポーリングするか (`continuous`) を指定できます。

値の例:

* `continuous`
* `single-task`

NOTE: デフォルト値は `continuous` です。

例

```yaml
runner:
  mode: continuous
```

[#runner-max-run-time]
=== runner.max_run_time
`$LAUNCH_AGENT_RUNNER_MAX_RUN_TIME`

This value can be used to override the default maximum duration the task-agent will run each job. 値は、単位識別子付きの文字列です。識別子は、時間単位の場合は `h`、分単位の場合は `m`、秒単位の場合は `s` を使用します。

以下に有効な例を示します。

* `72h` - 3 日間
* `1h30m` - 1 時間 30 分
* `30s` - 30 秒
* `50m` - 50 分
* `1h30m20s` - 非常に細かな指定ですが、こうした時間指定も可能です。

NOTE: デフォルト値は 5 時間です。

例

```yaml
runner:
  max_run_time: 5h
```

[#customizing-job-timeouts-and-drain-timeouts]
==== ジョブタイムアウトとドレインタイムアウトをカスタマイズする

If you would like to customize the job timeout setting, you can “drain” the job by sending the machine runner a termination (TERM) signal, which then causes the machine runner to attempt to gracefully shutdown. When this TERM signal is received, the machine runner enters “draining” mode, preventing the machine runner from accepting any new jobs, but still allowing any current active job to be completed. At the end of “draining,” the machine runner then signals the task-agent to cancel any active job (by sending it a TERM signal).

NOTE: If the task-agent does not exit a brief period after the TERM, the machine runner will manually kill it by sending it a KILL signal.

ドレインは、次の 2 つのうちいずれかの条件で終了します。

* タスクがドレイン状態になった後、`max_run_time` の設定値以上の時間が経過する。
* An additional TERM signal is received by the machine runner during “draining”

[#runner-idle-timeout]
=== runner.idle_timeout
`$LAUNCH_AGENT_RUNNER_IDLE_TIMEOUT`

This timeout will enable a machine runner to terminate if no task has been claimed within the given time period. 値は、単位識別子付きの文字列です。識別子は、時間単位の場合は `h`、分単位の場合は `m`、秒単位の場合は `s` を使用します (例: `5m` は 5 分)。

NOTE: デフォルトでは、非アクティブな状態によりタイムアウトすることはありません。

例

```yaml
runner:
  idle_timeout: 1h
```

[#runner-disable-auto-update]
=== runner.disable_auto_update
`$DISABLE_AUTO_UPDATE`

このパラメーターにより、ローンチエージェントによる自動更新が無効になり、 CircleCI への新しいバージョンの確認要求を停止します。 バージョンが固定されるサーバーでは、このパラメーターは`true`に設定することをお勧めします。

注: このパラメーターを設定すると、セルフホストランナーが手動でアップグレードされ、新機能、セキュリティーに関するアップデート、及びバグの修正点を受け取るようになります。

[#runner-ssh-advertise-addr]
=== runner.ssh.advertise_addr
`$LAUNCH_AGENT_RUNNER_SSH_ADVERTISE_ADDR`

このパラメータにより、「SSH でジョブを再実行する」ことが可能になります。 Before enabling this feature, there are <<#considerations-before-enabling-ssh-debugging, *important considerations*>> that should be made. Rerun with SSH is not currently available on container runner.

アドレスは、 `*host:port*` という形式で、再実行されたジョブの [Enable SSH (SSHを有効にする)] および [Wait for SSH (SSHを待機する)] セクションに表示されます。

NOTE: While the presence of the `runner.ssh.advertise_addr` variable enables the “Rerun job with SSH” feature, the value it holds is for publishing purposes only in the web app. The address does not need to match the actual host and port of the machine that the self-hosted runner is installed on, and can be a proxy configuration.

例

```yaml
runner:
  ssh:
    advertise_addr: HOSTNAME:54782
```

[#considerations-before-enabling-ssh-debugging]
==== SSH デバッグを有効にする前に注意すべき事項

Task-agent runs an embedded SSH server and agent on a dedicated port when the “Rerun job with SSH” option is activated. この機能は、セルフホストランナーがインストールされているシステム上の他の SSH サーバーやエージェントには影響しません。

* SSH サーバーが使用するホストポートは、現在、`*54782*`に固定されています。 このポートがブロックされておらず、SSH 接続が可能であることを確認してください。 A port conflict can occur if multiple machine runners are installed on the same host.
* The SSH server will inherit the same user privileges and associated access authorizations as the task-agent, defined by the <<#runner-command_prefix, runner.command_prefix parameter>>.
* SSH サーバーは、公開キーの認証に設定されます。 ジョブを開始する権限をもつユーザーは誰でも SSH でそのジョブを再実行することができます。 ただし、 SSH セッション中は、再実行を開始したユーザーだけが SSH 公開キーをサーバに追加できます。
* SSH でジョブを再実行すると、キャンセルされない限り、SSH サーバーに接続されていると *2時間* 、接続されない場合は *10分間* 、ジョブがオープンな状態になります。 While in this state, the job is counted against an organization’s concurrency limit, and the task-agent will be unavailable to handle other jobs. そのため、デバッグが終了したら、SSH の再実行ジョブを明示的に（Web UI または CLI を通じて）キャンセルすることをお勧めします。

[#basic-full-configuration-for-machine-runner]
=== Basic full configuration for a machine runner

セルフホストランナーを使って実行するジョブについて、以下のフィールドを指定します。

* `machine: true`
* `resource_class: <namespace>/<resource-class>`

Simple example of how you could set up a job:

```yaml
version: 2.1

workflows:
  build-workflow:
    jobs:
      - runner
jobs:
  runner:
    machine: true
    resource_class: <namespace>/<resource-class>
    steps:
      - run: echo "Hi I'm on Runners!"
```

この設定ファイルを VCS プロバイダーにプッシュすると、セルフホストランナーを使ってジョブが実行されます。