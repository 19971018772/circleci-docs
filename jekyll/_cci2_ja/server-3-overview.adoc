---
description: CircleCI Server v3.x は、GCP または AWS の Kubernetes クラスタにインストールできる継続的インテグレーション / 継続的デリバリー (CI/CD) プラットフォームです。
version:
- Server v3.x
- サーバー管理者
---
= CircleCI Server v3.x の概要
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

toc::[]

== はじめに

CircleCI Server は、コンプライアンスやセキュリティ上のニーズからファイアウォール内やプライベートクラウド、データセンターでの運用が求められる企業向けのオンプレミス型 CI/CD プラットフォームです。 

Server provides the same features as CircleCI’s cloud offering, but operates within your Kubernetes cluster. 

.CircleCI Server v3.x のアーキテクチャ
image::server-3-architecture-diagram.png[サービスs Architecture]

The CircleCI server application exposes four services, using load balancers. Three of these load balancers are VPC (Virtual Private Cloud)-internal for connecting to the Nomad cluster and virtual machines. If required, the front-end load balancer can be made private, separating it from the public internet. 詳細については、 https://circleci.com/docs/2.0/server-3-operator-load-balancers/[ロード バランサーに関するページ] を参照してください。

[.table.table-striped]
[cols=4*, options="header", stripes=even]
|===
| ロード バランサー
| タイプ
| ポート
| 説明

| フロントエンド GUI プロキシおよび API
| 外部
| 80、443
| Web アプリケーションを公開する

| Nomad コントロール プレーン
| 内部
| 4647
| Nomad ランナーの RPC プロトコルを公開する

| 出力プロセッサ
| 内部
| 8585
| Nomad ランナーの出力を取り込む

| VM サービス
| 内部
| 3000
| 仮想マシンをプロビジョニングする
|===

このアプリケーションでは、いくつかの外部ポートが公開されています。 これらのポートは、以下の表に記載されている様々な機能に使用されます。 

[.table.table-striped]
[cols=6*, options="header", stripes=even]
|===
| ポート番号
| プロトコル
| 方向
| 送信元/送信先
| 使用
| 備考

| 80
| TCP
| インバウンド
| エンド ユーザー
| HTTP Web アプリ トラフィック
|

| 443
| TCP
| インバウンド
| エンド ユーザー
| HTTP Web アプリ トラフィック
|

| 8800
| TCP
| インバウンド
| 管理者
| 管理者コンソール
|

| 22
| TCP
| インバウンド
| 管理者
| SSH
| 踏み台ホストでのみ必要.

| 64535 ～ 65535
| TCP
| インバウンド
|
| ビルドへの SSH 接続
| Nomad クライアントでのみ必要
|===

CircleCI Server では、 https://www.nomadproject.io/[Nomad] スケジューラを使用して CI ジョブのスケジュールを設定します。 The Nomad control plane runs inside of Kubernetes, while the Nomad clients, which are responsible for running scheduled CircleCI jobs, are provisioned outside the cluster. CircleCI Server では、Nomad クライアント自体または専用の仮想マシン (VM) で Docker ジョブを実行できます。

ジョブのアーティファクトと出力は、Nomad ジョブからオブジェクト ストレージ (S3、GCS、またはその他のサポートされているオプション) に直接送信されます。 オブジェクト ストレージには、監査ログやアプリケーションのその他のアイテムも保存されます。そのため、Kubernetes クラスタと Nomad クライアントの両方がオブジェクト ストレージにアクセスできる必要があります。

== サービス

CircleCI Server 3.0 は、以下のサービスで構成されています。 それぞれの説明と、各サービスで障害が発生した場合の影響を以下に示します。

[.table.table-striped]
[cols=5*, options="header", stripes=even]
|===
| Service
| コンポーネント
| 説明
| 障害発生時の影響
| 備考

| api-service
| アプリコア
| Provides a GraphQL API that provides data to render the web frontend.
| Many parts of the UI (such as Contexts) will fail completely.
|

| audit-log-service
| アプリコア
| Persists audit log events to blob storage for long-term storage.
| 一部のイベントが記録されなくなります。
|

| builds-service
| アプリコア
| www-api から取り込みを行い、plans-service、workflows-conductor、orbs-service に送信します。
|
|

| circleci-mongodb
| 実行
| プライマリ データストア
|
|

| circleci-postgres
| マイクロサービス用データ ストレージ
|
|
|

| circleci-rabbitmq
| パイプラインと実行
| ワークフロー メッセージ、テスト結果、使用状況、cron、出力、通知、スケジューラーのキュー.
|
|

| circleci-redis
| 実行
| Caches data that will not be stored permanently (such as build logs), for request caching, and for rate limit calculations.
| A failed cache can result in rate limiting from the VCS if too many calls are made to it.
|

| circleci-telegraf
|
| Telegraf は StatsD メトリクスを収集します。 All white-boxed metrics in our services publish statsd metrics that are sent to telegraf,
but can also be configured to be exported to other places (such as Datadog or Prometheus).
|
|

| circleci-vault
|
| シークレット用にサービスとしての暗号化と復号化を実行する HashiCorp Vault.
|
|

| config
|
|
|
|

| contexts-service
| アプリ コア
| 暗号化されたコンテキストを保存、提供します。
| コンテキストを使用するすべてのビルドに失敗するようになります。
|

| cron-service
| パイプライン
| スケジュールされたワークフローをトリガーします。
| スケジュールされたワークフローが実行されなくなります。
|

| dispatcher
| 実行
| ジョブをタスクに分割し、実行用にスケジューラーに送信します。
| No jobs will be sent to Nomad. The run queue will increase in size, but there should be no meaningful loss of data.
|

| domain-service
| アプリ コア
| CircleCI ドメイン モデルに関する情報を保存、提供します。 Works with permissions and API.
| Workflows will fail to start and some REST API calls may fail, causing 500 errors in the CircleCI UI. LDAP 認証を使用している場合、すべてのログインに失敗するようになります。
|

| exim
|
| 一般公開時には削除されます。ただしユーザーは削除後も既存の MTA にメール送信用の認証情報を提供することができます。
| メール通知が送信されなくなります。
|

| frontend
| フロントエンド
| CircleCI Web アプリと www-api プロキシ
| UI と REST API が利用できなくなります。GitHub/GitHub Enterprise からジョブがトリガーされなくなります。 Running builds will be OK, but no updates will be seen.
| 1 秒あたりのリクエスト レート上限は 150、ユーザー 1 人あたりの瞬間リクエスト レート上限は 300 です。 

| inject-bottoken
|
| "ボット トークン" を MongoDB に挿入する Kubernetes ジョブ。 ボット トークンは、サービス間通信用の認証トークンです。		
|
| 主に www-api で使用されます。

| kotsadm-kots
| ライセンス
| メインの KOTS アプリケーション。 Runs the KOTS Admin Console, where upgrades and server configuration take place.
| CircleCI Server のアップグレードと設定が行えなくなります。
管理者コンソールは使用できません。
|

| kotsadm-migrations
| ライセンス
| Kotsadm の更新に合わせてデータベースの移行を行います。
|
|

| kotsadm-minio
| ライセンス
| KOTS ライセンス用のオブジェクトストレージ
|
|

| kotsadm-postgres
| ライセンス
| KOTS ライセンス用のデータベース
|
|

| legacy-notifier
| アプリ コア
| Handles notifications to external services (for example, Slack or email).
|
|

| prometheus
| Server
| メトリクスに使用します。
|
|

| orb-service
| パイプライン
| Orb レジストリと設定ファイルの間の通信を処理します。
|
|

| output-processor
| 実行
| Receives job output and status updates and writes them to MongoDB. また、キャッシュとワークスペースにアクセスし、キャッシュ、ワークスペース、アーティファクト、テスト結果を保存するための API を実行中のジョブに提供します。
|
|

| permissions-service
| アプリ コア
| CircleCI のアクセス権インターフェイスを提供します。
| ワークフローを開始できなくなります。 一部の REST API 呼び出しに失敗し、CircleCI UI で 500 エラーが発生する可能性があります。
|

| scheduler
| 実行
| 受信したタスクを実行します。 Nomad サーバーと連携しています。
| No jobs will be sent to Nomad. The run queue will increase in size, but there should be no meaningful loss of data.
|

| slanger
| server
| CircleCI アプリにリアルタイム イベントを提供します。
| Live UI updates will stop, but hard refreshes will still work.
|

| test-results
| 実行
| テスト結果ファイルを解析してデータを保存します。
| ジョブについてテストの失敗やタイミングのデータが生成されなくなります。 サービスが再起動するとバックフィルが行われます。
|

| vm-gc
| コンピューティング管理
| Periodically checks for stale machine and remote Docker instances and requests that vm-service remove them.
| このサービスを再起動するまで、古い vm-service インスタンスが破棄されなくなる可能性があります。
|

| vm-scaler
| マシン
| マシンとリモート Docker ジョブの実行用にプロビジョニングするインスタンス数を増やすように、vm-service に定期的にリクエストします。
| VM instances for machine and Remote Docker might not be provisioned, causing you to run out of capacity to run jobs with these executors.
| Different overlay for EKS versus GKE.

| vm-service
| マシン
| 利用可能な vm-service インスタンスのインベントリ管理と、新しいインスタンスのプロビジョニングを行います。
| マシンまたはリモート Docker を使用するジョブが失敗するようになります。
|

| workflows-conductor-event-consumer
| パイプライン
| パイプラインを実行するために VCS から情報を取得します。
| VCS に変更があっても、新しいパイプラインが実行されなくなります。
|

| workflows-conductor-grpc-handler
| パイプライン
| gRPC 経由での情報の変換を支援します。
|
|

| web-ui-*
| フロントエンド
| フロントエンド Web アプリケーションの GUI のレンダリングに使用するマイクロ フロントエンド (MFE) サービスです。
| 各サービス ページを読み込むことができなくなります。 たとえば、web-ui-server-admin で障害が発生した場合、CircleCI Server の管理者ページを読み込めなくなります。
| The MFEs are used to render the web application located at app.<my domain here>

|===

== プラットフォーム 
CircleCI Server は、Kubernetesクラスタ内でのデプロイを想定しています。 仮想マシンサービス（VMサービス）により、独自の EKS や GKE を活用して VM イメージを動的に作成することができます。 

If installing outside of EKS or GKE, additional work is required to access some of the same machine build features. Setting up CircleCI runners gives you access to the same feature set as VM service across a much wider range of OSs and machine types (MacOS and much more). 

CircleCI では、インストールするプラットフォームを幅広くサポートできるよう最善を尽くしています。 We use environment-agnostic solutions wherever possible. ただし、すべてのプラットフォームやオプションをテストしているわけではありません。 For that reason, we provide a list of tested environments, which we will continue to expand. 定期的にテストし、サポートするプラットフォームのリストに OpenShift を追加する予定です。 

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
| 環境
| 状態
| 備考

| EKS 
| テスト済み
|

| GKE 
| テスト済み
|

| Azure
| テスト未実施
| Should work with Minio Azure gateway and Runner.

| Digital Ocean
| テスト未実施 
| Should work with Minio Digital Ocean gateway and Runner.

| OpenShift
| テスト未実施
| 動作しないことが分かっています。

| Rancher
| テスト未実施 
| Should work with Minio and Runner.
|===

ifndef::pdf[]
== 次に読む

* https://circleci.com/docs/ja/2.0/server-3-whats-new[CircleCI Server 3.x の新機能]
* https://circleci.com/docs/ja/2.0/server-3-install-prerequisites[Server 3.x インストールの前提条件]
* https://circleci.com/docs/ja/2.0/server-3-install-migration[CircleCI Server 3.x への移行]
endif::pdf[]
