---
version:
- Server v3.x
- サーバー管理
---
= CircleCI Server v3.x 内部データベースボリュームの拡張
:page-layout: classic-docs
:imagesdir: ../assets/img/docs/
:page-liquid:
:icons: font
:toc: macro
:toc-title:

toc::[]

== 概要
_Persistent volume expansion of MongoDB and Postgres is available for server v3.2.0 and higher._

If you have chosen to deploy either of the CircleCI databases (MongoDB or Postgres) within the cluster, rather than externally provisioning these databases, there may come a point at which the storage space initially made available to these databases is no longer sufficient. Kubernetes クラスタの内部データベースでは、永続的なストレージとして https://kubernetes.io/docs/concepts/storage/persistent-volumes/[永続ボリューム] を利用しています。 ボリュームのサイズは、PVC（永続ボリューム要求）によって決定されます。 この PVC は、クラスタ内の Node に使用できる容量に基づいてストレージスペースを要求します。 

ここでは、内部でデプロイしたデータベース用のスペースを増やすために PVC を増やす手順を説明します。 この操作には、データベースポッドを再起動する必要がない限り、ダウンタイムは生じません。

NOTE: 永続ボリュームを拡張しても、Node に接続されているストレージのサイズには影響しません。 Node ストレージの拡張は、ご使用のクラウドプロバイダーの制限範囲内で可能です。 クラスタの Node に接続されたストレージを拡張する方法の詳細については、ご使用のクラウドプロバイダーのドキュメントを参照してください。


== 永続ボリューム要求のサイズ変更
ここでは Postgres と MongoDB の 永続ボリューム要求のサイズを変更する方法を説明します。 You will confirm the size of the claims and the disk space made available to your databases before and after this operation.

NOTE: As a precaution, it is always a good idea to https://circleci.com/docs/2.0/server-3-operator-backup-and-restore/?section=server-administration[create a backup of your cluster] first.


=== ステップ 0: 現在のボリュームサイズの確認
デフォルトでは、内部のデータベースが使用する永続ボリューム要求の容量は 8Gi です。 ただし、この初期値は最初のデプロイ時に KOTS 管理者コンソールから設定できます。 You can confirm the size of your persistent volume claim capacity using the command: `kubectl get pvc <pvc-name>`.

For Postgres:
[source,bash]
----
circleci-user ~ $ kubectl get pvc data-postgresql-0
NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
data-postgresql-0   Bound    pvc-c2a2d97b-2b7d-47d3-ac77-d07c76c995a3   8Gi        RWO            gp2            1d
----

For MongoDB:
[source,bash]
----
circleci-user ~ $ kubectl get pvc datadir-mongodb-0
NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
datadir-mongodb-0   Bound    pvc-58a2274c-31c0-487a-b329-0062426b5535   8Gi        RWO            gp2            1d
----

You can also confirm this capacity is made available to a database by checking the size of its data directory.

For Postgres, the directory is `/bitnami/postgresql`. You can confirm its size using the command below.

[source,bash]
----
circleci-user ~ $ kubectl exec postgresql-0 -- df -h /bitnami/postgresql
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme4n1    7.8G  404M  7.4G   3% /bitnami/postgresql
----

For MongoDB, the directory is `/bitnami/mongodb`.
[source,bash]
----
circleci-user ~ $ kubectl exec mongodb-0 -- df -h /bitnami/mongodb
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme1n1    7.8G  441M  7.4G   3% /bitnami/mongodb
----

上記の例では、容量は 8Gi のままです。 次のステップで、これを 10 Gi に増やす方法を紹介します。

=== ステップ 1: ボリュームの拡張が可能かどうかを確認する
まず、クラスタでボリューム拡張が許可されていることを確認します。

[source,bash]
----
circleci-user ~ $ kubectl get sc
NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  1d
----

As you can see, your default storage class does not allow volume expansion. However, you can change this with the `kubectl patch` command:

[source,bash]
----
circleci-user ~ $ kubectl patch sc gp2 -p '{"allowVolumeExpansion": true}'
storageclass.storage.k8s.io/gp2 patched
circleci-user ~ $ kubectl get sc
NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   true                  1d
----

Now you may proceed to expanding your volumes.

=== ステップ 2: データベースのステートフルセットを削除する
In this step, you will delete the stateful set, which controls your database pod. The command below deletes the referenced database's stateful set without deleting the pod. You do not want to delete the pod itself, as this would cause downtime. In the following steps, you will redeploy your stateful set. ボリュームを拡張するデータベースによって、どちらか一方または両方のステートフルセットを削除します。 ここでは、 `--cascade=false` フラグが最も重要です。

For Postgres:
[source,bash]
----
kubectl delete sts postgresql --cascade=false
----

For MongoDB:
[source,bash]
----
kubectl delete sts mongodb --cascade=false
----

=== ステップ 3: データベースの PVC サイズを更新する
Now that the stateful set has been removed, you can increase the size of our persistent volume claim to 10Gi.

For Postgres:
[source,bash]
----
kubectl patch pvc data-postgresql-0 -p '{"spec": {"resources": {"requests": {"storage": "10Gi"}}}}'
----

For MongoDB:
[source,bash]
----
kubectl patch pvc datadir-mongodb-0 -p '{"spec": {"resources": {"requests": {"storage": "10Gi"}}}}'
----

=== ステップ 4: KOTS 管理者コンソールを新しい PVC サイズに更新する
Now you need to access the KOTS Admin Console to persist your changes. In the config section, you will update the values for your PVC size to 10Gi as shown below.

.Postgres の場合:
image::kots-pg-pvc-size.png[Postgres PVC size]

.Mongodbの場合:
image::kots-mongo-pvc-size.png[MongoDB PVC size]

変更内容を保存し、デプロイします。 This recreates the stateful set(s) that you destroyed earlier, but with the new PVC sizes, which will persist through new releases.


=== ステップ 5: 新しいボリュームサイズを検証する
Once deployed, you can validate the size of the data directories assigned to our databases.

For Postgres the directory is `/bitnami/postgresql`.
[source,bash]
----
circleci-user ~ $ kubectl exec postgresql-0 -- df -h /bitnami/postgresql
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme4n1    9.8G  404M  9.4G   5% /bitnami/postgresql
----

For MongoDB the directory is `/bitnami/mongodb`.
[source,bash]
----
circleci-user ~ $ kubectl exec mongodb-0 -- df -h /bitnami/mongodb
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme1n1    9.8G  441M  9.3G   5% /bitnami/mongodb
----

As you can see, the size of your directories has been increased.

When completing these steps, if you find, as expected, that the new pods _do_ show the resized volumes, it is still worth checking with the `kubectl describe` commands shown below. In some instances the resize will fail, but the only way to know is by viewing an event in the output from `kubectl describe`.

For Postgres:
[source,bash]
----
kubectl describe pvc data-postgresql-0
----

For MongoDB:
[source,bash]
----
kubectl describe pvc datadir-mongodb-0
----

成功すると、以下の例のように出力されます。
```
Events:
Type    Reason                      Age   From     Message

Normal  FileSystemResizeSuccessful  19m   kubelet  MountVolume.NodeExpandVolume succeeded for volume "pvc-b3382dd7-3ecc-45b0-aeff-45edc31f48aa"
```

失敗すると、以下の例のように出力されます。
```
Warning  VolumeResizeFailed  58m   volume_expand  error expanding volume "circleci-server/datadir-mongodb-0" of plugin "kubernetes.io/aws-ebs": AWS modifyVolume failed for vol-08d0861715c313887 with VolumeModificationRateExceeded: You've reached the maximum modification rate per volume limit. Wait at least 6 hours between modifications per EBS volume.
status code: 400, request id: 3bd43d1e-0420-4807-9c33-df26a4ca3f23
Normal   FileSystemResizeSuccessful  55m (x2 over 81m)  kubelet        MountVolume.NodeExpandVolume succeeded for volume "pvc-29456ce2-c7ff-492b-add4-fcf11872589f"
```

== トラブルシューティング

After following these steps, if you find that the disk size allocated to your data directories has not increased, then you may need to restart your database pods. This will cause downtime of 1-5 minutes while the databases restart. 以下のコマンドでデータベースを再起動することができます。

For Postgres:
[source,bash]
----
kubectl rollout restart sts postgresql
----

For MongoDB:
[source,bash]
----
kubectl rollout restart sts mongodb
----



