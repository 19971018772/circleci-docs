---

description: このドキュメントでは、Terraform を使って CircleCI Server v2.x をインストールする方法を順を追って説明します。
version:
- Server v2.x
---

[#install]
= Terraformを使って AWS にインストールする方法


:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

Terraform を使って CircleCI Server v2.x をインストールする手順は以下のとおりです。

toc::[]

== Terraform の変数を定義する

.  https://github.com/circleci/enterprise-setup[Setup] リポジトリをクローンします。 すでにクローンを作成している場合は、クローンが最新であり、メインブランチにいることを確認するために、下記を実行します。
+
git checkout main && git pull
. ローカルマシンの enterprise-setup リポジトリの一番上のディレクトリに移動します。
. terraform init を実行して、作業ディレクトリを初期化します。
. make init を実行し、terraform.tfvars ファイルを初期化します (既に terraform.tfvars が存在する場合、同じディレクトリにバックアップされます)。
. エディターで terraform.tfvars を開き、1. に適切な AWS 値を入力します。
. 1.0 Builder を使用する場合は、 2. で circle_secret_passphrase を指定し、 `...` を英数字に置き換えますが、1.0 Builder を使用しない場合はそのままにしておきます。1.0 Builder は、3. のデフォルト設定で無効になっています。
. Nomad クライアントのインスタンスタイプを指定します。 デフォルトでは、Nomad クライアント用の terraform.tfvars ファイルの値は m5.2xlarge (vCPU 8 基、RAM 32 GB)です。 各 Nomad クライアントが同時に実行できる CircleCI ジョブの数を増やすには、terraform.tfvars ファイルの 2. で nomad_client_instance_type の値を大きくします。 詳細については、AWSの https://aws.amazon.com/ec2/instance-types[Amazon EC2 Instance Types] ガイドを参照し、CircleCIドキュメントの <<server-ports#nomad-clients,System Requirements>> をお読みください。
+
NOTE: builder_instance_type は、CircleCI 1.0 でのみ使用され、3. ではデフォルトで無効になっています。
. 3.では、以下が可能です。
.. プロジェクトで必要な場合は、カウントを 1 に変更して 1.0 Builder の使用を選択する。
.. プロキシの詳細を入力し、AWS リージョン内に複数のインストールがある場合は、プレフィックスを入力する。Services および Nomad クライアントのインスタンスは、AWS コンソールではこのプレフィックスで表示されます。

.tfvars の例
#####################################
# 1. 必要なクラウド設定
#####################################

aws_access_key = "..." aws_secret_key = "..." aws_region = "eu-central-1"
aws_vpc_id = "..." aws_subnet_id = "..." aws_ssh_key_name = "..."

#####################################
# 2. 必要な CircleCI の設定
#####################################

circle_secret_passphrase = "..." services_instance_type = "m4.2xlarge"
builder_instance_type = "r3.4xlarge"
nomad_client_instance_type = "m4.2xlarge"

#####################################
# 3. オプションのクラウド設定
#####################################

# Set this to `1` or higher to enable CircleCI 1.0 builders
desired_builders_count = "0"

# Provide proxy address if your network configuration requires it
http_proxy = ""
https_proxy = ""
no_proxy = ""

# Use this var if you have multiple installation within one AWS region
prefix = "..."

Above is an example of the `terraform.tfvars` file you will be editing. 下記の表では、デフォルト設定と、クラスタを更にカスタマイズする際に使用できるオプションの変数を紹介します。 A full list of variables and defaults can be found in the `variables.tf` file in the root of the `enterprise-setup` directory.

TIP: If you require your installation to work on AWS GovCloud, you can enable this by setting `enable_govcloud` to `true`.

変数のオプション


[.table.table-striped]
[cols=3*, options="header", stripes=even]
[cols="3,3,2"]
|===
|変数 |説明 |デフォルト値

|services_instance_type
|一元管理されたサービスボックスのインスタンスタイプです。  m4 インスタンスを推奨します。
|m4.2xlarge

|builder_instance_type
|1.0 Builder マシンのインスタンスタイプです。  r3 インスタンスを推奨します。
|r3.2xlarge

|max_builders_count
|1.0 Builder の最大数です。
|2

|nomad_client_instance_type
|Nomad クライアント (2.0 Builder) のインスタンスタイプです。 XYZ インスタンスを推奨します。
|m4.xlarge

|max_clients_count
|Nomad クライアントの最大数です。
|2

|プレフィックス
|リソース名のプレフィックスです。
|circleci

|enable_nomad
|CircleCi Server v2.x 用の Nomad クラスタをプロビジョニングします。
|1

|enable_route
|Services ボックスの Route53 ルートの作成を有効にします。
|0

|enable_govcloud
|AWS GovCloud へのデプロイを許可します。
|false

|services_user_data_enabled
|Services ボックスへの自動インストールを無効にするには、0 に設定します。
|1

|force_destroy_s3_bucket
|インストールのシャットダウン時に S3 バケットを強制的に破棄する機能を追加/削除します。
|false

|services_disable_api_termination
|API の終了から Services インスタンスを保護します。 インストールのシャットダウン時に Services ボックスを自動的に終了させたい場合は、false に設定してください。
|true
|===

== インスタンスのプロビジョニング

. Save your changes to the `tfvars` file and run the following:
+
terraform plan
. インスタンスのプロビジョニングを行うために、以下を実行します。
+
terraform apply
+
You will be asked to confirm if you wish to go ahead by typing `yes`.
. Terraform の出力の最後に IP アドレスが提供されます。 この IP にアクセスして、インストール作業を進めてください。
+
// explain what to do if this step fails

== CircleCI へのアクセス

. ブラウザ上に、SSL/TLS の情報ボックスが表示される場合があります。 これは、次の画面でブラウザが管理コンソールへの接続が安全でないことを通知する場合があることを知らせるためのものですが、安全ですのでご安心ください。 [Continue to Setup] をクリックして、インストール先の IP に進みます。
+
.SSL セキュリティ
image::browser-warning.png[SSL Security]
. ホストネームを入力します。 ここではドメイン名または Servives マシンのインスタンスのパブリック IP を指定します。 この時、SSL公開キーと証明書があればアップロードすることも可能です。 これらを入力せずに進む場合は、[Use Self-Signed Cert ] をクリックします。
このオプションを選択すると、管理コンソールにアクセスするたびにセキュリティに関する警告が表示されます。
+
.ホスト名
image::secure-management-console.png[Hostname]
. ライセンスをアップロードします。
. 管理コンソールのセキュリティを保護する方法を設定します。 選択肢は以下の 3 つです。
.. 匿名の管理者によるコンソールへのアクセスを許可。ポート 8800 上の誰でもアクセスが可能です（非推奨）。
.. 管理者コンソールに安全にアクセスできるようパスワードを設定 (推奨)。
.. 既存のディレクトリベースの認証システム (LDPAなど) を使用。
+
.管理者パスワード
image::admin-password.png[Secure the Management Console]
. CircleCI に対して一連の事前チェックが行われます。完了したら、下にスクロールして [Continue] をクリックします。
+
//what should admins do if not all these checks pass
+
.事前チェック
image::preflight.png[Preflight Checks]

== インストールの設定

管理コンソールの設定ページ (your-circleci-hostname.com:8800) が表示されます。

WARNING: You can make changes to the settings on this page at any time but changes here will require *downtime* while the service is restarted. 一部の設定については、「運用ガイド」で詳しく説明しています。

. **Hostname** – The Hostname field should be pre-populated from earlier in the install process, but if you skipped that step, enter your domain or public IP of the Services machine instance. [Test Hostname Resolution] をクリックすると、正確に入力されているか確認できます。
. **Services** – The Services section is only used when externalizing services. 外部化は Platinum サービス契約のお客様のみご利用いただけます。 Contact support@circleci.com if you would like to find out more.
+
.外部サービス
image::hostname-services.png[Hostname and Services Settings]
. **Execution Engines** – only select 1.0 Builders if you require them for a legacy project – most users will leave this unchecked.
. **Builders Configuration** – select Cluster in the 2.0 section. シングルボックス オプションは、専用のインスタンスではなく Services マシン上でジョブを実行するため、システムの試用や小規模なチームにのみ適しています。
+
.1.0 / 2.0 Builder
image::builders.png[Execution Engine]
. **GitHub Integration** – register CircleCI as a new OAuth application in GitHub.com or GitHub Enterprise by following the instructions provided on the page.
+
NOTE: 「Unknown error authenticating via GitHub. Try again, or contact us." message, try using `http:` instead of `https:` for the Homepage URL and callback URL.
.. GitHub から Client ID と Secret をコピーして、該当するフィールドにペーストし、[Test Authentication] をクリックします。
.. GitHub.com をご利用の場合は、ステップ 6 に進みます。 Github Enterprise をご利用の場合は、いくつかの追加手順を行い、API トークンを提供していただき、お客様の組織を確認する必要があります。 トークンを提供するには、GitHub Enterprise のダッシュボードから以下を実行してください。
... Navigate to Personal Settings (top right) > Developer Settings > Personal Access Tokens.
... [generate new token] をクリックします。 誤って削除されないように、トークンには適切な名前を付けてください。 チェックボックスには何もチェックを入れないでください。ここでは、デフォルトのパブリックな読み取りレベルのアクセスが必要なだけで、追加のアクセス権限は必要ありません。 このトークンは一人のユーザーが所有するのではなく、組織全体で共有することをお勧めします。
... 新しいトークンをコピーして、GitHub Enterprise Default API Token フィールドに貼り付けます。
+
.Github Enterprise Token を入力します。
image::ghe_token.png[Github Integration]
. **LDAP** – if you wish to use LDAP authentication for your installation, enter the required details in the LDAP section. For a detailed runthrough of LDAP settings, read our https://circleci.com/docs/2.0/authentication/#ldap[LDAP authentication guide]
. **Privacy**: インストールには SSL 証明書と SSL キーの使用をお勧めします。 インストールの際にこのステップを行わなかった場合は、この Privacy のセクションでこれらの情報を提出することができます。
+
.プライバシーの設定
image::privacy.png[]
. **Storage** – We recommend using S3 for storage and all required fields for Storage are pre-populated. The IAM user, as referred to in the <<aws-prereq#planning,planning>> section of this document, is used here.
+
.ストレージのオプション
image::storage.png[]
. **Enhanced AWS Integration** – Complete this section if you are using 1.0 builders.
+
// explain enhanced AWS integration 1.0 or just say ignore
. **Email** Complete the Email section if you wish to configure your own email server for sending build update emails. デフォルトのメールサーバーを使用する場合は、入力しません。
+
NOTE: サードパーティツールの Replicated の問題により、現在 Test SMTP Authentication ボタンは動作していません。
. **VM Provider** – Configure VM service if you plan to use https://circleci.com/docs/2.0/building-docker-images/[Remote Docker] or `machine` executor (Linux/Windows) features. We recommend using an IAM instance profile for authentication, as described in the <<aws-prereq#planning,planning>> section of this document. With this section completed, instances will automatically be provisioned to execute jobs in Remote Docker or use the `machine` executor. To use the Windows `machine` executor you will need to https://circleci.com/docs/2.0/vm-service/#creating-a-windows-ami[build an image]. For more information on VM Service and creating custom AMIs for remote Docker and `machine` executor jobs, read our https://circleci.com/docs/2.0/vm-service/#section=server-administration[VM service guide].
+
You can preallocate instances to always be up and running, reducing the time taken for Remote Docker and `machine` executor jobs to start. 事前割り当てが設定されている場合、cron ジョブが 1日に1回、事前割り当てされたインスタンスを回し、不良/デッド状態になることを防ぎます。
+
CAUTION: If Docker Layer Caching (DLC) is to be used, VM preallocation should be set to `0`, forcing containers to be spun up on-demand for both `machine` and Remote Docker. It is worth noting here that if these fields are **not** set to `0` but all preallocated instances are in use, DLC will work correctly, as if preallocation was set to `0`.
. **AWS Cloudwatch or Datadog Metrics** can be configured for your installation. 該当するセクションでどちらかのメトリクスを設定します。 For more information read our https://circleci.com/docs/2.0/monitoring/[Monitoring guidance]:
+
.メトリクス
image::metrics_setup.png[]
. **Custom Metrics** are an alternative to Cloudwatch and Datadog metrics, you can also customize the metrics you receive through Telegraf. For more on this read our https://circleci.com/docs/2.0/monitoring/#custom-metrics[Custom Metics] guide.
. **Distributed Tracing** is used in our support bundles, and settings should remain set to default unless a change is requested by CircleCI Support.
. **Artifacts** persist data after a job is completed, and may be used for longer-term storage of your build process outputs. CircleCI Server v2.x では、承認されたタイプのアーティファクトのみがデフォルトで利用可能です。 これは、ユーザーが悪意のあるコンテンツをアップロードおよび実行してしまう事態を防ぐための措置です。 The **Artifacts** setting allows you to override this protection. For more information on safe/unsafe types read our https://circleci.com/docs/2.0/build-artifacts/[Build Artifacts guidance].
. 使用許諾契約に同意し、設定を保存した後、ポップアップから [Restart Now (今すぐ再起動)]を選択します。 その後、CircleCI を起動し、管理コンソールのダッシュボードを表示するようにリダイレクトされます。 必要なDockerコンテナすべてをダウンロードするため、数分間が必要です。

NOTE: If the Management Console reports `Failure reported from operator: no such image` click Start again and it should continue.

== インストールの検証

. アプリケーションが起動したら、ブラウザで [Open] を選択して CircleCI を起動し、CircleCI にサインアップ/ログインして、2.0 ビルドの実行を開始します ! この時点では最初にサインインしたお客様が管理者になります。 Have a look at our https://circleci.com/docs/2.0/getting-started/#section=getting-started[Getting Started] guide to start adding projects.
+
//<!--add info on making users administrators etc. to user management section of ops guide and put a link here-->
+
.ダッシュボードから CircleCI を起動する
image::dashboard.png[]
. ビルドコンテナが起動してイメージがダウンロードされると、すぐに最初のビルドを開始します。 If there are no updates after around **15 minutes**, and you have clicked the Refresh button, contact https://support.circleci.com/hc/en-us[CircleCI support] for assistance.
. Next, use https://github.com/circleci/realitycheck[our realitycheck repo] to check basic CircleCI functionality.
. If you're unable to run your first builds successfully please start with our https://circleci.com/docs/2.0/troubleshooting[Troubleshooting] guide for general troubleshooting topics, and our https://circleci.com/docs/2.0/nomad[Introduction to Nomad Cluster Operation] for information about how to check the status of Builders in your installation.