---

description: Open preview of container runner
version:
- Cloud
---
= Container runner open preview
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

こちらは、**オープンプレビュー**でご利用いただけるようになった、CircleCI の新しいタイプのセルフホストランナーに関するドキュメントです。

[#introduction-and-motivation]
== 概要と経緯

CircleCI’s <<runner-overview#,self-hosted runner>> has historically executed each job using a one to one mapping between the CI job and a <<configuration-reference#machine,machine>> environment (virtual or physical) that has the self-hosted runner binary installed on it. By exclusively running jobs in this manner, users sacrifice several benefits of a container-based solution that are afforded on CircleCI’s cloud platform when using the <<using-docker#,Docker executor>>:

* ジョブ実行時に、カスタム Docker イメージをシームレスに定義、パブリッシュ、使用する
* `.circleci/config.yml` のステップで依存関係を列挙せずに、カスタム Docker イメージを使って依存関係やライブラリを簡単に管理する
* Access to a consistent, clean containerized build environment with every job

Container runner is a technology now in open preview that a user can install in a Kubernetes (k8s) cluster which enables them to run containerized CI jobs on self-hosted compute, similar to how jobs that use the native Docker executor run on CircleCI’s cloud platform.

Container runner is a complement to the machine runner, not a replacement.

After installation of the container-agent binary, the container runner will claim your containerized jobs, schedule them within an ephemeral pod, and execute the work within a container-based execution environment.

.Container-agent model - Many container-agent : task-agents
image::container-runner-model.png[Container-agent model]

[#running-container-runner-first-job]
== Running your container runner's first job

WARNING: Use with caution as the product is still in a preview phase.

<<runner-installation#circleci-web-app-installation,Create>> a runner <<runner-concepts#namespaces-and-resource-classes,resource class>> and its associated resource class token. これは、CircleCI Web アプリまたは <<runner-installation-cli#,CircleCI CLI>> を使って行えます (CircleCI Web アプリを推奨)。

[#preqrequisites]
=== 前提条件

* Kubernetes 1.12 以上
* Helm 3.x
* ランナーのリソースクラストークン
* It is assumed that the container runner is running in a Kubernetes namespace without any other workloads, as it is possible that the runner or garbage collection (GC) could delete jobs in the same namespace.
* `checkout` ステップで、SSH でチェックアウトするように git が設定されていること。 これを使用する場合は、ポート 22 からのアウトバウンド接続を許可するようにクラスタが設定されていることを確認してください。

[#installing-the-helm-chart]
=== Install the Helm chart

NOTE: 以下の内容は、オープンプレビューの期間中に変更される可能性があります。

Install the Helm chart with the release name `container-agent`:

* Run `helm repo add circleci https://circleci-binary-releases.s3.amazonaws.com/charts/`
* Run `helm repo update`
* Run `helm install container-agent circleci/container-agent -n circleci` to install the chart.

This will deploy the container runner to the Kubernetes cluster as a release called `container-agent`. `helm show values circleci/container-agent` を実行するとデフォルト値を確認できます。これらを、以下の install コマンドに `--values` フラグまたは `--set name=value` フラグを指定することで上書きします。

[#update-values.yaml]
=== Update values.yaml

To run a job with no custom configuration, add the following configuration to the Helm chart `values.yaml`. `MY_TOKEN` is your runner resource class token. Update `namespace/my-rc` with your namespace and runner resource class.

```yaml
agent:
  resourceClasses:
    namespace/my-rc:
      token: MY_TOKEN
```

[#trigger-a-job]
=== Trigger a job

Once you have installed the container runner within your cluster, create and trigger a CircleCI job that uses the Docker executor to validate the installation.

- Within your `circleci/config.yml` file, use the <<using-docker#,Docker executor syntax>> combined with the resource class that you have included in the `resourceClasses` section of your container runner installation.
- Specifically, to route a job to be run using container runner within your cluster, update the resource class stanza to use the resource class that you created for container runner jobs.
+
```YAML
resource_class: <namespace>/<name-of-resource-class-created>
```

NOTE: **Do not** use an existing job that uses <<building-docker-images#,setup_remote_docker>> (see <<#building-container-images,Building container images>> section below for details).

設定ファイルを更新したら、ジョブが正常に実行されたかどうかを実際にトリガーして検証し、CircleCI Web アプリを使ってグリーンビルド (成功したビルド) であることを確認します。 一から始める場合は、 <<#sample-configuration-container-agent,FAQ セクション>> にあるサンプル設定を参照してください。

[#resource-class-configuration-custom-pod]
=== リソースクラスの設定とカスタマイズされたタスクポッドの設定

Container runner supports claiming and running tasks from multiple resource classes concurrently, as well as customization of the Kubernetes resources created to run tasks for a particular resource class. 設定は、Helm チャート `values.yaml` にあるマップオブジェクトによって提供されます。

各リソースクラスは、次のパラメーターをサポートしています。

- `token`: タスクを要求するために使用される、ランナーのリソースクラストークン (**必須**)
- CircleCI ジョブの実行に使用するポッド用のカスタマイズされた Kubernetes ポッド設定

このポッド設定は、通常の link:https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/#debugging[Kubernetes ポッド] 用のフィールドをすべて取得します。 サービスコンテナが CircleCI ジョブで使用される場合、最初の `container` 仕様が、タスクポッド内のすべてのコンテナに使用されます。 現在、サービスコンテナとメインタスクコンテナで異なるコンテナ設定を使用することはできません。

The following fields will be overwritten by container runner to ensure correct task function, and expected CircleCI configuration behavior:

- `spec.containers[0].name`
- `spec.containers[0].container.image`
- `spec.containers[0].container.args`
- `spec.containers[0].container.command`
- `spec.containers[0].container.workingDir`
- `spec.restartPolicy`
- `metadata.name`
- `metadata.namespace`

以下は、2 つのリソースクラスを使用した完全版の設定例です。

```yaml
agent:
  resourceClasses:
    circleci-runner/resourceClass:
      token: TOKEN1
      metadata:
        annotations:
          custom.io: my-annotation
      spec:
        containers:
          - resources:
              limits:
                cpu: 500m
            volumeMounts:
              - name: xyz
                mountPath: /path/to/mount
        securityContext:
          runAsNonRoot: true
        imagePullSecrets:
          - name: my_cred
        volumes:
          - name: xyz
            emptyDir: {}

    circleci-runner/resourceClass2:
      token: TOKEN2
      spec:
        imagePullSecrets:
          - name: "other"
```

[#parameters]
=== Helm チャートのパラメーター

以下は **CircleCI 固有の設定** です。

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
|パラメーター
|説明
|デフォルト

|agent.runnerAPI
|ランナー API の URL
|https://runner.circleci.com

|agent.name
|この特定の `container-agent` インスタンスに割り当てる名前 (できれば一意の名前)。 この名前は、CircleCI UI の Runner Inventory ページに表示されます。 指定しない場合は、デプロイの名前がデフォルトで設定されます。
|`container-agent` (デプロイの名前)

|agent.resourceClasses *ジョブを正常に実行するため、デフォルト値の更新が必要* 
|リソースクラスタスクの設定。 以下のリソースクラスの設定に関するセクションを参照してください。
|" "

|agent.terminationGracePeriodSeconds
|Termination grace period during container runner shutdown
|18300

|agent.maxRunTime
|タスクの最大実行時間。 この値は、上記の猶予期間より短くなければなりません。指定可能な値については <<runner-config-reference/#runner-max_run_time#, ドキュメント>> を参照してください。
|5 時間

|agent.maxConcurrentTasks
|同時に要求または実行できるタスクの最大数
|20

|agent.kubeGCEnabled
|ガベージコレクションを有効または無効にするオプション
|true

|agent.kubeGCThreshold
|ガベージコレクションで削除されるまでにポッドが実行できる時間
|5 時間 5 分

|agent.constraintChecker.enable
|制約チェッカーを有効にするかどうかの指定
|false

|agent.constraintChecker.threshold
|リソースクラスの要求を無効にする前に失敗したチェックの数
|3

|agent.constraintChecker.interval
|制約チェックの間隔
|15 分
|===

---

以下は **Kubernetes オブジェクトの設定** です。 All settings prefixed with `agent` below are for the container runner pod itself, not the ephemeral pods where jobs are executed.

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
|パラメーター
|説明
|デフォルト

|nameOverride
|チャート名を上書き
|" "

|fullnameOverride
|生成されたフルネームを上書き
|" "

|agent.replicaCount
|Number of container-agents to deploy. デフォルト値の 1 のままにすることをお勧めします。
|1

|agent.image.registry
|エージェントイメージのレジストリ
|" "

|agent.image.repository
|エージェントイメージのリポジトリ
|circleci/container-agent

|agent.pullPolicy
|エージェントイメージのプルポリシー
|ifNotPresent

|agent.tag
|エージェントイメージのタグ
|latest

|agent.pullSecrets
|link:https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/[Secret objects] container private registry credentials for the container runner pod itself, not the ephemeral pods that execute tasks
|[]

|agent.matchLabels
|エージェントポッドで使用されるマッチラベル
|app: container-agent

|agent.podAnnotations
|エージェントポッドに追加する追加の注釈
|{}

|agent.podSecurityContext
|エージェントポッドに追加するセキュリティコンテキストポリシー
|{}

|agent.containerSecurityContext
|エージェントコンテナに追加するセキュリティコンテキストポリシー
|{}

|agent.resources
|Custom resource specifications for container runner pods
|{}

|agent.nodeSelector
|エージェントポッドの Node Selector
|{}

|agent.tolerations
|エージェントポッドの Node Toleration
|{}

|agent.tolerations
|エージェントポッドの Node Toleration
|[]

|agent.affinity
|エージェントポッドの Node Affinity
|{}

|serviceAccount.create
|エージェントのカスタマイズされたサービスアカウントを作成
|true

|rbac.create
|サービスアカウントの Role と RoleBinding を作成
|
|===

Container runner needs the following Kubernetes permissions:

* Pod、 Pod/Exec、Pod/Log
** Get
** Watch
** List
** Create
** Delete
* シークレット
** List
** Create
** Delete

By default a `Role`, `RoleBinding` and service account are created and attached to the container runner pod, but if you customize these, the above are the minimum required permissions.

It is assumed that the container runner is running in a Kubernetes namespace without any other workloads. エージェントまたはガベージコレクション (GC) は、同じ名前空間のポッドを削除してしまうことがあります。

[#garbage-collection]
== ガベージコレクション

Each container runner has a garbage collector which will ensure any pods and secrets with the label `app.kubernetes.io/managed-by=circleci-container-agent` left dangling in the cluster are removed. デフォルトでは、これによって、5 時間 5 分を経過したジョブがすべて削除されます。 この時間は `agent.kubeGCThreshold` パラメーターを使って短くも長くもできます。 ただし、ガベージコレクション (GC) の頻度を下げた場合は、 `agent.maxRunTime` パラメーターの値を GC の頻度より小さくして、タスクの最大実行時間も短くしてください。 そうしないと、実行中のタスクポッドが GC によって削除されてしまう場合があります。

Container runner will drain and restart cleanly when sent a termination signal. At this point in the open preview, container runner will not automatically attempt to launch a task that fails to start. これは、CircleCI Web アプリで行うことができます。

At this time, if the container runner crashes, there is no expectation that in-process or queued tasks are handled gracefully. オープンプレビューの今後の過程で、クラッシュ時の対処方法が追加され、文書化される予定です。

[#constraint-validation]
== 制約の確認

Container runner allows you to configure task pods with the full range of Kubernetes settings. つまり、制約によりスケジュールできないようにポッドが設定されている場合があります。 To help with this, container runner has a constraint checker which periodically validates each resource class configuration against the current state of the cluster, to ensure pods can be scheduled. This prevents container runner claiming jobs which it cannot schedule which would then fail.

制約チェッカーによるチェックの失敗が多すぎた場合、再びチェックをパスするようになるまでそのリソースクラスの要求は無効になります。

現在、クラスタの状態に対して以下の制約のチェックを行っています。

* link:https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector[Node Selector]
* link:https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodename[Node 名]
* link:https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodename[Node Affinity] - MatchExpressions  がチェックされる場合のみ

この機能の例として、以下のリソースクラスの設定を検討してみましょう。

```yaml
agent:
  resourceClasses:
    circleci-runner/resourceClass:
      token: TOKEN1
      spec:
        nodeSelector:
          disktype: ssd

    circleci-runner/resourceClass2:
      token: TOKEN2
```

1 つ目のリソースクラスには 、SSD を持つ Node にスケジュールされるようにする Node Selector が含まれています。 運用中に何らかの理由で、クラスタにそのラベルの Node がなくなったとします。 すると制約チェッカーは `circleci-runner/resourceClass` のチェックに失敗し、再び正しいラベルの Node が見つかるまでジョブの要求を無効にします。 各リソースクラスのチェックは互いに独立しているため、`circleci-runner/resourceClass2` の要求への影響はありません。

[#cost-and-availability]
== 料金と提供プラン

Container runner jobs are eligible for <<persist-data#managing-network-and-storage-use,Runner Network Egress>>. これは、セルフホストランナーの既存の料金モデルに沿っており、今後は、CircleCI の他のネットワークやストレージの料金設定にも合わせていく予定です。 ご不明な点がありましたら、CircleCI の担当者にお問い合わせください。

The same plan-based offerings for self-hosted runner link:https://circleci.com/pricing/#comparison-table[concurrency limits] apply to the container runner open preview. 最終的な料金設定と提供プランは、製品の販売開始が近づきましたらご案内いたします。

[#building-container-images]
== Building container images

link:https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker[Docker in Docker] は、クラスタに対するセキュリティリスクを招く可能性があるため推奨されません。

To build container images in a container-agent job, a user may use:

1. A third-party tool like Buildah
1. Machine runner installed with Docker installed on it
1. CircleCI がホストするコンピューティング環境

Note: Third-party tools should be used at your own discretion.

While jobs that run with container-agent cannot use CircleCI's <<building-docker-images#,setup_remote_docker>> feature, it is possible to use a third-party tool to build Docker images in your container-agent job without using the Docker daemon.

A simple option is to use a tool called link:https://github.com/containers/buildah[Buildah]. Buildah can be used in your `.circleci/config.yml` syntax:

```yaml
docker:
  - image: quay.io/buildah/stable
```

[#using-the-buildah-image]
=== Using the Buildah image

Buildah relies on the link:https://github.com/containers/fuse-overlayfs[fuse-overlay] program inside of the container, which means that a fuse device plugin must be configured in order to use it. `/dev/fuse` is required to use `fuse-overlayfs` inside of the container, as this option tells Buildah on the host to add `/dev/fuse` to the container for Buildah's use. Kubernetes has a device plugin system to enable secure sharing of host devices with pods.

To install the configuration `dev/fuse`, clone this link:https://github.com/kuberenetes-learning-group/fuse-device-plugin/blob/master/fuse-device-plugin-k8s-1.16.yml[repository] to where you are running Helm commands for your container-agent deployment. Then run:

```
kubectl create -f fuse-device-plugin-k8s-1.16.yml
```

You can confirm that this has been configured correctly by running `kubectl get daemonset -n kube-system` and confirming that `fuse-device-plugin-daemonset` is present and ready.

Once this device has been added, update the container-agent <<#resource-class-configuration-custom-pod,resource class configuration>>:

```yaml
resourceClasses:
 <namespace>/<resourceClass>:
  token: <token>
   spec:
    containers:
     - resources:
        limits:
         github.com/fuse: 1
```

This will now let you run Buildah commands with container agent jobs and build containers:

```yaml
  docker-image:
    docker:
      - image: quay.io/buildah/stable
    resource_class: <namespace>/<resourceClass>
    steps:
      - checkout
      - run:
          name: sanity-test
          command: |
            buildah version
      - run:
          name: Building-a-container
          command: |
            buildah bud -f ./Dockerfile -t myimage:0.1
            buildah push myimage:tag
```

[#using-buildah-with-custom-images]
=== Using Buildah with custom images

You can also build your own custom image and include the installation of Buildah in your Dockerfile:

```
sudo yum install buildah
```

If you plan to use a CircleCI link:https://circleci.com/developer/images[convenience image], ensure you add the repository for installation to your job's `steps`:

```
sudo apt-get update
sudo apt-get install -y wget ca-certificates gnupg2
VERSION_ID=$(lsb_release -r | cut -f2)
echo "deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/ /" | sudo tee /etc/apt/sources.list.d/devel-kubic-libcontainers-stable.list
curl -Ls https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/xUbuntu_$VERSION_ID/Release.key | sudo apt-key add -
sudo apt-get update
sudo apt install buildah -y
```

Additionally, set the isolation variable to default to `chroot`:

```
# Default to isolate the filesystem with chroot.
ENV BUILDAH_ISOLATION=chroot
```

You can then follow the same instructions as <<#using-the-buildah-image,Using the Buildah image>> above to add the fuse device plugin to the container-agent deployment and update your `.circleci/config.yml` file to use your custom images and build container images in those jobs.

[#limitations]
== 制限事項

As container runner is in an preview state, there are several known limitations. これは制限を網羅するものではなく、重要な事項のみを取り上げます。 以下の内容は変わる可能性があり、現時点でサポートされていない機能も今後サポートされる可能性があります。

* SSH を使用したジョブの再実行
* 既存のセルフホストランナーに対する既知の<<runner-overview#limitations,制限事項>>は、コンテナエージェントにも引き続き適用されます。
* Kubernetes を除き、コンテナ環境のサポートは現時点ではありません。
* There is no support for the installation of container runner via the UI-based install flow in the web app, with the exception of creating a runner resource class that can be used with container runner.
* Container runner does not yet work on link:https://circleci.com/pricing/server/[CircleCI's server offering]

[#how-to-receive-technical-help]
== 技術サポートを受けるには

CircleCI の担当者に直接ご連絡いただくか、 link:https://discuss.circleci.com/t/a-more-scalable-container-friendly-self-hosted-runner-container-agent-now-in-open-preview/45094[Discuss の投稿] からお問い合わせください。

[#faqs]
== FAQ

Please visit the <<runner-faqs#container-runner-specific-faqs,runner FAQ page>> to see commonly asked questions about container runner.