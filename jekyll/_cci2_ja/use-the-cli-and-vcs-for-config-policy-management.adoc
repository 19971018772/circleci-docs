---

description: CircleCI プロジェクトの設定の設定ポリシー管理
contentTags:
  platform:
  - クラウド
---
= CLI と VCS を使用した設定ポリシーの管理
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro

:toc-title:

NOTE: 設定ポリシー管理が **Scale** プランでご利用いただけるようになました。現在 **オープンプレビュー** であり、 この機能のすべての側面が変更される可能性があります。

CAUTION: 設定ポリシーの管理で CLI を使用する前に、ご使用の CLI のバージョンをトークンで認証し、更新していることをご確認ください。 詳細については、 link:/docs/local-cli[ローカルの CLI のインストール] のページをご覧ください。

CircleCI CLI を使ってプログラム上で組織のポリシーを管理します。 ポリシーの管理機能を実行するためのサブコマンドは、`policy` コマンドの配下にグループされます。

設定ポリシーの管理用の CLI では現在以下のサブコマンドをサポートしています。

* `diff` : ローカルポリシーバンドルとリモートポリシーバンドルとの相違点を示します。
* `push` : ポリシーバンドルをプッシュ (アクティブ化) します 。
* `fetch` : ポリシーバンドルを (または 1 つのポリシーを名前に基づき) リモートからフェッチします。

たとえば、以下のコマンドを実行することにより、`./policy_bundle_dir_path` に保存されたポリシーバンドルがアクティブ化されます。

[source,shell]
----
circleci policy push ./policy_bundle_dir_path --owner-id <your-organization-ID>
----

[NOTE]
====
組織 ID が要求されます。組織 ID には `--owner-id` フラグがついています。 組織/ユーザー ID を見つけるには、CircleCI Web アプリのサイドバーで
 **Organization Settings** を選択します。

image:org-id.png[screenshot showing where to find your organization ID]
====

[#create-and-upload-a-policy]
== ポリシーの作成とアップロード

以下の手順に従って、CircleCI 設定ファイルの `バージョン` が `2.1` 以上であることをチェックするポリシーを作成します。

. 空のディレクトリにポリシーファイルを作成します。 例えば以下のようになります。
+
[source,shell]
----
mkdir ./config-policies
----
. 新しいディレクトリ内に、例えば以下のような新しいポリシー用の Rego ファイルを作成します。
. 以下の内容を `version.rego` に追加します。
+
[source,rego]
----
# All policies start with the org package definition
package org

policy_name["example"]

# signal to circleci that check_version is enabled and must be included when making a decision
enable_rule["check_version"]

# signal to circleci that check_version is a hard_failure condition and that builds should be
# stopped if this rule is not satisfied.
hard_fail["check_version"]

# define check version
check_version = reason {
    not input.version # check the case where version is not in the input
    reason := "version must be defined"
} {
    not is_number(input.version) # check that version is number
    reason := "version must be a number"
} {
    not input.version >= 2.1 # check that version is at least 2.1
    reason := sprintf("version must be at least 2.1 but got %s", [input.version])
}
----
. 組織にポリシーをアップロードします。
+
[source,shell]
----
circleci-cli policy push ./config-policies --owner-id <your-organization-ID>
----
+
これで、組織内でパイプラインがトリガーされると、プロジェクトの `.circleci/config.yml` がこのポリシーについて確認されるようになりました。

[#update-a-policy]
== Update a policy

To illustrate making a change to an existing policy, suppose you made an error when creating the policy above. You realise that configs in your organization are using CircleCI config version `2.0` and you want your policy to reflect this.

. Change the rule definition in your `version.rego` file:
+
[source,rego]
----
{
    not input.version >= 2.0 # check that version is at least 2.0
    reason := sprintf("version must be at least 2.0 but got %s", [input.version])
}
----
. Push the policy directory containing the updated policy file using the CLI (verify the diff, and choose yes when prompted):
+
[source,shell]
----
circleci-cli policy push ./config-policies --owner-id <your-organization-ID>
----

[#manage-policies-with-your-vcs]
== Manage policies with your VCS

CircleCI policies are managed by pushing directories of policies to CircleCI via the CLI. The recommended method for managing your policy directory is by storing them in a repository in your VCS, within your organization. This is how policies are managed internally at CircleCI. Pushing policy bundles is done by triggering CircleCI pipelines.

We recommend creating a bot account for pushing policies, and using its associated CircleCI personal API token for authentication. For maximum security the token should be stored as an environment variable within a context, and that context should be restricted to groups that are responsible for managing policies. For more information, see the link:/docs/contexts[Using Contexts] page.

[set-up-a-config-policy-management-ci-pipeline]
=== Set up a config policy management CI pipeline

. Set up repository in your VCS to manage policies.
. Create a directory for your Rego policy files, for example:
+
[source,shell]
----
mkdir ./config-policies
----
. Create a `.circleci/config.yml` file for your policies repository, and copy and paste the config example below. This example pushes policies to CircleCI on commits to the `main` branch, and shows a diff of the policy bundle on commits to all other branches:
+
[source,yaml]
----
version: 2.1

orbs:
  circleci-cli: circleci/circleci-cli@0.1.9 # Use orb to make the `circleci-cli/default` executor available for running jobs

workflows:
  main-workflow:
    jobs:
      - diff-policy-bundle:
          context: <my-context>
          filters:
            branches:
              ignore: main # on all branches other than main
      - push-policy-bundle:
          context: <my-context>
          filters:
            branches:
              only: main # only on the main branch

jobs:
  diff-policy-bundle:
    executor: circleci-cli/default
    resource_class: small
    steps:
      - checkout
      - run:
          name: Diff policy bundle
          command: circleci policy diff ./config --owner-id $ORG_ID # show a diff of the policy bundle

  push-policy-bundle:
    executor: circleci-cli/default
    resource_class: small
    steps:
      - checkout
      - run:
          name: Push policy bundle
          command: circleci policy push ./config --no-prompt --owner-id $ORG_ID # push the policy bundle to CircleCI
----

NOTE: `$ORG_ID` is an environment variable to store the organiztion ID.

NOTE: The context for each job is `<my-context>`. This context name is arbitrary, but it must declare the environment variable `CIRCLECI_CLI_TOKEN` to authenticate the CLI.