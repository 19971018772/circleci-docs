---
description: 本書では、Terraform  を使って AWS に CircleCI Server v2 をインストールするための前提条件を説明します。
version:
- Server v2.x
---
= インストールの前提条件
:page-layout: classic-docs
:page-liquid:
:source-highlighter: rouge
:rouge-linenums-mode: inline
:icons: font
:toc: macro
:toc-title:

CircleCI は、Terraform を使って CircleCI Server v2.x をインストールするためのインフラの一部を自動化しているため、まず Terraform をインストールする必要があります。

* https://www.terraform.io/downloads.html[Terraformのダウンロード]で、お使いのアーキテクチャ用のパッケージを選択してください。

インストール手順を開始する前に、以下の情報をご準備ください。

* CircleCI ライセンス ファイル (`.rli`): ライセンスについては https://support.circleci.com/hc/en-us/requests/new[CircleCI サポート]にお問い合わせください。また、最高のパフォーマンスを得るために、専用インスタンスでジョブを実行するためのクラスタ対応ライセンスをリクエストしてください。
* AWS アクセス キー ID とシークレット アクセスキー
* https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html[AWS EC2 SSH キーペア]の名前
* https://docs.aws.amazon.com/general/latest/gr/rande.html[AWS リージョン]、例えば `us-west-2`
* AWS Virtual Private Cloud (VPC) ID および AWS サブネット ID:  アカウントがデフォルトのVPC を使用するように設定されている場合、デフォルトの VPC ID は「Account Attributes」に記載されており、AWS マネジメントコンソールからEC2 ダッシュボードページで確認できます。
* VPC の [`enableDnsSupport`] を`true`に設定し、Amazon が提供する IP アドレス169.254.169.253のDNSサーバー、または VPC IPv4 ネットワーク範囲のベース+2の予約 IP アドレスへのクエリが成功するようにします。 詳しい情報については、Amazon Web サービスのドキュメントにあるhttps://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-dns.html#vpc-dns-updating[VPC での DNS の使用]を参照してください。

== プライベート サブネットの要件

AWS 上の非公開サブネットを CircleCI で使用するには、次の追加設定が必要です。

- The private subnet for builder boxes must be configured with a https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html[NAT gateway] or an https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html[internet gateway] configured for the outbound traffic to the internet via attached route tables.
+
CAUTION: The subnet should be large enough to *never* exhaust the addresses.

- The https://aws.amazon.com/blogs/aws/new-vpc-endpoint-for-amazon-s3/[VPC Endpoint for S3] should be enabled. Enabling the VPC endpoint for S3 should significantly improve S3 operations for CircleCI and other nodes within your subnet.
- Adequately power the NAT instance for heavy network operations.  Depending on the specifics of your deployment, it is possible for NAT instances to become constrained by highly parallel builds using Docker and external network resources.  A NAT that is inadequate could cause slowness in network and cache operations.
- If you are integrating with https://github.com[github.com], ensure that your network access control list (ACL) allows ports 80 and 443 for GitHub webhooks. When integrating with GitHub, either set up CircleCI in a public subnet, or set up a public load balancer to forward github.com traffic.
- See the <<overview#services-machine, Services Machine>> section of our overview for more information on the specific ports that need to be accessible to instances in your CircleCI installation.

// Check whether the ACL needs to be more open so the services/build can download build images

== Planning
Have available the following information and policies before starting the installation:

* If you use network proxies, contact your Account team before beginning your install.
* Plan to provision at least two AWS instances, one for Services and one for your first set of Nomad Clients. Best practice is to use an `m4.2xlarge` instance with 8 vCPUs and 32GB RAM for both the Services and Nomad Clients instances.
* AWS instances must have outbound access to pull Docker containers and to verify your license. If you don't want to give open outbound access, see our https://help.replicated.com/community/t/customer-firewalls/55[list of ports] that will need access.
* In order to provision required AWS entities with Terraform you will require an IAM User with the following permissions (See the https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html[AWS guidance] on creating IAM users):
+
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "s3:*"
            ],
            "Effect": "Allow",
            "Resource": [
                "arn:aws:s3:::circleci-*",
                "arn:aws:s3:::circleci-*/*",
                "arn:aws:s3:::*"
            ]
        },
        {
            "Action": [
                "autoscaling:*",
                "sqs:*",
                "iam:*",
                "ec2:StartInstances",
                "ec2:RunInstances",
                "ec2:TerminateInstances",
                "ec2:Describe*",
                "ec2:CreateTags",
                "ec2:AuthorizeSecurityGroupEgress",
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:CreateSecurityGroup",
                "ec2:DeleteSecurityGroup",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceStatus",
                "ec2:DescribeInstances",
                "ec2:DescribeNetworkAcls",
                "ec2:DescribeSecurityGroups",
                "ec2:RevokeSecurityGroupEgress",
                "ec2:RevokeSecurityGroupIngress",
                "ec2:ModifyInstanceAttribute",
                "ec2:ModifyNetworkInterfaceAttribute",
                "cloudwatch:*",
                "autoscaling:DescribeAutoScalingGroups",
                "iam:GetUser"
            ],
            "Resource": [
                "*"
            ],
            "Effect": "Allow"
        }
    ]
}
----
