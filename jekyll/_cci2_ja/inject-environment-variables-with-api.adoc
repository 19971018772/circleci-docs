---

version:
- クラウド
- Server 3.x
- Server 4.x
---
= CircleCI API を使った環境変数の挿入
:page-layout: classic-docs
:page-liquid:
:page-description: API を使って環境変数の値を挿入する方法
:icons: font
:toc: macro

:toc-title:

[#api-v2]
== API v2

CircleCI API v2 を使用すると、パイプラインパラメーターから変数を渡すことができます。

link:https://circleci.com/docs/api/v2/index.html#operation/getPipelineConfigById[パイプラインをトリーがする] API v2 エンドポイントを使用すると、特定のパラメーターの値でパイプラインをトリガーすることができます。
これを実行するには、`POST` 本体の JSON パケット内で `parameters` キーを渡します。

以下の例では、`workingdir` と `image-tag` のパラメーター値を使ってパイプラインをトリガーしています。

NOTE: API を使ってパイプラインをトリガーする際にパラメーターを渡すには、そのパラメーターが <<reusing-config#using-the-parameters-declaration,設定ファイル内で宣言されている>> 必要があります。

```shell
curl -u ${CIRCLECI_TOKEN}: -X POST --header "Content-Type: application/json" -d '{
  "parameters": {
    "workingdir": "./myspecialdir",
    "image-tag": "4.8.2"
  }
}' https://circleci.com/api/v2/project/:project_slug/pipeline
```

IMPORTANT: パイプラインパラメーターは機密データとして扱われないため、機密の値 (シークレット) には使用しないでください。

パイプラインパラメーターの詳細については、<<pipeline-variables#,パイプラインの値とパラメーター>> のページをお読みください。

[#api-v1]
== API v1

You can inject environment variables with the `build_parameters` key to enable your functional tests to build against different targets on each run (for example, a run with a deploy step to a staging environment that requires functional testing against different hosts).

It is possible to include `build_parameters` by sending a JSON body with `Content-type: application/json` as in the following example that uses `bash` and `curl`. You may also use an HTTP library in your language of choice.

```json
{
  "build_parameters": {
    "param1": "value1",
    "param2": 500
  }
}
```

Using `curl` (`$CIRCLE_TOKEN` is a <<managing-api-tokens#creating-a-personal-api-token,personal API token>>):

```shell
curl \
  --header "Content-Type: application/json" \
  --header "Circle-Token: $CIRCLE_TOKEN" \
  --data '{"build_parameters": {"param1": "value1", "param2": 500}}' \
  --request POST \
  https://circleci.com/api/v1.1/project/github/circleci/mongofinil/tree/master
```

ビルド時には下記のような環境変数となります。

```shell
export param1="value1"
export param2="500"
```

A POST API call with an empty body will start a new run of the named branch. Refer to the link:https://circleci.com/docs/api/v1/#trigger-a-new-job-with-a-branch[Trigger a new job with a branch] section of the API v1 documentation for details.

[#best-practices-for-using-build-parameters-with-api-v1]
=== Best practices for using build parameters with API v1

ビルドパラメータは環境変数からなります。そのため、その環境変数名は下記の条件を満たしている必要があります。

- 変数名に使えるのは ASCII 文字列、数字、アンダースコアのみです
- 数字から始まる変数は使えません
- 少なくとも 1 文字以上の変数でなければなりません

Aside from the usual constraints for environment variables, there are no restrictions on the values themselves and are treated as simple strings.

Build parameters are exported as environment variables inside each job's containers and can be used by scripts/programs and commands in `.circleci/config.yml`. 代入された環境変数はジョブ内のステップの実行内容を変えるのに使われることもあります。 It is important to note that injected environment variables will not override values defined in `.circleci/config.yml` nor in the project settings.

The order in which build parameters are loaded is **not** guaranteed, so avoid interpolating one build parameter into another. 順不同の独立した環境変数リストとしてビルドパラメータを設定するのがおすすめです。

たとえば、以下のパラメーターを渡すとします。

```json
{
  "build_parameters": {
    "foo": "bar",
    "baz": 5,
    "qux": {"quux": 1},
    "list": ["a", "list", "of", "strings"]
  }
}
```

ビルド時には下記のような環境変数となります。

```shell
export foo="bar"
export baz="5"
export qux="{\"quux\": 1}"
export list="[\"a\", \"list\", \"of\", \"strings\"]"
```

IMPORTANT: Build parameters are not treated as sensitive data and must not be used by customers for sensitive values (secrets).

== 関連項目

- <<env-vars#,Learn about environment variables in CircleCI>>
- <<set-environment-variable#,How to set environment variables>>
- <<built-in-environment-variables#,Built-in environment variables in CircleCI>>