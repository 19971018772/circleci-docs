---

version:
- Server v4.x
- サーバー管理者
---
= ステップ 2 - コアサービス
:page-layout: classic-docs
:page-liquid:
:page-description: CircleCI Server v4.x のインストール手順と前提条件をご確認ください。
:icons: font
:toc: macro

:toc-title:

// This doc uses ifdef and ifndef directives to display or hide content specific to Google Cloud Storage (env-gcp) and AWS (env-aws). Currently, this affects only the generated PDFs. To ensure compatability with the Jekyll version, the directives test for logical opposites. For example, if the attribute is NOT env-aws, display this content. For more information, see https://docs.asciidoctor.org/asciidoc/latest/directives/ifdef-ifndef/.

CircleCI Server v4.x のコアサービスのインストールステップを開始する前に、link:/docs/ja/server/installation/phase-1-prerequisites[前提条件] をすべて満たしていることをご確認ください。

////
.Installation Experience Flow Chart Phase 2
image::server-install-flow-chart-phase2.png[Flow chart showing the installation flow for server 3.x with phase 2 highlighted]
////

NOTE: 以下のセクションでは、 `< >` で示されている箇所にご自身の詳細情報を入力してください。

toc::[]

[#create-a-namespace]
== 1. 名前空間を作成します

アプリケーションをインストールする名前空間を作成します。

[source,shell]
----
kubectl create ns <namespace>
----

TIP: 名前空間を作成したら、以下のコマンド: `kubectl config set-context --current --namespace <namespace>` で、`kubectl` コンテキストも設定することをお勧めします。

[#pull-images]
== 2. イメージをプルします

CircleCI のイメージレジストリからイメージをプルするための認証情報は、このセットアッププロセスの一部としてお客様に提供されます。 Azure Container Registry (ACR) からのイメージのプルには、 `docker-registry` Kubernetes のシークレットを使用します。 アプリケーションのパブリックインターネットへのアクセスの可否により、 2 つのオプションがあります。

[.tab.pullimage.Public]
--
**オプション 1:** アプリケーションのパブリックインターネットへのアクセスが可能な場合

この例では、CircleCI のイメージレジストリからイメージをプルするためのデプロイを有効化するためのシークレットを作成します。 `docker-registry` Kubernetes シークレットは以下のようになります。

[source,shell]
----
kubectl create secret docker-registry regcred \
  --docker-server=cciserver.azurecr.io \
  --docker-username=<your-username> \
  --docker-password="<provided-token>" \
  --docker-email=<your-contact-email>
----
--

[.tab.pullimage.Private]
--
**オプション 2:** アプリケーションのパブリックインターネットへのアクセスが不可能な場合

提供された認証情報により、イメージのコピーをローカルにプルし、保存することができます。 イメージを使用可能な任意の Docker リポジトリにプルし、保存します。 `docker-registry` Kubernetes シークレットは以下のようになります。

[source,shell]
----
kubectl create secret docker-registry regcred \
  --docker-server=<your-docker-image-repo> \
  --docker-username=<your-username> \
  --docker-password=<your-access-token> \
  --docker-email=<your-email>
----
--

[#create-helm-values]
== 3. Helm 値を作成します

CircleCI をインストールする前に、インストール専用の `values.yaml` ファイルを新たに作成することをお勧めします。 link:/docs/ja/server/installation/installation-reference#example-manifests[インストールのリファレンスセクション] には `values.yaml` のサンプルファイルが複数含まれており、第一歩としてお勧めです。 以下は、`values.yaml` に含める必要がある最小限の値です。 更なるカスタマイズも可能です。利用できるオプションについては提供されている `values.yaml` を参照してください。

シークレットについては 2 つのオプションがあります。

* `values.yaml` ファイルに追加する
* Kubernetes シークレットとして直接追加する

お好きな方法で柔軟にシークレットを管理していただけます。

NOTE: どちらのオプションを選んでも、シークレットは CircleCI 内に Kubernetes シークレットとして保存されます。

[#api-token]
=== a.  API トークン

アプリケーションには API トークンを含むシークレットが必要です。 この API トークンは、API サービスへの API 内部通信を簡易化するために使われます。 ランダムな文字列を使って安全に保存してください。紛失した場合、CircleCI が復元することはできません。 このシークレットの作成には 2 つのオプションがあり、ご自身で作成することも、CircleCI がお客様のシークレットを作成することも可能です。

[.tab.apitoken.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する場合

[source,shell]
----
kubectl create secret generic api-token \
  --from-literal=api-token=<your-super-secret-random-value>

----
--

[.tab.apitoken.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がお客様のシークレットを作成する場合

値を `values.yaml` に追加します。 CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
apiToken: <your-super-secret-random-value>
----
--

[#session-cookie]
=== b.  セッション Cookies

アプリケーションにはセッション Cookie シークレットが必要です。CircleCI がセッション Cookie に署名する際に使用します。 キーシークレットは 16 文字にする必要があります。 ランダムな文字列を使って安全に保存してください。紛失した場合、CircleCI が復元することはできません。 このシークレットの作成には 2 つのオプションがあり、ご自身で作成する、または CircleCI がお客様のシークレットを作成することも可能です。

[.tab.sessioncookie.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する

[source,shell]
----
kubectl create secret generic session-cookie \
--from-literal=session-cookie-key=<your-secret-key-16-chars>
----
--

[.tab.sessioncookie.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がお客様のシークレットを作成する

値を `values.yaml` に追加します。  CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
sessionCookieKey: <your-secret-key-16-chars>
----
--

[#encryption]
=== c.  暗号化

アプリケーションには、署名と暗号化のキーセットを含むシークレットが必要です。 CircleCI で生成されるアーティファクトの暗号化と署名には、キーセットを使用します。 これらのキーは、link:/docs/ja/server/installation/phase-1-prerequisites#encryption-signing-keys[前提条件のステップ] で作成されています。 値を紛失した場合、CircleCI では復元できません。 シークレットの管理方法には、2 つのオプションがあります。

[.tab.encryption.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する

[source,shell]
----
kubectl create secret generic signing-keys \
  --from-literal=signing-key=<your-generated-signing-key> \
  --from-literal=encryption-key=<your-generated-encryption-key>
----
--

[.tab.encryption.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がシークレットを作成する

値を `values.yaml` に追加します。  CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
keyset:
  signing: <your-generated-signing-key>
  encryption: <your-generated-encryption-key>
----
--

=== d. Postgres 認証情報

アプリケーションには Postgres 認証情報を含むシークレットが必要です。  これは、Postgres の内部インスタンス (デフォルト) または外部ホストインスタンスのいずれかを使用する場合に当てはまります。 値を紛失した場合、CircleCI では復元できません。 シークレットの管理方法には、2 つのオプションがあります。

[.tab.postgres.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する場合

[source,shell]
----
kubectl create secret generic postgresql \
  --from-literal=postgres-password=<postgres-password>
----

下記を `values.yaml` ファイルに追加します。

[source,yaml]
----
postgresql:
  auth:
    existingSecret: postgresql
----
--

[.tab.postgres.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がシークレットを作成する場合

認証情報を `values.yaml` に追加します。CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
postgresql:
  auth:
    postgresPassword: <postgres-password>
----
--

=== e. MongoDB 認証情報

アプリケーションには MongoDB 認証情報を含むシークレットが必要です。 これは、MongoDB の内部インスタンス (デフォルト) または外部ホストインスタンスのいずれかを使用する場合に当てはまります。 値を紛失した場合、CircleCI では復元できません。 シークレットの管理方法には、2 つのオプションがあります。

[.tab.mongo.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する

[source,shell]
----
kubectl create secret generic mongodb-credentials \
  --from-literal=mongodb-root-password=<root-password> \
  --from-literal=mongodb-password=<user-password>
----

下記を `values.yaml` ファイルに追加します。

[source,yaml]
----
mongodb:
  auth:
    existingSecret: mongodb-credentials
----
--

[.tab.mongo.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がシークレットを作成する

認証情報を `values.yaml` に追加します。CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
mongodb:
  auth:
    rootPassword: <root-password>
    password: <user-password>
----
--

[#rabbinmq-configurations-and-auth-secrets]
=== f. RabbitMQ の設定と Auth シークレット

RabbitMQ のインストールには 2 つのランダムな英数字の文字列が必要です。 値を紛失した場合、CircleCI では復元できません。 シークレットの管理方法には、2 つのオプションがあります。

[.tab.rabbit.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する

[source,shell]
----
kubectl create secret generic rabbitmq-key \
--from-literal=rabbitmq-password=<secret-alphanumeric-password> \
--from-literal=rabbitmq-erlang-cookie=<secret-alphanumeric-key>
----

下記を `values.yaml` ファイルに追加します。

[source,yaml]
----
rabbitmq:
  auth:
    existingPasswordSecret: rabbitmq-key
    existingErlangSecret: rabbitmq-key
----
--

[.tab.rabbit.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がシークレットを作成する場合

値を `values.yaml` に追加します。CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
rabbitmq:
  auth:
    password: <secret-alphanumeric-password>
    erlangCookie: <secret-alphanumeric-key>
----
--

=== g. Pusher シークレット

このアプリケーションでは Pusher 用のシークレットが必要です。 値を紛失した場合、CircleCI では復元できません。 シークレットの管理方法には、2 つのオプションがあります。

[.tab.pusher.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する場合

[source,shell]
----
kubectl create secret generic pusher \
--from-literal=secret=<pusher-secret>
----
--

[.tab.pusher.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がシークレットを作成する場合

値を `values.yaml` に追加します。CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
pusher:
  secret: <pusher-secret>
----
--

[#global]
=== h. Global

このセクションの値はすべて Global の子です。

[#circleci-domain-name]
==== CircleCI ドメイン名 (必須)

Enter the domain name you specified when creating your link:/docs/server/installation/phase-1-prerequisites#frontend-tls-certificates[Frontend TLS key and certificate].

[source,yaml]
----
global:
  ...
  domainName: <domain-name-for-circleci>
----

[#license]
==== ライセンス

CircleCI からライセンスが提供されています。そのライセンスを `values.yaml` に追加します。

[source,yaml]
----
global:
  ...
  license: <license>
----

[#Registry]
==== レジストリ

The registry to pull images from will have been provided to you, or you may have added the images to your own hosted registry. You will need to add the registry to `values.yaml`:

[source,yaml]
----
global:
  ...
  container:
    registry: <registry-domain eg: cciserver.azurecr.io >
    org: <your-org-if-applicable>
----

[#tls]
=== i. TLS

TLS では 4 つのオプションがあります。

[.tab.tls.Do_nothing]
--
*Do nothing*

何もしない。 https://letsencrypt.org/[Let's Encrypt] が自動的に証明書のリクエストと管理を行います。  このオプションは試用版には適していますが、本番環境での使用は推奨していません。
--

[.tab.tls.Supply_private_key_and_certificate]
--
*Supply a private key and certificate*

You can supply a private key and certificate, which you may have created during the prerequisites steps. The key and certificates will need to be base64 encoded. 以下のコマンドで取得およびエンコードできます。

[source,bash]
----
cat /etc/letsencrypt/live/<CIRCLECI_SERVER_DOMAIN>/privkey.pem | base64
cat /etc/letsencrypt/live/<CIRCLECI_SERVER_DOMAIN>/fullchain.pem | base64
----

And add them to `values.yaml`:

[source,yaml]
----
tls:
  certificate: <full-chain>
  privateKey: <private-key>
----
--

[.tab.tls.Use_AWS_Certificate_Manager]
--
*Use ACM*

 https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html[AWS Certificate Manager (ACM)] により自動的に証明書のリクエストと管理を行う。 https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html[ACM documentation] の ACM 証明書の生成方法に従ってください。

Enable `aws_acm` and add the `service.beta.kubernetes.io/aws-load-balancer-ssl-cert` annotation to point at the ACM ARN:

[source,yaml]
----
nginx:
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: <acm-arn>
  aws_acm:
    enabled: false
----

[WARNING]
====
CircleCI Server をデプロイ済みの場合は、ACM の有効化はロードバランサーに破壊的な変更を加えます。 ACM 証明書の使用を許可するようサービスを再生成し、関連するロードバランサーも再生成する必要があります。
CircleCI Server を再デプロイした場合、DNS レコードを更新する必要があります。
====
--

[.tab.tls.Termiate_TLS_upstream]
--
*Disable TLS within CircleCI*

You can choose to disable TLS termination within CircleCI. システムは HTTPS 経由でのアクセスが必要なため、CircleCI のアップストリームで TLS の終了が求められます。 Implement this by following the first option (do nothing) and forward to CircleCI on port 80 after terminating TLS.
--

[#github-integration]
=== j. GitHub との連携

 GitHub を CircleCI で設定する場合、デプロイに認証情報を提供する方法が 2 つあります。 GitHub と GitHub Enterprise (GHE) の手順は、次の 2 つのセクションで説明します。

[#github]
==== GitHub

下記の方法は GitHiub の非エンタープライズバージョン向けです。 Use the client ID and secret you created with your Github OAuth application in the link:/docs/server/installation/phase-1-prerequisites#create-a-new-github-oauth-app [prerequisites phase].

[.tab.github.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する場合

[source,shell]
----
kubectl create secret generic github-secret \
  --from-literal=clientId=<client-id> \
  --from-literal=clientSecret=<client-secret>
----
--

[.tab.github.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がシークレットを作成する場合

`values.yaml` ファイルにクライアント ID とシークレットを追加します。 CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
github:
  clientId: <client-id>
  clientSecret: <client-secret>
----
--

[#github-enterprise-integration]
==== GitHub Enterprise

GitHub Enterprise の手順は似ていますが、Enterprise を有効化し、必要なデフォルトのトークンを作成するための手順がいくつか追加されます。

In the case of GitHub Enterprise add the `defaultToken` created in the link:/docs/server/installation/phase-1-prerequisites#create-a-new-github-oauth-app[prerequisite phase] to the `GitHub` section. ホスト名には、`github.exampleorg.com` などのプロトコルを含めないでください。


[.tab.ghe.You_create_secret]
--
**オプション 1:** ご自身でシークレットを作成する場合

[source,shell]
----
kubectl create secret generic github-secret \
  --from-literal=clientId=<client-id> \
  --from-literal=clientSecret=<client-secret> \
  --from-literal=defaultToken=<default-token>
----

下記を `values.yaml` ファイルに追加します。

[source,yaml]
----
github:
  enterprise: true
  hostname: <github-enterprise-hostname>
----
--

[.tab.ghe.CircleCI_creates_secret]
--
**オプション 2:** CircleCI がシークレットを作成する場合

`clientID`、`clientSecret`、 `defaultToken` を `values.yaml` ファイルに追加します。 `enterprise` を `true` に設定し、Enterprise GitHub の `hostname` を指定します。 CircleCI が自動的にシークレットを作成します。

[source,yaml]
----
github:
  ...
  clientId: <client-id>
  clientSecret: <client-secret>
  enterprise: true
  hostname: <github-enterprise-hostname>
  defaultToken: <token>
----
--

[#object-storage]
=== k. オブジェクトストレージ

Regardless of your storage provider, the bucket name you created during the link:/docs/server/installation/phase-1-prerequisites#object-storage-and-permissions[prerequisites phase] will need to be included.

[source,yaml]
----
object_storage:
  bucketName: <bucket-name>
----

// Don't include this section in the GCP PDF.

ifndef::env-gcp[]

[#s3-compatible]
==== S3 互換

`s3` のセクションを `object_storage` の子として追加します。 AWS S3 の場合の `endpoint` は、 https://docs.aws.amazon.com/general/latest/gr/rande.html[regional endpoint] で、`https://s3.<region>.amazonaws.com` の形式です。 それ以外の場合は、オブジェクトストレージサーバーの API エンドポイントです。

[source,yaml]
----
object_storage:
  ...
  s3:
    enabled: true
    endpoint: <storage-server-or-s3-endpoint>
----

Under `object_storage.s3`, you may provide the `accessKey` and `secretKey`, the `irsaRole`, or nothing. 前提条件のステップで作成済みです。

[.tab.s3compatible.Use_IAM_keys]
--
**オプション 1:** IAM キーを使用する場合

以下を `object_storage.s3` セクションに追加します。

[source,yaml]
----
object_storage:
  ...
  s3:
    ...
    accessKey: <access-key>
    secretKey: <secret-key>
----
--

[.tab.s3compatible.Use_IRSA]
--
**オプション 2:** IRSA を使用する場合

A secret will automatically be generated for you using those credentials.

以下を `object_storage.s3` セクションに追加します。

[source,yaml]
----
object_storage:
  ...
  s3:
    ...
    region: <role-region>
    irsaRole: <irsa-arn>
----
--

[.tab.s3compatible.You_create_secret]
--
**Option 3:** Create the secret yourself

Instead of providing AWS accessKey and secretKey credentials in your values file, you may choose to create the secret yourself.

[source,shell]
----
kubectl create secret generic object-storage-secret \
  --from-literal=s3AccessKey=<access-key> \
  --from-literal=s3SecretKey=<secret-key>
----
--

CircleCI server will use the role provided to authenticate to S3.

// Stop hiding from GCP PDF:

endif::env-gcp[]

// Don't include this section in the AWS PDF:

ifndef::env-aws[]

[#google-cloud-storage-object-storage]
==== Google Cloud Storage

`object_storage` の配下に以下を追加します。

[source,yaml]
----
gcs:
    enabled: true
----

Under `object_storage.gcs` you may add `service_account`,  `workloadIdentity`, or neither. The keys/role were created during the prerequisites steps.

[.tab.gcs.Use_service_account]
--
**オプション 1:** サービスアカウントを使用する場合

サービスアカウントの JSON キーを追加してバケットへのアクセスに使用します。  以下を `object_storage.gcs` セクションに追加します。

[source,yaml]
----
service_account: <service-account>
----
--

[.tab.gcs.Use_Workload_Identity]
--
**オプション 2: Workload Identity を使用する場合

Workload Identity のサービスアカウントのメールを追加します。  以下を `object_storage.gcs` セクションに追加します。

[source,yaml]
----
workloadIdentity: <workload-identity-service-account-email>
----
--

[.tab.gcs.You_create_secret]
--
**Option 3:** Create the secret yourself

Instead of storing the service account in your values file, you may create the secret yourself.

[source,shell]
----
kubectl create secret generic object-storage-secret \
  --from-literal=gcs_sa.json=<service-account>
----
--

// Stop hiding from AWS PDF

endif::env-aws[]

=== l. プロキシ経由でのインストール。

セキュリティ要件に応じて、CircleCI Server をプロキシ経由でインストールすることも可能です。 プロキシ経由で設定することにより、お客様のインストール環境とインターネット全体のアクセスを監視・制御することができます。 For further information including limitations of installation behind a proxy, see the link:/docs/server/installation/installing-server-behind-a-proxy[Installing Server Behind a Proxy] guide.

以下のフィールドを `values.yaml` に設定する必要があります。

* `proxy.enabled` を `"1"` に切り替えます。
* `proxy.http.host` と `proxy.https.host` の詳細を関連付けられているポートと共に入力します。 これらの値は同じでも構いませんが、両方とも設定する必要があります。
* 認証ように `proxy.http.auth.enabled` と `proxy.https.auth.enabled` を `"1"` に設定する必要があります。 HTTP と HTTPS の両方にそれぞれユーザー名とパスワードを設定する必要があります。
* `no_proxy` ホストとサブネットを設定します。 This should include localhost, your GitHub Enterprise host (optional), the hostname of your CircleCI installation (see link:/docs/server/installation/installing-server-behind-a-proxy#known-limitations[Known Limitations] for an explanation), and the CIDRs of both vm-service and Nomad.

[source,yaml]
----
proxy:
  enabled: "1"
  http:
    host: proxy.example.internal
    port: "3128"
    auth:
      enabled: "1"
      username: <proxy-user>
      password: <proxy-password>
  https:
    host: proxy.example.internal
    port: "3128"
    auth:
      enabled: "1"
      username: <proxy-user>
      password: <proxy-password>
  no_proxy:
    - localhost
    - 127.0.0.1
    - github.example.internal
    - circleci.example.internal
    - <nomad-subnet-cidr>
    - <vm-service-cidr>
    - <vpc-or-subnet-cidr>   # VPC or subnets to exclude from the proxy (optional)
----

[#deploy]
== 4.  デプロイ: 

上記項目の設定が完了したら、いよいよ CircleCI のコアサービスのデプロイです。

[source,shell]
----
USERNAME=<provided-username>
PASSWORD=<token>
namespace=<your-namespace>
helm registry login cciserver.azurecr.io/circleci-server -u $USERNAME -p $PASSWORD
helm install circleci-server oci://cciserver.azurecr.io/circleci-server -n $namespace --version 4.0.0 -f <path-to-values.yaml>
----

[#create-dns-entry]
== 5. DNS エントリーの作成

Create a DNS entry for your NGINX load balancer, for example, `circleci.your.domain.com` and `app.circleci.your.domain.com`. この DNS エントリは、前提条件のステップで TLS 証明書とGitHub OAuth アプリケーションを作成する際に使用した DNS 名と一致している必要があります。 すべてのトラフィックは、この DNS レコードを介してルーティングされます。

You need the IP address, or, if using AWS, the DNS name of the NGINX load balancer. 以下のコマンドで情報を入手します。

[source,shell]
----
kubectl get service circleci-proxy
----

新しい DNS レコードを追加する方法について詳しくは、以下のドキュメントを参照してください。

* link:https://cloud.google.com/dns/docs/records#adding_a_record[レコードの管理] (GCP)
* link:https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resource-record-sets-creating.html[Amazon Route 53 コンソールを使用したレコードの作成]  (AWS)

[#validation]
== 6. バリデーション

これで、CircleCI Server に移動し、アプリケーションに正常にログインできるはずです。

次は、サービスのビルドに移ります。 すべてのサービスが立ち上がるまで時間がかかることがあります。 You can periodically check by running the following command (you are looking for the `frontend”` pod to show a status of `running` and **ready** should show `1/1`):

[source,shell]
----
kubectl get pods -n <YOUR_CIRCLECI_NAMESPACE>
----

NOTE: VM service and Nomad server pods are expected to fail at this stage. You will set up your execution environments in the next phase of the installation.

ifndef::pdf[]

[#next-steps]
== 次のステップ

* link:/docs/server/installation/phase-3-execution-environments[Phase 3: Execution Environments Installation]
+
endif::[]