---
description: このドキュメントでは、お客様の CircleCI Server v2 のユーザーがアカウントにアクセスし、認証を受けるための様々な方法を紹介します。
version:
- Server v2.x
- サーバー管理
---
= 認証
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

このドキュメントでは、お客様の CirccleCI Server v２.x のユーザーがアカウントにアクセスし、認証を受けるための様々な方法を紹介します。 CircleCI Server v2.xでは、認証方法として OAuth と LDAP が使用可能です。

toc::[]

== GitHub/GitHub Enterprise による OAuth 認証

CircleCI Server におけるデフォルトのユーザー アカウント認証方法は、GitHub.com/GitHub Enterprise 経由の OAuth 認証です。

After your installation is up and running, provide users with a link to access the application - for example `<your-circleci-hostname>.com` – and it will prompt them to set up an account by running through the GitHub/GitHub Enterprise OAuth flow. その後、CircleCI のログイン画面に再び移動するように求められます。

.CircleCI Server v2.x のログイン画面
image::server_login.png[Server Login]

== LDAP
OAuth や GitHub の代わりに、LDAP 認証を選択することも可能です。 多くの組織では、LDAP サーバーを使用してすべての ID 情報を一箇所に集約しています。 ここでは、OpenLDAP または Active Directory の認証情報を使ってユーザーを認証するために CircleCI を有効化、設定およびテストする方法について説明します。

CAUTION: LDAP を有効にすると、その他の認証方法が*無効*になります。 CircleCI では、以前ユーザーが認証に GItHub を使用していた既存のサーバーにおいて LDAP 認証を有効にすることは推奨していません。 既存のサーバー上で LDAP に切り替える必要がある場合は、お客様のアカウントチームにご連絡ください。

=== 前提条件

* OpenLDAP サーバーまたは Active Directory のインストールおよび設定
* GitHub Enterprise または GitHub.com をユーザーがアクセスできる組織やプロジェクトのソースとして設定
* 既存のユーザーがいない CircleCI Server v2.x 上に新しいインスタンスのインストール

=== LDAP 認証の設定

ここでは、LDAP を設定する方法を説明します。 以下の設定例により、どのような情報かお分かりいただけます。 この例では OpenLDAP を使用していますが、Active Directory の設定も同様です。

.LDAP の設定例
image::LDAP_example.png[LDAP Example]

CircleCI Server v2.x の管理コンソールで LDAP を設定する手順は以下のとおりです。

. LDAP/AD ポートによる LDAP/AD サーバーへのアクセスを確認してください。
. 新しくインストールした CircleCI インスタンスの管理コンソールに管理者としてログインします。
. Navigate to the Settings page (for example `<your-circleci-hostname>.com:8800`) and scroll down to check the Enable LDAP-only Authentication button. [OpenLDAP] または [Active Directory] を選択します。
. LDAP インスタンスのホスト名とポート番号を入力します。
. 暗号化タイプを選択します (プレーンテキストは安全でないため推奨しません)。
. [Search user (ユーザーの検索)]フィールドに、LDAP データベース上で検索クエリーを実行することを許可するユーザーの完全な識別名を入力します。 Example: `cn=<admin>,dc=<example>,dc=<org>`.
. [Search password (パスワードの検索)]フィールドに、前の手順で設定したユーザーの LDAP パスワードを入力します。
. [Base DN] フィールドに、ディレクトリの中のユーザーやグループを探し始める起点となる識別名を入力します。 例: `ou=company、dc=example、dc=org`
. [User search DN] フィールドに、ユーザーを検索するディレクトリ内の起点となる相対識別名を記入します。 先に述べた [Base DN]の相対値である必要があります。 例: `ou=users`
. [Username] フィールドに、ログイン時のユーザー名のソースとなる属性名を入力します。 例: `uid` (この場合、ユーザーは UID を使ってログイン)、または`mail`  (この場合、ユーザーはメールアドレスを使ってログイン）
. [Email] フィールドに、ユーザーメールのソースとなる属性名を入力します。 例: `mail`
. [Group Membership] フィールドに、特定のグループのユーザーメンバーシップである属性名を入力します。 例: `uniqueMember`
. [Group Object Class] フィールドに、DN をグループとして識別するためのオブジェクトクラス名を入力します。 例: `groupOfUniqueNames`
. (オプション) [Test username] および [Test password] フィールドに、テストする LDAP ユーザーのテスト用メールアドレスとパスワードを入力します。 これはサードパーティのインフラであり、このテストオプションは必ずしも信頼できるものではありません。
. 設定を保存します。

=== Known Issue: Grant Admin Access to User

LDAP 認証を使用している場合は、以下のいずれかの方法でユーザーに管理者権限を付与してください。 管理者の権限は、プロジェクトに最初にアクセスしたユーザーに自動的に付与されるべきですが、現在、LDAP 認証を使用している場合、これが実現できないという既知の問題があります。

NOTE: 管理者権限を付与するには、以下の方法の中から一つ実行することが必要です。 REPL の使用に慣れていない場合は、これらの手順を実行する前にカスタマーサポートにお問い合わせください。

*LDAPユーザー名で指定されたユーザー（GitHub アカウントへの接続前、または GitHub アカウントを持っていない場合）*

```sh
(-> (circle.repl.mongo/fetch :users :domain-model :where {:login "the-ldap-username" :first_vcs_authorized_client_id nil} :limit 1)
    (first)
    (circle.model.user/set-fields! {:admin "all"})
    (:analytics-id)
    (circle.services.domain/delete-user-cache))
```

*GitHub ユーザー名を使用（GitHub アカウント接続後、以前のログイン値を置き換える）*

```sh
(-> (circle.repl.mongo/fetch :users :domain-model :where {:login "the-github-username"} :limit 1)
    (first)
    (circle.model.user/set-fields! {:admin "all"})
    (:analytics-id)
    (circle.services.domain/delete-user-cache))
```

*アナリティクス ID を使用*

```sh
(-> (circle.model.user/find-one-by-analytics-id "3b35037c-6eb3-4e41-88e2-3913b2f43d96")
    (circle.model.user/set-fields! {:admin "all"})
    (:analytics-id)
    (circle.services.domain/delete-user-cache))
```

=== ユーザーによる操作

LDAP の設定後は、CircleCI にログインしたユーザーはアカウントページにリダイレクトされ、接続ボタンを使って GitHub アカウントに接続しなければなりません。 [接続] をクリックすると、ページ上にユーザー情報 ( 電子メールなど ) を含む LDAP セクションが表示され、 GitHub アカウントの認証が求められます。 GitHub アカウントの認証後、ユーザーは*ジョブページ*に移動し、CircleCI を使用できます。

NOTE: A user who has authenticated with LDAP and is then removed from LDAP/AD will be able to access CircleCI as long as they stay logged in (because of cookies). As soon as the user logs out or the cookie expires, they will not be able to log back in. GitHub permissions define users' ability to see projects or to run builds. Therefore, if GitHub permissions are synced with LDAP/AD permissions, a removed LDAP/AD user will automatically lose authorization to view or access CircleCI as well.


=== トラブルシューティング

Troubleshoot LDAP server settings with LDAP search as follows:

`ldapsearch -x LLL -h <ldap_address_server>`
