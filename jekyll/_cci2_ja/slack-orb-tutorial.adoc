---

version:
- クラウド
- Server v2.x
- Server v3.x
---
= Slack Orb のチュートリアル
:page-layout: classic-docs
:page-liquid:
:page-description: "Learn how to get started with the CircleCI Slack orb"
:icons: font
:toc: macro
:toc-title:

このガイドでは CircleCI Slack Orb について説明します。

toc::[]

== はじめに

Orb は、再利用が可能な構成要素をまとめた共有可能なオープンソースパッケージです。 Orb を使うと、設定が簡易化され、サードパーティアプリとの連携がサポートされ、時間を節約することができます。

CircleCI で最も広く利用されている Orb は Slack です。 Slack Orb は、すべての CI/CD パイプラインにイベントベースの通知を実装することができます。 組み込まれているメッセージテンプレートまたは Slack のビジュアルBlock Kit Builder を使って、組織のニーズに合わせて通知を作成およびカスタマイズすることができます。

このチュートリアルでは、以下について説明します。

* Slack Orb を使って `config.yml` ファイルを作成する方法
* Slack の認証情報をコンテキストに保存する方法
* テンプレートを使って成功および失敗したビルドのアラートを作成する方法
* 特定のチャンネル、チーム、人々にアラートを送信する方法
* Slack Block Kit Builder を利用して独自のカスタムアラートを作成する方法

このチュートリアルに沿って実行するには、以下の準備が必要です。

* CircleCI のアカウント: アカウントをお持ちでない場合は、<<first-steps#,無料で登録していただけます。>>
* GitHub や BitBucket などのバージョン管理システム (VCS)
* https://slack.com[Slack のワークスペース]（会社のワークスペースを使用したくない場合は、テスト用にご自身のワークスペースを作成することも可能です。）

== ステップ 1: config.yml file を作成する

まだ作成していない場合は、リポジトリのルートに `.circleci` フォルダを作成します。 この `.circleci` フォルダーの中に `config.yml` ファイルを作成します。

下記のサンプルコードを `config.yml` にコピー & ペーストします。

[source,yaml]
----
version: 2.1
orbs:
  slack: circleci/slack@4.9.3
jobs:
  notify:
    docker:
      - image: 'cimg/base:stable'
    steps:
      - slack/notify:
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "plain_text",
                      "text": "*This is a text notification*",
                      "emoji": true
                    }
                  ]
                }
              ]
            }
          event: always
workflows:
  send-notification:
    jobs:
      - notify:
          context: slack-secrets

----

上記サンプルコードの主な要素について、以下で解説します。

* *1 行目:* お使いの設定ファイルのバージョンを指定します。 `2.1` が最新バージョンです。
* *2-3 行目:* Orb スタンザです。 使用しているのは `slack: circleci/slack@4.9.3` Orb です。
* *5-7 行目:* _notify_ というジョブです。基本的な Docker コンテナで実行されます。
* *8-9 行目:* _slack/notify_ という Slack Orb と連動するためのステップです。
* *10-24 行目:* このカスタムブロックには Slack Block Kit Builder からの基本的な通知が含まれます。 お分かりのように、JSON 形式です。 パート 3 では、より高度なテンプレートを使用します。
* *25 行目:*  `event: always` パラメーターは、この通知が _すべて_ のイベントタイプにトリガーされていることを意味します。 パート 3 では、各イベント毎に異なる通知を使用します。
* *30 行目:* ここでは、ステップ 2 で Slack の認証情報を保存する CircleCI コンテキストを参照します。

`config.yml` 基本ファイルの設定が完了しました。CircleCI と Slack を接続できます。

IMPORTANT: この時点でお客様の `config.yml` をコミットし、パイプラインをトリガーすると、ビルドが失敗します。 次のステップで Slack 認証情報を追加する必要があリます。

== ステップ 2: CircleCI と Slack を接続する 

ここでは以下を行います。

* Slack から API トークンを取得する
* コンテキストを作成し、CircleCI に認証情報を保存する
* 通知を受け取るようにパイプラインをトリガーする

=== アプリケーションの認証

Slack Orb は、CircleCI 上でジョブの一部として実行されるアプリケーションです。 通知を受け取る前に、アプリケーションを認証する必要があります。

==== Slack アプリの作成

. https://api.slack.com/apps[Slack API ウェブサイトの *Your Apps*] に行き、緑色の *Create an App* をクリックします。
+
image::slack-orb-create-app.png[Create a Slack app]
. *From scratch* を選択します。
+
image::slack-orb-from-scratch.png[Choose From scratch]
. アプリに、_CircleCI_ などの名前をつけて、アプリを使用する Slack ワークスペースを選択します。 このワークスペースは、後で変更できません。
+
image::slack-orb-name-app.png[Name your Slack app]
. 緑色の **Create App** ボタンをクリックします。

==== アプリのアクセス許可の設定

. Basic Information のページで、_Add features and functionality_ の下にある **Permissions** を見つけます。
+
image::slack-orb-permissions.png[Slack app Permissions]
. _OAuth & Permissions_ のページで、**Scopes** までスクロールダウンします。 ここで Slack アプリのアクセス許可を作成します。
+
image::slack-orb-add-scope.png[Add an OAuth Scope]
. **Bot Token Scopes** の下にある **Add an OAuth Scope** をクリックします。
. The Slack orb needs permission to post chat messages and upload files, so create the following scopes:
* chat:write
* chat:write.public
* files:write
+
image::slack-orb-bot-token-scopes.png[Add Bot Token Scopes]

TIP: To receive Slack notifications in a private channel, you need to add your Slack app to that channel. Open the channel, click the photos of the channel members in the top right-hand corner, then click the *Integrations* tab. From here, you can add an app.

==== Installing your app

. Once you have created your scopes, scroll up to the top of the page and click the **Install to Workspace** button.
+
image::slack-orb-install-workspace.png[Install to Workspace]
. You will then be asked to grant permission for the app to access your Slack workspace.
+
image::slack-orb-allow.png[Allow access]
. Click the disclosure triangle to double-check the permissions, then click the green **Allow** button.
. You should see a *Bot User OAuth Token*. Copy this token to your clipboard, ready to add it to CircleCI. Make sure you keep this private.
+
image::slack-orb-copy-token.png[Copy OAuth Token]

=== Creating a context

In CircleCI, contexts allow you to secure and share environment variables across projects. Once you have created a context with your Slack credentials, you and your colleagues will be able to reuse them.

In CircleCI:

. Click the _Organization Settings_ page.
+
image::slack-orb-organization-settings.png[Organization Settings]
. Under Context, click the blue *Create Context* button and add a unique name, such as _slack-secrets_ (that is the name specified in the `config.yml` file above).
+
image::slack-orb-create-context.png[Create Context]
. Click the blue **Create Context** button.
. Click the name of the context you just created.
. Click the blue *Add Environment Variable* button and enter your first key value pair.
* The Environment Variable Name is `SLACK_ACCESS_TOKEN`.
* The value is your Slack Bot User OAuth Access Token.
+
image::slack-orb-environment-variable.png[Add Environment Variable]
. Click the Add Environment Variable button to save it.
. Click the blue **Add Environment Variable** button again.
* The Environment Variable Name is `SLACK_DEFAULT_CHANNEL`.
* The value is the ID of the default Slack channel for posting your notifications. You can override this setting in your individual jobs.

TIP: To get the ID for your Slack channel, right-click the channel in Slack and choose **Copy Link**. The ID will be visible at the end of the URL and will be in this format: C034R26AM36.

image::slack-orb-copy-link.png[Copy Slack channel link]

Make sure you have included the _slack-secrets_ context in your _notify_ job and that the name matches what you created:

[source,yaml]
----
workflows:
  send-notification:
    jobs:
      - notify:
          context: slack-secrets
----

You can now reuse this context in other jobs and projects.

Commit your `config.yml` file (and push it, if you are working remotely).

==== Triggering an alert

In the CircleCI dashboard:

* Click **Projects**.
* Find the repo and click the blue **Set Up Project** button next to it.
+
image::slack-orb-set-up-project.png[Set up Project]
* Choose the branch on which you committed your `config.yml` file
+
image::slack-orb-select-config-file.png[Select your config.yml file]
* Click the blue **Set Up Project** button.

This triggers your CircleCI pipeline, which contains a Slack orb with your credentials.

You should then see a green **Success** badge and a green tick next to your _notify_ job.

image::slack-orb-success.png[Success]

Click on your job to see what just happened. You should see the message body that was sent to Slack.

Now open your Slack workspace. In the default channel you specified earlier, you should see the alert triggered by your CircleCI pipeline.

image::slack-orb-text-notification.png[Slack text notification]

Although this is a basic alert, you have achieved a lot already:

* Created a `.circleci/config.yml` file with the Slack orb.
* Created a context to store your Slack-related environment variables.
* Created a Slack app.

== Step Three - Use Message Templates

The Slack orb includes several notification templates you can use to notify your channel of various CircleCI events:

* `basic_success_1` - for _pass_ events where the job succeeded.
* `basic_fail_1` -  for_fail_ events, where the job failed.
* `success_tagged_deploy_1` - for successful deployments.
* `basic_on_hold_1` - for on-hold jobs that are awaiting approval.

To use these templates in your job, include the `event` and `template` parameters under `steps` in the `config.yml` file. 例えば下記のようにします。

[source,yaml]
----
jobs:
  notify:
    docker:
      - image: 'cimg/base:stable'
    steps:
- slack/notify:
	  event: fail
	  template: basic_fail_1
- slack/notify:
	  event: pass
	  template: success_tagged_deploy_1
----

* *Line 7* specifies that the template on the next line is used for failed events.
* *Line 8* specifies the template to be used, in this case `basic_fail_1`.
* *Line 9* specifies that the template on the next line is used for pass events.
* *Line 10* specifies the template to be used, in this case `basic_success_1`.

Whereas in Step 1 you used an all-purpose alert, now you have included different steps according to whether the job has passed or failed. The Slack orb triggers the appropriate step.

Commit your updated `config.yml` file (and push it, if you are working remotely). Once the pipeline is complete, you should see a more sophisticated alert in your Slack channel.

image::slack-orb-deployment-successful.png[Deployment Successful alert]

=== Including additional parameters

You can also include a mention for a failed job, to alert a specific person or team:

[source,yaml]
----
- slack/notify:
	event: fail
	mentions: '@EngineeringTeam'
	template: basic_fail_1
----

To notify multiple channels, place the IDs in quotes and separate them with a comma:

[source,yaml]
----
- slack/notify:
    channel: 'ABCXYZ, ZXCBN'
    event: fail
    template: basic_fail_1

----

To restrict your alert to a specific branch, add a _branch_pattern_ parameter:

[source,yaml]
----
 - slack/notify:
      branch_pattern: main
      event: fail
      template: basic_fail_1
----

This is useful if you do not want to receive alerts for feature branches.

==== Using the Slack Block Kit Builder

If you would like to further customize your notifications, you can use the https://api.slack.com/block-kit/building[Slack Block Kit Builder]. This framework allows you to create sophisticated notifications, using images, form fields, and other interactive elements.

Once you have created your block (which is a JSON object), copy and paste it into your `config.yml` file within the _custom_ parameter:

[source,yaml]
----
- slack/notify:
    event: always
    custom: | # your custom notification goes here
      {
        "blocks": [
          {
            "type": "section",
            "fields": [
              {
                "type": "plain_text",
                "text": "*This is a text notification*",
                "emoji": true
              }
            ]
          }
        ]
      }

----

== まとめ

In this tutorial, you have configured the Slack orb to send CircleCI notifications to your Slack channel. You created a basic notification, built and authenticated your Slack app, and used templates.

For further configuration options, take a look at the https://circleci.com/developer/orbs/orb/circleci/slack[Slack orb documentation]. You can also find many more orbs in the https://circleci.com/developer/orbs[Orb Registry].