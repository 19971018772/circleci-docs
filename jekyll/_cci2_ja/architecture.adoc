---
description: このドキュメントでは、CircleCI Server v2 を構成する様々なサービスを紹介します。
version:
- 管理者
- Server v2.x
---
= CircleCI Server コンテナのアーキテクチャ
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

このドキュメントでは、CircleCI Server がインストールされた Services マシン上で実行されるコンテナ化されたサービスの概要を説明します。 これにより、サービス運用の概要を理解し、サービス停止時のトラブルシューティングに役立てていただくことを目的としています。 下記の表に、補足事項と要点を記載します。

toc::[]

[discrete]
=== 備考

* ここに記載されているデータベース移行サービスは、起動時にのみ実行されるため、障害時の重大度は低くなっています。
+
WARNING: 移行サービスが起動時にダウンしている場合、接続先のサービスが動作しません。

* Platinum サポートを利用している場合は、一部のサービスを外部化することができ (ここでは * を付けて示しています)、要件に合わせて管理できます。 外部化することで、データの安全性が高まり、システムに冗長性を持たせることができます。

[discrete]
=== 要点

[.table.table-striped]
[cols=2*, options="header", stripes=even]
|===
| アイコン
| 説明

| icon:check-circle[]
| 障害による本番環境への影響は小さく、データ損失や機能停止は発生しません。

| icon:exclamation-triangle[]
| 障害によって一部のジョブで問題が発生するおそれはありますが、データ損失は発生しません。

| icon:fire-extinguisher[]
| 障害によってデータ損失、ジョブ/ワークフローの破損、大規模な機能停止が発生するおそれがあります。
|===

<<<

== コンテナ、ロール、故障モード、スタートアップ時の依存関係

[.table.table-striped]
[cols=5*,^,*, options="header", stripes=even]
[cols="3,3,3,2,3"]
|===
| **コンテナ/イメージ**
| **役割**
| **障害発生時の影響**
| **障害の重大度**
| **スタートアップ時の依存関係**

| `api-service`
| GraphQL API を提供します。 この API は、Web フロントエンドのレンダリング データを多く提供します。
| 多くの UI 要素 (例: コンテキスト) が完全に機能しなくなります。
| icon:fire-extinguisher[]
| `postgres`、`frontend`、 `contexts-service-migrator`、`contexts-service`、`vault-cci`

| `audit-log-service`
| 監査ログ イベントを blob ストレージに長期保存します。
| 一部のイベントが記録されなくなります。
| icon:check-circle[]
| `postgres`、`frontend`

| `contexts-service`
| 暗号化されたコンテキストを保存、提供します。
| コンテキストを使用するすべてのビルドが失敗するようになります。
| icon:exclamation-triangle[]
| `postgres`、`frontend`、`contexts-service-migrator`、`vault-cci`

| `contexts-service-migrator`
| `contexts-service`用に PostgreSQL の移行を実行します。
| 起動時にのみ実行されます。
| icon:check-circle[]
| `postgres`、`frontend`

| `cron-service`
| スケジュールされたワークフローをトリガーします。
| スケジュールされたワークフローが実行されなくなります。
| icon:exclamation-triangle[]
| `postgres`、`frontend`、`cron-service-migrator`

| `cron-service-migrator`
| cron-service 用に PostgreSQL の移行を実行します。
| 起動時にのみ実行されます。
| icon:check-circle[]
| `postgres`、`frontend`

| `domain-service`
| CircleCI のドメイン モデルに関する情報を保存、提供します。
| ワークフローを開始できなくなります。 一部の REST API 呼び出しが失敗し、CircleCI UI で `500` エラーが発生する可能性があります。 LDAP 認証を使用している場合、すべてのログインが失敗するようになります。
| icon:fire-extinguisher[]
| `postgres`、`frontend`、`domain-service-migrator`

| `domain-service-migrator`
| `domain-service`用に PostgreSQL の移行を実行します。
| 起動時にのみ実行されます。
| icon:check-circle[]
| `postgres`、`frontend`

| `exim`
| すべての SMTP アウトバウンド メールの送信に使用されるメール転送エージェント (MTA)です。
| メール通知が送付されません。
| icon:check-circle[]
| なし

| `federation-service`
| ユーザー ID を保存します (LDAP)。 
| LDAP 認証を使用している場合、すべてのログインに失敗し、REST API 呼び出しも失敗する場合があります。
| icon:fire-extinguisher[] only if LDAP in use
| `postgres`、`frontend`、`federations-service-migrator`

| `federation-service-migrator`
| `federations-service` 用に PostgreSQL の移行を実行します。
| 起動時にのみ実行されます。
| icon:check-circle[]
| `postgres`、`frontend`

| `fileserved`
| CircleCI Server v2.x を AWS 外で実行する際に、S3 の代わりに使用されるファイルストレージサービスです。 サーバーが S3 を使用するように設定されている場合は使用されません。 ステップの出力ログ、アーティファクト、テスト結果、キャッシュ、ワークスペースを保存します。
| S3 を使用していない場合、ビルドは出力されず、一部の REST API 呼び出しが失敗する可能性があります。
| icon:fire-extinguisher[] if **not** using S3
| なし

| `frontend`
| CircleCI Web アプリと www-api プロキシ です。
| UI と REST API が利用できなくなります。 GitHub/GitHub Enterprise からジョブがトリガーされなくなります。 ビルドの実行はできますが、更新はされません。
| icon:exclamation-triangle[]
| `postgres`

| `mongo`*.
| Mongo のデータストアです。
| データ全体を損失するおそれがあります。 実行中のビルドがすべて失敗し、UI が機能しなくなります。
| icon:fire-extinguisher[]
| `mongodb-upgrader`

| `nomad-metrics`
| Queries the nomad server for stats and sends them to statsd.
| Nomad metrics will be lost, but everything else should run as normal.
| icon:check-circle[]
| None

| `output-processor` / `output-processing`
| Receives job output & status updates and writes them to MongoDB. Also provides an API to running jobs to access caches, workspaces, store caches, workspaces, artifacts, & test results.
| All running builds will either fail or be left in an unfixable, inconsistent state. There will also be data loss in terms of step output, test results and artifacts.
| icon:fire-extinguisher[]
| None

| `permissions-service`
| Provides the CircleCI permissions interface.
| Workflows will fail to start and some REST API calls may fail, causing 500 errors in the UI.
| icon:exclamation-triangle[]
| `postgres`, `frontend`, `permissions-service-migrator`

| `permissions-service-migrator`
| Runs postgresql migrations for the `permissions-service`
| Only runs at startup.
| icon:check-circle[]
| `postgres`, `frontend`

| `picard-dispatcher`
| Splits a job into tasks and sends them to `schedulerer` to be run.
| No jobs will be sent to Nomad, the run queue will increase in size but there should be no meaningful loss of data.
| icon:exclamation-triangle[]
| None

| `postgres` / `postgres-script-enhance` *
| Basic `postgresql` with enhancements for creating required databases when containers are launched.
| Potential total data loss. All running builds will fail and the UI will not work.
| icon:fire-extinguisher[]
| None

| `rabbitmq` / `rabbitmq-delayed` *
| Runs the RabbitMQ server. Most of our services use RabbitMQ for queueing.
| Potential total data loss. All running builds will fail and the UI will not work.
| icon:fire-extinguisher[]
| None

| `outputRunningRedis` / `redis` *
| The Redis key/value store.
| Lose output from currently-running job steps. API calls out to GitHub may also fail.
| icon:exclamation-triangle[]
| None

| `schedulerer`
| Sends tasks to `server-nomad` to run. \
| No jobs will be sent to Nomad, the run queue will increase in size but there should be no meaningful loss of data.
| icon:exclamation-triangle[]
| None

| `mongodb-upgrader` / `server-mongo-upgrader`
| Used to run any mongo conversion/upgrade scripts during mongo version upgrade.
| Not required to run all the time. \
| icon:check-circle[]
| None

| `nomad_server` / `server-nomad` *
| Nomad primary service.
| No 2.0 build jobs will run.
| icon:fire-extinguisher[]
| None

| `ready-agent` / `server-ready-agent`
| Called by Replicated to check whether other containers are ready.
| Only required on startup. If unavailable on startup the whole system will fail.
| icon:check-circle[]
| None

| `server-usage-stats`
| Sends the user count to the internal CircleCI “phone home” endpoint.
| CircleCI will not receive usage stats for your install but no affect on operation.
| icon:check-circle[]
| None

| `shutdown-hook-poller`
| Checks the `frontend` container for 1.0 Builder shutdown requests. If a request is found, the 1.0 Builder is shut down.
| 1.0 Builder lifecycles will not be properly managed, but jobs will continue to run.
| icon:check-circle[]
| None

| `slanger`
| Provides real-time events to the CircleCI app.
| Live UI updates will stop but hard refreshes will still work.
| icon:check-circle[]
| None

| `telegraf`
| This is the statsd forwarding agent that our local services write to and can be configured to forward to an external metrics service.
| Metics will stop working but jobs will continue to run.
| icon:check-circle[]
| None

| `tutum/logrotate`
| Used to manage log rotations for all containers on the services machine.
| If this stays down for a long period the Services machine disk will eventually run out of space and other services will fail.
| icon:exclamation-triangle[]
| None

| `test-results`
| Parses test result files and stores data.
| There will be no test failure or timing data for jobs, but this will be back-filled once the service is restarted.
| icon:check-circle[]
| None

| `contexts-vault` / `vault-cci` *
| Instance of Hashicorp’s Vault – an encryption service that provides key-management, secure storage, and other encryption related services. Used to handle the encryption and key store for the `contexts-service`.
| `contexts-service` will stop working, and all jobs that use `contexts-service` will fail.
| icon:exclamation-triangle[]
| None

| `vm-gc`
| Periodically check for stale `machine` and remote Docker instances and request that `vm-service` remove them.
| Old vm-service instances might not be destroyed until this service is restarted.
| icon:check-circle[]
| `vm-service-db-migrator`

| `vm-scaler`
| Periodically requests that `vm-service` provision more instances for running `machine` and remote Docker jobs.
| VM instances for `machine` and Remote Docker might not be provisioned causing you to run out of capacity to run jobs with these executors.
| icon:exclamation-triangle[]
| `vm-service-db-migrator`

| `vm-service`
| Inventory of available `vm-service` instances, and provisioning of new instances.
| Jobs that use `machine` or remote Docker will fail.
| icon:exclamation-triangle[]
| `vm-service-db-migrator`

| `vm-service-db-migrator`
| Used to run database migrations for `vm-service`.
| Only runs at startup.
| icon:check-circle[]
| None

| `workflows-conductor`
| Coordinates and provides information about workflows.
| No new workflows will start, currently running workflows might end up in an inconsistent state, and some REST and GraphQL API requests will fail.
| icon:fire-extinguisher[]
| `postgres`, `frontend`, `workflows-conductor-migrator`

| `workflows-conductor-migrator`
| Runs postgreSQL migrations for the `workflows-conductor`.
| Only runs on startup.
| icon:check-circle[]
| `postgres`, `frontend`
|===
