---
version:
- Cloud
---
= CircleCI ランナーの概要
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

NOTE: CircleCI ランナーは、https://circleci.com/ja/pricing[Scale プラン]をご利用のお客様と、CircleCI Server v3.1.0 以上をご利用のお客様に提供されています。 Scale プランへのお申し込み方法については、営業担当者 (またはhttps://circleci.com/ja/contact-us/?cloud[お問い合わせ窓口]) へお問い合わせください。

toc::[]

== はじめに

CircleCI ランナーを利用することで、自社インフラストラクチャでジョブを実行できるようになります。 これにより、ビルドとテストが可能なアーキテクチャの幅が広がるだけでなく、環境をより細かく制御することもできます。 下図は、CircleCI ランナーが既存のシステムをどのように拡張するのかを示しています。

.ランナーのアーキテクチャ
image::runner-overview-diagram.png[CircleCI Runner Architecture]

== CircleCI ランナーのユース ケース

CircleCI では、ランナーのユース ケースとして主に 2 つのシナリオを想定しています。

* 特権アクセスと制御 - 環境の分離に関する要件が厳しい企業では、オンプレミス環境やアクセス制限されたインフラストラクチャでジョブを実行するよう義務付けられている場合があります。 ランナーを使用することで、次のようなことが可能になります。
** IP 制限 - 自社で制御可能な静的 IP アドレスを使用できます。
** ID とアクセス管理 (IAM) 権限 - AWS にセットアップしたランナーに、IAM の権限を割り当てることができます。
** オペレーティング システムの監視
** プライベート ネットワークへの接続

* 企業独自のコンピューティング要件 - CircleCI のリソース クラスとして提供されていない環境やアーキテクチャでジョブを実行する必要のあるお客様は、ランナーを使用してニーズを満たすことができます。

== 利用可能な CircleCI ランナー プラットフォーム

CircleCI ランナーは、複数のプラットフォームに対応しています。 サポート レベルは、次の 2 つのカテゴリに分かれます。

* <<サポート対象>>
* <<プレビュー>>

=== Supported

*サポート対象*レベルのプラットフォームでは、各システムで CircleCI ランナーのビルドとテストが完了しています。

*サポート対象*プラットフォームには、以下が提供されます。

* ドキュメントとベスト プラクティス
* サポート: CircleCI カスタマー エンジニアによる、ゴールド サポートで規定されている通常のサービス レベル アグリーメント (SLA) の範囲内の問題解決支援

*サポート対象*の CircleCI ランナーは、次のプラットフォームで利用できます。

* Ubuntu 18.04 以降 (x86_64 または ARM64)
* RHEL8-x86_64
* Mac OS X 10.15 以降 (Intel)
* macOS 11.2 以降 (Apple M1)
* Docker (x86_64)
* Kubernetes (x86_64)
* Windows Server 2019, 2016 (x86_64)

=== Preview

*プレビュー* レベルのプラットフォームでは、CircleCI ランナーは開発途中であり、テストが完了していません。

*プレビュー* プラットフォームには、以下が提供されます。

* 試作段階の完全なインテグレーション (そのため、インストール、構成、デプロイには、手動の構成作業がある程度必要な可能性があります)
* 試作段階のドキュメントとベスト プラクティス
* サポート: CircleCI カスタマー エンジニアによる、CircleCI ランナーのインストール、構成、運用のベスト プラクティスの支援とガイダンス
** CircleCI ランナーのユーザー エクスペリエンスを迅速に改善し、ランナーが*サポート対象*プラットフォームの必須基準を満たせるよう、ぜひフィードバックをお寄せください。

*プレビュー*の CircleCI ランナーは、次のプラットフォームで利用できます。

* 上記以外の Linux ディストリビューション - RHEL、SUSE、Debian など (x86_64 または ARM64)
* Docker (ARM64)
* Kubernetes (ARM64)

NOTE: プレビューの CircleCI ランナーは現在鋭意開発中です。環境に対するサポートやユースケースに関するご質問がある場合はhttps://circleci.com/ja/contact/[お問い合わせ]ください。 また、https://circleci.canny.io/cloud-feature-requests[フィードバック]やhttps://discuss.circleci.com/t/self-hosted-runners-are-here/38159[ランナーのディスカッション ページ]への投稿もぜひお寄せください。開発の参考にさせていただきます。

== 使用方法

CircleCI ランナーの利用を開始するには、次の手順を実行します。

* https://circleci.com/ja/contact/[お問い合わせ]から Scale プランの無料トライアルに申し込みます (登録がお済みでない場合)。
* Provide your own platform to deploy your CircleCI runners (See the <<Available CircleCI runner platforms>> section)
* CircleCI ランナーをxref:runner-installation.adoc[インストール]します。

== CircleCI ランナーの運用

CircleCI ランナーのインストール後、ランナーは `circleci.com` をポーリングしてプロジェクトを検出し、ジョブを実行して、ステータス、ログ、アーティファクトを CircleCI に報告します。 新しいバージョンがリリースされると、ランナーはジョブを実行していないときに自動で更新されます。

ランナーは、ローンチ エージェントとタスク エージェントという 2 つの要素で構成されます。

* ローンチ エージェント (launch-agent) - タスクの実行 (1 つのジョブを分解して行う並列実行) に必要な情報の収集と、タスク エージェント プロセスのダウンロードおよび起動を行います。
* タスク エージェント (task-agent) - ローンチ エージェントによって取得、設定されたタスクの実行を行います。

この仕組みにより、管理者は、task-agent が launch-agent よりも低い権限レベルで実行されるよう構成できます。 ジョブの実行を許可したすべてのユーザーには、task-agent と同等の権限が付与されます。 以降で説明するデプロイメントの推奨事項は、このアプローチに基づいています (ローンチ エージェントは root ユーザー、タスク エージェントは circleci ユーザーとして実行されます)。

== Debugging with SSH

CircleCI runner supports rerunning a job with SSH for debugging purposes. Instructions on using this feature can be found at <<ssh-access-jobs#,Debugging with SSH>>.

NOTE: The 'Rerun job with SSH' feature is disabled by default. To enable this feature, see xref:runner-installation.adoc#runner-ssh-advertise_addr[Installing the CircleCI Runner].

== Public repositories

CircleCI runner is not recommended for use with public projects that have the "Build forked pull requests" setting enabled. In this case, a malicious actor may alter your machine or execute code on it by forking your repository, committing code, and opening a pull request. Untrusted jobs running on your CircleCI runner pose significant security risks for your machine and network environment, especially if your machine persists its environment between jobs. Some of the risks include:

* Malicious programs running on the machine.
* Escaping the machine's runner sandbox.
* Exposing access to the machine's network environment.
* Persisting unwanted or dangerous data on the machine.

== Referencing your runner on a job

After setting up the runner, you will need to reference it on a job by setting some fields in a special way in your `.circleci/config.yml` file. The fields you must set for a specific job to run using your runner are:

* `machine: true`
* `resource_class: your-namespace/your-resource`

Here is a simple example of how you could set up a job.

```yaml
version: 2.1
workflows:
  testing:
    jobs:
      - runner
jobs:
  runner:
    machine: true
    resource_class: your-namespace/your-resource
    steps:
      - run: echo "Hi I'm on Runners!"
```
The job will then execute using your runner when you push the config to your VCS provider.

NOTE: A namespace is a unique identifier claimed by a user or organization. Each user or organization can claim one unique and immutable namespace. Organizations are, by default, limited to claiming only one namespace. This policy is designed to limit name-squatting and namespace noise. If you need to change your namespace, please https://support.circleci.com/hc/en-us[contact support].

== Limitations

Almost all standard CircleCI features are available for use with runner jobs, but at present a few features are not yet supported. If these features are important for you to make use of runner jobs, please let us know via the relevant canny page.

- https://circleci.canny.io/runner-feature-requests/p/support-test-splitting-on-self-hosted-runners[Test Splitting]
- https://circleci.canny.io/runner-feature-requests/p/support-addsshkey-on-self-hosted-runners[`add_ssh_keys`]

== Learn more

Take the https://academy.circleci.com/runner-course[runner course] with CircleCI Academy to learn more about running jobs on your infrastructure.


