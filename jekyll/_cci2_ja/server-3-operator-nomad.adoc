---

version:
- Server v3.x
- サーバー管理者
---
= Nomad クラスタの操作ガイド
:page-layout: classic-docs
:page-liquid:
:page-description: Learn how to operate the Nomad Cluster in your CircleCI 2.0 installation.
:icons: font
:toc: macro
:toc-title:

CircleCI では、プライマリジョブスケジューラとして https://www.hashicorp.com/blog/nomad-announcement/[Nomad] を使用します。 This section provides a basic introduction to Nomad for understanding how to operate the Nomad Cluster in your CircleCI installation.

toc::[]

== 基本的な用語とアーキテクチャ

.Nomad クラスタの管理
image::nomad-diagram-v2.png[Diagram of the Nomad cluster]

<<<

- **Nomad サーバー:** Nomad サーバーは、Nomad クラスタの "頭脳" です。 ジョブを受け取り、Nomad クライアントに割り当てます。 CircleCI Server では、Nomad サーバーは Kubernetes クラスタ内でサービスとして実行されます。
- **Nomad クライアント:** Nomad クライアントは、Nomad サーバーによって割り当てられたジョブを実行します。 Usually a Nomad client runs on a dedicated machine (often a VM) to take full advantage of machine power. 複数の Nomad クライアントで 1つのクラスタを構成することができ、Nomad サーバーはスケジュールアルゴリズムに従ってクラスタにジョブを割り当てます。
- **Nomad ジョブ:** Nomad ジョブは、Nomad のワークロードを宣言するユーザーによる仕様です。 Nomad ジョブは、CircleCI ジョブの実行に対応しています。 If the job uses parallelism, for example 10 parallelism, then Nomad runs 10 jobs.
- **ビルドエージェント:** ビルドエージェントは、CircleCI 製の Go プログラムです。ジョブ内のステップを実行し、結果を報告します。 ビルドエージェントは、Nomad ジョブ内でメインプロセスとして実行されます。

== 基本的な操作

ここでは、CircleCI での Nomad クラスタの基本的な操作について説明します。

Nomad Pod には `nomad` CLI がインストールされています。 It is preconfigured to talk to the Nomad cluster, so it is possible to use `kubectl` along with the `nomad` command to run the commands in this section.

=== ジョブステータスの確認

The get a list of statuses for all jobs in your cluster, run the following command:

kubectl exec -it nomad-server-pod-ID -- nomad status

`Status` は、出力内容のうち最も重要なフィールドで、以下のステータスが表示されます。

- `running`: Nomad でジョブの実行が開始されています。 このステータスは通常、CircleCI 上のジョブが開始されたことを意味します。
- `pending`: クラスタ内でジョブを実行するためのリソースが不足している状態です。
- `dead`: Nomad によるジョブの実行が終了しています。 対応する CircleCI ジョブまたはビルドが成功したか失敗したかにかかわらず、ステータスは dead になります。

=== クラスタステータスの確認

To get a list of your Nomad clients, run the following command:

kubectl exec -it nomad-server-pod-ID -- nomad node-status

NOTE: `nomad node-status` コマンドを実行すると、現在稼働中の Nomad クライアント (ステータスが active) と、クラスタから除外された Nomad クライアント (ステータスが down) の両方が報告されます。 そのため、現在のクラスタの容量を知るには、ステータスが active な Nomad クライアントの数を数える必要があります。

To get more information about a specific client, run the following command from that client:

kubectl exec -it nomad-server-pod-ID -- nomad node-status -self

This gives information such as how many jobs are running on the client and the resource utilization of the client.

=== ログの確認

Nomad ジョブのセクションで前述したように、Nomad ジョブは CircleCI ジョブの実行と対応しています。 そのため、CircleCI ジョブで問題が発生した場合、Nomad ジョブのログを確認すると、そのジョブのステータスを理解するのに役立つことがあります。 To get logs for a specific job, run the following command:

kubectl exec -it nomad-server-pod-ID -- nomad logs -job -stderr <nomad-job-id>

NOTE: Be sure to specify the `-stderr` flag, as this is where most Build Agent logs appear.

`nomad logs -job` コマンドは便利ですが、`-job` フラグは指定されたジョブのランダム割り当てを使用するため、必ずしも正確とは限りません。 The term `allocation` is a smaller unit in Nomad Job, which is beyond the scope of this document. 詳細については、 https://www.nomadproject.io/docs/internals/scheduling.html[公式ドキュメント] を参照してください。

指定されたジョブの割り当てからログを取得するには、以下の手順に従います。

. `nomad status` コマンドで、ジョブ ID を取得します。
. `nomad status <job-id>` コマンドで、ジョブの割り当て ID を取得します。
. `nomad logs -stderr <allocation-id>` で、割り当てからログを取得します。

=== Nomad クライアントのシャットダウン

Nomad クライアントをシャットダウンするときは、まずクライアントをドレイン (drain) モードに設定する必要があります。 `drain` モードのクライアントでは、それまでに割り当てられたジョブは完了しますが、新たにジョブを割り当てることはできません。

. クライアントをドレインするには、クライアントにログインし、`node-drain`  コマンドを以下のように使用して、クライアントをドレインモードに設定します。
+
nomad node-drain -self -enable
. 次に、 `node-status` コマンドを使用してクライアントがドレインモードに変更されていることを確認します。
+
nomad node-status -self

また、下記のコマンドにノード ID を代入して実行し、リモートノードをドレインモードに設定することもできます。

nomad node-drain -enable -yes <node-id>

=== クライアントクラスタのスケールダウン

クライアントをシャットダウンするメカニズムを設定するには、まずクライアントを `drain`  モードに変更し、すべてのジョブが完了してから、クライアントを終了させます。 https://docs.aws.amazon.com/autoscaling/ec2/userguide/lifecycle-hooks.html[ASG ライフサイクルフック] を設定することで、インスタンスをスケールダウンするスクリプトをトリガーできます。

このスクリプトで、上述のコマンドを使用して以下の手順を実行します。

. Put the instance in drain mode.
. Monitor running jobs on the instance and wait for them to finish.
. Terminate the instance.