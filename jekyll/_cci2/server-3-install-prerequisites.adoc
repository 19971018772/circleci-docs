---
version:
- Server v3.x
- Server Admin
---
= CircleCI Server v3.x Installation Phase 1: Prerequisites
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

== Overview
Install CircleCI server in 4 phases. There is a validation step at the end of each phase, allowing you to confirm success before moving to the next phase. Depending on your requirements, phases 3 and 4 may have multiple steps. 

[INSERT INSTALLATION PHASE DIAGRAM]

NOTE: It is assumed you have already read the server 3.x https://circleci.com/docs/2.0/server-3-overview[overview].

== Phase 1: Prerequisites
=== Install required software
Download and install the following software before continuing: 

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
| Tool
| Version
| Used for

| https://www.terraform.io/downloads.html[Terraform]
| {terraformversion} or greater
| Infrastructure Management

| https://kubernetes.io/docs/tasks/tools/install-kubectl/[kubectl]
| {kubectlversion} or greater
| Kubernetes CLI

| https://helm.sh/[Helm]
| {helmversion} or greater
| Kubernetes Package Management

| https://kots.io/[Kots]
| {kotsversion} or greater
| Replicated Kubernetes Application Management
|===

=== Create a Kubernetes cluster
CircleCI server installs into an existing Kubernetes cluster. The application uses a large number of resources. Depending on your usage, your Kubernetes cluster should meet the following requirements: 

[.table.table-striped]
[cols=5*, options="header", stripes=even]
|===
| Number of daily active CircleCI users
| Minimum Nodes
| Total CPU
| Total RAM
| NIC speed

| < 500
| 3
| 12 cores
| 32 GB
| 1 Gbps

| 500+
| 3
| 48 cores
| 240 GB
| 10 Gbps
|===

Creating a Kubernetes cluster is your responsibility. Please note:

* Your cluster must have outbound access to pull Docker containers and verify your license. If you do not want to provide open outbound access, see our https://help.replicated.com/community/t/customer-firewalls/55[list of ports] that will need access.
* You must have appropriate permissions to list, create, edit and delete pods in your cluster. Run this to verify your permissions: 
+
`kubectl auth can-i <list|create|edit|delete> pods`
* There are no requirements regarding VPC setup or disk size for your cluster. It is recommended that you
set up a new VPC rather than use an existing one.

==== EKS
You can learn more about creating an Amazon EKS cluster https://aws.amazon.com/quickstart/architecture/amazon-eks/[here]. We recommend using https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html[`eksctl`] to create your cluster, which will create a VPC and select the proper security groups for you. 

. https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html[Install] and https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html[configure] the AWS CLI for your AWS account. 
. Install https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html[`eksctrl`].
. Create your cluster by running the following (Cloud formation with `eksctl` and EKS can take upwards of 20 minutes to complete): 
+
```bash
eksctl create cluster --name=circleci-server --nodes 4 --node-type m5.xlarge
```

Once the cluster has been created, you can use the following command to configure `kubectl` access: 
```bash
eksctl utils write-kubeconfig --name circleci-server
```

NOTE: You may see the following error `AWS STS Access - cannot get role ARN for current session: InvalidClientTokenID`. This means your AWS credentials are invalid, or your IAM user does not have permission to create an EKS cluster. Proper IAM permissions are necessary in order to use `eksctl`. See the AWS documentation regarding https://aws.amazon.com/iam/features/manage-permissions/[IAM permissions]. 

==== GKE
You can learn more about creating a GKE cluster https://cloud.google.com/kubernetes-engine/docs/how-to#creating-clusters[here]. 

CAUTION: Do not use an Autopilot cluster. CircleCI requires functionality that is not supported by GKE Autopilot. 

NOTE: In the following steps replace any items credentials displayed between `< >` with your details.

. https://cloud.google.com/sdk/gcloud[Install] and https://cloud.google.com/kubernetes-engine/docs/quickstart#defaults[configure] the GCP CLI for your GCP account. This includes creating a Google Project, which will be required to create a cluster within your project. When you create your project make sure you also enabled API access. If you do not enable API access, the command we will run next, to create your cluster, will fail. 
. Create your cluster by entering running the following: 
+
```sh
gcloud container clusters create circleci-server --project <YOUR_GOOGLE_CLOUD_PROJECT_ID> --region europe-west1 --num-nodes 3 --machine-type n1-standard-4
``` 
. Configure` kubectl` with your your credentials gcloud credentials: 
+
```sh
gcloud container clusters get-credentials circleci-server --region europe-west1
```
. Verify your cluster: 
+
```sh
kubectl cluster-info
```
. Create a service account for this cluster: 
+
```sh
gcloud iam service-accounts create <YOUR_SERVICE_ACCOUNT_ID> --description="<YOUR_SERVICE_ACCOUNT_DISPLAY_NAME>"  --display-name="<YOUR_SERVICE_ACCOUNT_DISPLAY_NAME>"
```
. Get the credentials for the service account: 
+
```sh
gcloud iam service-accounts keys create <PATH_TO_STORE_CREDENTIALS> --iam-account <SERVICE_ACCOUNT_ID>@<YOUR_GOOGLE_CLOUD_PROJECT_ID>.iam.gserviceaccount.com
```

=== Create a new GitHub OAuth app
Registering and setting up a new GitHub OAuth app for CircleCI server allows for authorization control to your server installation using GitHub OAuth and for updates to GitHub projects/repos using build status information.

. In your browser navigate to **your GitHub instance** > **Settings** > **Developer Settings** > **OAuth Apps** and click the **New OAuth App** button. 

. Complete the following fields based on your planned installation: 
** Homepage URL: The URL of your planned CircleCI installation.
** Authorization callback URL: The authorization callback URL will be the URL of your planned CircleCI installation followed by /auth/github 

=== Frontend TLS certificates
==== Google Cloud DNS
==== AWS Route53

=== Encryption/signing keys
==== Artifact signing key
==== Encryption signing key

=== Object storage and permissions
==== Create an S3 storage bucket
===== Step 1
===== Step 2
===== Step 3
===== Step 4

==== Create a Google Cloud storage bucket
===== Step 1
===== Step 2
===== Step 3
===== Step 4

*** https://aws.amazon.com/premiumsupport/knowledge-center/eks-cluster-connection/[Connect to Amazon EKS clusters] - Amazon EKS
*** https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl[Configuring cluster access for kubectl] - Google GKE
* Port access requirements are listed here:
** xref:server-3-install-hardening-your-cluster.adoc#kubernetes-load-balancers[Kubernetes Load Balancers]
** xref:server-3-install-hardening-your-cluster.adoc#kubernetes-nodes[Kubernetes Nodes]
** xref:server-3-install-hardening-your-cluster.adoc#nomad-clients[Nomad Clients]
** xref:server-3-install-hardening-your-cluster.adoc#external-vms[External VMs]


* An existing Kubernetes cluster (see xref:server-3-install-creating-your-first-cluster.adoc[our guide] if you need help creating one), for example:
** Creating an Amazon EKS cluster - https://aws.amazon.com/quickstart/architecture/amazon-eks/[Amazon EKS]
*** Using https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html[`eksctl`] is our recommended option, as it creates a VPC and selects the proper security group for you.
** Creating clusters - https://cloud.google.com/kubernetes-engine/docs/how-to#creating-clusters[Google GKE] +
*** Do NOT use an Autopilot cluster. CircleCI requires functionality that is not supported by GKE Autopilot.
+
* Note your Kubernetes cluster must meet the following minimum overall cluster requirements relative to the number of active
CircleCI server users: 


## What to read next
* https://circleci.com/docs/2.0/server-3-install-creating-your-first-cluster[Creating your first cluster]
* https://circleci.com/docs/2.0/server-3-install[Server 3.x Installation]
