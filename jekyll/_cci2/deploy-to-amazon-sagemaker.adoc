---
contentTags:
  platform:
  - Cloud
  - Server v4.x
  - Server v3.x
---
= Deploy to Amazon SageMaker
:page-layout: classic-docs
:page-liquid:
:page-description: A short page description goes here
:icons: font
:experimental:

NOTE: CircleCI releases is currently in **open preview**. During open preview release features are available for free. Charges will be associated with release features once they are generally available. The link:https://circleci.com/developer/orbs/orb/circleci/aws-sagemaker[SageMaker orb] is also in **open preview**.

This how-to guide will walk you through the steps to set up and use the Amazon SageMaker orb to deploy and release models to SageMaker, and track those releases in the CircleCI release dashboard with the ability to manage promotions and rollbacks. You will orchestrate model deployments to endpoints across different environments. The link:https://github.com/CircleCI-Public/sagemaker-deploy-examples#[example project repository] allows you to train a new model package version and then deploy it across multiple environments.

For further information about the orb and the releases feature see the following:

* xref:releases/releases-overview#[Releases overview]
* link:https://circleci.com/developer/orbs/orb/circleci/aws-sagemaker[Amazon SageMaker orb]

[#prerequisites]
== Prerequisites

To follow along with this how-to guide you will need the following:

* A CircleCI account connected to your code. You can link:https://circleci.com/signup/[sign up for free]
* Basic knowledge of Amazon SageMaker
* An AWS account with access to SageMaker and a SageMaker studio domain
* A copy of the link:https://github.com/CircleCI-Public/sagemaker-deploy-examples[example repo]

[#set-up-a-circleci-release-environment]
== 1. Set up a CircleCI release environment

First, set up a release environment to monitor your releases from the CircleCI web app, and access options to manage promotions and rollbacks.

. In the CircleCI web app, select **Releases** from the sidebar
. If this is your first release environment, you will see an option to btn:[Add Release Environment]. If not, Click btn:[Configure Environments] in the top right corner, and then click btn:[Configure New Environment]
+
image::deploy/add-release-environment.png[Screenshot showing option to add a new release environment]
. In the popup, select **Amazon SageMaker** from the "Environment" dropdown. Give your new environment a name, and click btn:[Create Environment]
+
image::deploy/create-new-environment.png[Screenshot showing new release environment popup]
. Click on your new environment name to enter the environment view
. Click btn:[Create New Token]
+
image::deploy/release-create-new-token.png[Screenshot showing create new token button]
. Click btn:[Create Token]. Be sure to save this token, you will create an environment variable later to store it.

[#set-up-amazon-sagemaker-access]
== 2. Set up Amazon SageMaker access

[#oidc-identity-provider]
=== a. OIDC Identity Provider

In this section you will create an IAM (Identity and Access Management) Identity Provider in your AWS IAM for the CircleCI OIDC Provider. The Amazon SageMaker orb uses OIDC. You may already have this set up, in which case you can skip this section. For more information on CircleCI OIDC functionality, see the xref:openid-connect-tokens#authenticate-jobs-with-cloud-providers[Using OpenID Connect tokens in jobs] page.

. Navigate to your AWS Management Console
. Go to menu:IAM[Access management > Identity providers]
. Select **Add Provider**
+
image::deploy/aws-iam-add-provider.png[Screenshot showing AWS management console Add Provider option]
. Under "Provider Type", select **OpenID Connect**
. Enter your "Provider URL". This will be `\https://oidc.circleci.com/org/<your-organization-id>`, where `<your-organization-id>` is the ID of your CircleCI organization.
+
{% include snippets/find-organization-id.adoc %}
. Click **Get Thumbprint**
. For "Audience" enter your organization ID
. Click btn:[Add Provider]

Next, create a Policy and then a Role.

[#policy]
=== b. Policy

. From your AWS management console, navigate to menu:IAM[Policies]
. Click btn:[Create Policy]
. Click btn:[JSON] to select the JSON policy editor and then copy in the following permissions. We have organized the permissions into two groups. OrbPermissions and S3Access statements are used for the deployment of the model to the endpoints. The S3AccessTrainModel and SageMakerTrainModel statements are needed if you want to train the demo model we provide.
+
NOTE: Update the S3 bucket information to match your setup. Create a bucket if one does not yet exist.
+
[,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "OrbPermissions",
            "Effect": "Allow",
            "Action": [
                "sagemaker:AddTags",
                "sagemaker:CreateEndpointConfig",
                "sagemaker:CreateModel",
                "sagemaker:DescribeEndpoint",
	 	        "sagemaker:DescribeEndpointConfig",
                "sagemaker:ListEndpoints",
                "sagemaker:ListModelPackages",
                "sagemaker:ListTags",
                "sagemaker:UpdateEndpoint",
                "iam:PassRole"
            ],
            "Resource": "*"
        },
        {
            "Sid": "S3Access",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::<BUCKET_FOR_MODEL_ASSETS>/*"
            ]
        },
        {
            "Sid": "S3AccessTrainModel",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:ListBucket",
                "s3:PutObject"
            ],
            "Resource": [
                "arn:aws:s3:::sagemaker-sample-files/*",
                "arn:aws:s3:::circleci-sagemaker-pipeline",
                "arn:aws:s3:::circleci-sagemaker-pipeline/*"
            ]
        },
        {
            "Sid": "SageMakerTrainModel",
            "Effect": "Allow",
            "Action": [
                "sagemaker:CreateTrainingJob",
                "sagemaker:DescribeTrainingJob",
                "logs:DescribeLogStreams",
                "sagemaker:ListModelPackageGroups",
                "sagemaker:CreateModelPackage",
                "sagemaker:UpdateModelPackage"
            ],
            "Resource": "*"
        }
    ]
}
----

. Scroll down and click btn:[Next]
. Give your policy a name and then click btn:[Create Policy]

[#role]
=== c. Role

. From your AWS management console, navigate to menu:IAM[Roles]
. Click **Create Role**
. Select **Web Identity** and then select the CircleCI provider you created above, and under Audience, select your org ID
. Use the search function to find the policy you created above by name, select it and click btn:[Next]
. Give your Role a name, and then scroll to the Trust policy section. Set up the Trust relationship between the Role and the CircleCI OIDC Provider. Here is an example Policy.
+
NOTE: you must replace the placeholders <CIRCLECI-ORG-ID> and <CIRCLECI-PROJECT-ID> with your proper info.
+
[,json]
----
{
	"Version": "2012-10-17",
	"Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::<AWS-ACCOUNT-ID>:oidc-provider/oidc.circleci.com/org/<CIRCLECI-ORG-ID>"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringLike": {
                    "oidc.circleci.com/org/<CIRCLECI-ORG-ID>:sub": "org/<CIRCLECI-ORG-ID>/project/<CIRCLECI-PROJECT-ID>/user/*"
                }
            }
        },
        {
			"Effect": "Allow",
			"Principal": {
				"Service": "sagemaker.amazonaws.com"
			},
			"Action": "sts:AssumeRole"
		}

    ]
}
----
. Click btn:[Create Role]
. Select your roll from the list and copy the Role ARN, you will need this in the next section.
+
image::deploy/role-arn.png[Screenshot showing location of Role ARN]


[#using-tables]
=== 2. Using tables

This is the syntax for creating a table. This example has one heading row and one normal row. The table has three columns

[.table.table-striped]
[cols=3*, options="header", stripes=even]
|===
|Header text column 1
|Header text column 2
|Header text column 3

|Text for row 1 column 1
|Text for row 1 column 2
|Text for row 1 column 3
|===

For a full description of the options available, including merging cells, and cell formatting, see the link:https://docs.asciidoctor.org/asciidoc/latest/tables/build-a-basic-table/[Asciidoctor docs].

[#links-and-cross-references]
=== 3. Links and cross references

To link out to content outside of the docs use a link:

link:https://circleci.com/[CircleCI website]

To link to another page within the docs use a cross reference:

xref:about-circleci#[About CircleCI]

Notice the `#` at the end of the filename. You can place the subsection anchor there if you want to link to a subsection:

xref:about-circleci#learn-more[About CircleCI]

[#code-examples]
=== 4. Code examples

Whenever possible, the how-to guide should provide examples that cover our users' link:https://circleci.com/blog/devops-language-trends-2023[most widely used languages and frameworks], unless the guide itself is specific to a particular language, platform, or framework.

Use AsciiDoc source blocks for code examples:

[source,yaml]
----
version: 2.1
jobs:
  build:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - run:
          name: The First Step
          command: |
            echo 'Hello World!'
            echo 'This is the delivery pipeline'
      - run:
          name: The Second Step
          command: |
            ls -al
            echo '^^^The files in your repo^^^'
----

[#banners]
=== 5. Banners

In technical writing we use _admonitions_ to create blocks of content that stand out from the main flow of text. Outside the docs team we usually refer to these as _banners_. Currently we have the option to include notes, cautions, and warnings, as follows:

NOTE: **Need to add a note?** This is how to do it

CAUTION: **Need to add a caution?** This is how to do it

WARNING: **Need to add a warning?** This is how to do it

We try to use a short section in bold at the start of the admonition to try to attract the readers attention.

For more information, see xref:/style/formatting/#using-notes-tips-cautions-warnings[the CircleCI style guide].

[#the-second-step]
== 2. The second step

Each main step in the how-to guide should be under its own level 2 (`==`) heading, using the numbered list format.

[#conclusion]
== Conclusion

End the guide with a conclusion section that summarizes what was covered.

[#next-steps]
== Next steps

// Here you can inlude links to other pages in docs or the blog etc. where the reader should head next.
* xref:benefits-of-circleci#[Benefits of CircleCI]
* xref:concepts#[CircleCI concepts]
