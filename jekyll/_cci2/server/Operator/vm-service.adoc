---
description: "CircleCI Serverâ€™s VM service controls how machine executor (Linux and Windows images) and Remote Docker jobs are run."
version:
- Server v4.x
- Server Admin
---
= CircleCI Server v4.x VM Service
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

CircleCI server's VM service controls how https://circleci.com/docs/2.0/executor-types/#using-machin[`machine`] executor (Linux and Windows images) and https://circleci.com/docs/2.0/building-docker-images[Remote Docker] jobs are run.

This section describes the available configuration options for VM service.

toc::[]

NOTE: We recommend that you leave these options at their defaults until you have successfully configured and verified the core and build services of your server installation. Steps to set up VM service are provided in the server 3.x installation guide for https://circleci.com/docs/2.0/server-3-install-build-services/#eks[AWS] and https://circleci.com/docs/2.0/server-3-install-build-services/#gke[GCP].

See the default values.yaml file for details on how to pre-scale VMs.

== VM service settings
You need to provide the hostname/IP for your VM service load balancer:

. Once your server installation is up and running, run the following command:
+
----
kubectl get svc/vm-service
----
. Enter the address listed under **External IP** in the **VM Service Load Balancer Hostname** field.

There is also an option to change the port used for VM service. The default is `3000` and this should only be changed if you are guided to do so by a CircleCI support engineer.

== VM provider
The following configuration options are for the VM provider: either AWS or GCP.

=== AWS EC2
You will need to add a section to your values.yaml file to configure your VM Service to work with AWS EC2. 

==== Authentication
One of the following options is required. Either select "IAM Keys" and provide:

* *Access Key ID* (required): https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html[Access Key ID] for EC2 access.
* *Secret Key* (required): https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html[Secret Key] for EC2 access.
NOTE: The Access Key and Secret
Key used by VM Service differs from the policy used by object storage in the previous section.

Or select "IAM role" and provide:

* *Role ARN* (required): 
https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html[Role ARN for Service Accounts] (Amazon Resource Name) for EC2 access.

```
vm_service:
  providers:
    ec2:
      enabled: true
      region: <region>
      # Subnets must be in the same availability zone
      subnets:
      - <subnet-id>
      securityGroupId: <security-group-id>

      # Authenticate with IAM access keys
      accessKey: <access-key>
      secretKey: <secret-key>
      # or IRSA (IAM roles for service accounts)
      irsaRole: <role-arn>

```

==== Default AWS AMI list

The default AMIs for server v4.x are based on Ubuntu 20.04.

----
"us-east-1" "ami-04f249339fa8afc90" 
"ca-central-1" "ami-002f61fb4f6cd4f04" 
"ap-south-1" "ami-0309e6438340ff3f5" 
"ap-southeast-2" "ami-03ac956e1d298b76a" 
"ap-southeast-1" "ami-0272b002478c96552" 
"eu-central-1" "ami-07266a91e4ef7e3e8" 
"eu-west-1" "ami-0bc8a965f9ae82e44" 
"eu-west-2" "ami-0bcbed1cffe3866c2" 
"sa-east-1" "ami-05291e231356c0387" 
"us-east-2" "ami-08735066168c5c8e9" 
"us-west-1" "ami-035e0e862838fcb21" 
"us-west-2" "ami-0b4970c467d8baaef" 
"ap-northeast-1" "ami-0b9233227f60abc2c" 
"ap-northeast-2" "ami-08e7a9df6ab2f6b9d" 
"eu-west-3" "ami-07f0d51c7621f0c39" 
"us-gov-east-1" "ami-0f68718afd37587ae" 
"us-gov-west-1" "ami-8e2106ef"
----

=== Google Cloud Platform
You will need to add a section to your values.yaml file to configure your VM Service to work with Google Cloud Platform (GCP). 

WARNING: We recommend you create a unique service account used exclusively by VM Service. The Compute Instance Admin (Beta) role is broad enough to allow VM Service to operate. If you wish to make permissions more granular, you can use the
https://cloud.google.com/compute/docs/access/iam#compute.instanceAdmin[Compute Instance Admin (beta) role] documentation as reference.

If you choose to use a *GCP Service Account JSON file*, use the contents of your https://cloud.google.com/iam/docs/service-accounts[service account JSON file] for `service-account` below

Or

If you choose to use *GCP IAM Workload Identity*, use the VM service account email address (`service-account-name`@`project-id`.iam.gserviceaccount.com ) which you have created https://circleci.com/docs/2.0/server-3-install-build-services/#gcp-3[here] in point 2 & 3 for the `workloadIdentity` field below.

```
vm_service:
  enabled: true
  replicas: 1
  providers:
    gcp:
      enabled: false
      project_id: <project-id>
      network_tags:
      - circleci-vm
      - <your-network>
      zone: <zone>
      network: <network>
      subnetwork: <subnetwork>

      service_account: <service-account-json>
      # OR
      workloadIdentity: ""  # Leave blank if using JSON keys of service account else service account email address
      
```

WARNING: If https://circleci.com/docs/2.0/docker-layer-caching/[Docker Layer Caching (DLC)] is used, VM Service instances need to be spun up on demand. For this to happen, **either** ensure any preallocated instances are in use, **or** set both remote Docker and `machine` preallocated instance fields to `0`.
+
NOTE: When using preallocated instances be aware that a cron job is scheduled to cycle through these instances once per day to ensure they do not end up in an unworkable state.