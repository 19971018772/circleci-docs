

## Setting up CircleCI Server in an air-gapped environment
This tutorial walks you through how to set up CircleCI Server in an air-gapped environment.


When setting up CircleCI Server in an airgapped environment, there are a few additional prerequisites and steps that must be taken to ensure a functioning installation.


## Prerequisites


## Air-Gapped Environment
In our example, we are using a bastion host to connect from our local development machine to the simulated air gap environment. Our first step is to SSH into the environment via the bastion. We can also copy files to it via the scp command.

```sh
ssh user@{{bastion_host_ip}}
```

---


## Install Kubernetes (K3s)
We are using a lightweight kubernetes (K3s) in our example installation.

1. First, download the binary to your developer machine:

```sh
wget https://github.com/k3s-io/k3s/releases/download/v1.24.2%2Bk3s2/k3s
```

2. Using the method that works best for your environment, copy the binary to your air-gapped environment.

3. In the air-gapped environment, move the binary to the `/usr/local/bin/` directory.

```
sudo mv k3s /var/usr/local/bin/k3s
```

4. Run restorecon and chmod on the binary, and start the service.

```
sudo chmod 0755 /var/usr/local/bin/k3s
sudo restorecon -rv /usr/local/bin/k3s
sudo systemctl start k3s
```

---

## Configuring Object Storage
For object storage, we'll be using (Min.IO)[https://min.io/] hosted in the environment.

### Installing Min.IO
Since this test environment doesn't have access to cloud based object storage (GCS, S3, etc.), CircleCI supports using an air-gap-hosted installation of Min.IO.

1. Download the latest release of Min.IO to your local machine.

```
wget https://dl.min.io/server/minio/release/linux-amd64/minio
```

2. Copy the Min.IO binary to your air-gapped environment.

3. Within your air-gapped environment, move the Min.IO binary to `/usr/local/bin/`.

```
sudo mv minio /usr/local/bin/minio
```

4. Run restorecon on the binary, and start the service.

```
sudo restorecon -rv /usr/local/bin/minio
sudo systemctl start minio
```


### Configuring Min.IO
With Min.IO installed and running in your air-gapped environment, we need to perform a few additional actions to get started.

1. Create a new bucket in min.io named `airgap-data`. This bucket will be for your values.yaml file.
2. Create a new bucket in min.io named `circle-data`.
3. In settings for the `circleci-data` bucket, change the access policy to `public`.
4. Download the (release.txt file)[https://circleci-binary-releases.s3.amazonaws.com/circleci-agent/release.txt] from CircleCI's public S3 bucket, and upload it to your `circleci-data` bucket.
5. Using the version specified in release.txt, download the checksum.txt and circleci-agent files from the CircleCI Public bucket.

```
# This example uses version 1.0.137184-db08738f, yours may differ
https://circleci-binary-releases.s3.amazonaws.com/circleci-agent/1.0.137184-db08738f/checksums.txt
https://circleci-binary-releases.s3.amazonaws.com/circleci-agent/1.0.137184-db08738f/linux/amd64/circleci-agent
```

6. Using the version specified in release.txt, create a new directory in the root of the `circle-data` bucket with that name.

```
# In this example, we are creating a directory with the following name:
1.0.137184-db08738f
```

7. Upload the downloaded checksums.txt file to the newly created directory.

```
# The structure of the directory should look like this
1.0.137184-db08738f/
  checksums.txt
```

8. Within the same directory, create two new nested subdirectories, first `linux`, and then within `linux`, `amd64`.

9. Upload the circleci-agent to the `amd64`` directory.

```
# When complete, your directory structure should look like this:
1.0.137184-db08738f/
  checksums.txt
  linux/
    amd64/
      circleci-agent
```


### Updating Values.yaml
In order to point CircleCI server to the right object storage backend, update the following values in the helm values.yaml file using the  details of your min.io installation, and the bucket created in the previous step. Update the port, hostname, protocol, and bucket name as necessary.

```yaml
distributor:
  launch_agent_base_url: "http://{your-minio-installation-internal-tld}:9000/circleci-data/"
  agent_base_url: "http://{your-minio-installation-internal-tld}:9000/circleci-data/"
```

---

## Setting Up GitHub Enterprise


---

## Deploying Nomad Clients
CircleCI Server uses Nomad clients to perform container-based build actions. These machines will need to exist within the air-gapped environment. In this example, we have two already provisioned virtual machines.

1. Download the latest nomad release to your local machine.

```
wget https://releases.hashicorp.com/nomad/1.1.2/nomad_1.1.2_linux_amd64.zip
```

2. Unzip the file, and run the `chmod` command.

```
unzip nomad_1.1.2_linux_amd64.zip
chmod +x nomad
```

3. Copy `nomad` to each of the machines designated to be Nomad Clients.

4. On each machine, move `nomad` to the `/usr/local/bin` directory and start the service.

```
sudo mv nomad /var/usrlocal/bin/nomad
sudo systemctl start nomad
```
